<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Pulse Money</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png" sizes="192x192" type="image/png">
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="theme-color" content="#0f111a" />

<style>
  :root{
    --bg:#0f111a; --card:#141725; --muted:#a7b0c3; --ink:#e9ecf5;
    --line:#262a3c; --pill:#1b1e2f; --pill2:#20243a; --danger:#ff5a71;
    --blue:#bfe3ff; --cyan:#cce9ff; --pink:#eed3ff;
    --pad:14px; --radius:16px; --tap:52px; --fs:16px;
  }
  @media (max-width:480px){
    :root{ --pad:12px; --radius:14px; --tap:56px; --fs:17px; }
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
    color:var(--ink);
    background:
      radial-gradient(900px 420px at 60% 8%, #2b2542 0%, rgba(15,17,26,0) 55%),
      radial-gradient(720px 420px at 10% 85%, #13233a 0%, rgba(15,17,26,0) 52%),
      var(--bg);
    font-size:var(--fs);
  }
  .wrap{max-width:720px;margin:0 auto;padding:var(--pad) var(--pad) calc(60px + env(safe-area-inset-bottom));}
  .topbar{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(15,17,26,.98) 0%, rgba(15,17,26,.75) 75%, rgba(15,17,26,0) 100%); padding:18px var(--pad) 8px}
  h1{margin:0;font-size:22px}
  .date{color:var(--muted);font-size:12px}

  /* ===== Mobile-friendly, swipeable tabs ===== */
  .tabs-wrap{
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 6px 8px;
    overflow: hidden;
    margin-top: 10px;
  }
  .tabs{
    display:flex; gap:8px;
    overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
    scroll-snap-type:x proximity;
    padding: 6px 2px 8px;
  }
  .tabs::-webkit-scrollbar{ display:none; }
  .tab{
    scroll-snap-align:center;
    flex:0 0 auto; min-width:110px;
    text-align:center; background:var(--pill2);
    border:1px solid var(--line); padding:10px 14px;
    border-radius:14px; color:#cdd6e5; cursor:pointer;
    min-height:var(--tap); display:flex; align-items:center; justify-content:center;
  }
  .tab.active{ background:#f1f3fb; color:#142033; font-weight:600; box-shadow:0 6px 20px rgba(0,0,0,.18); }
  @media (max-width:360px){ .tab{ min-width:96px; padding:10px 12px } h1{font-size:20px} }

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);margin:10px 0;box-shadow:0 6px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button{border-radius:12px;border:1px solid var(--line);background:#0f1220;color:var(--ink);padding:12px 14px;font-size:var(--fs);min-height:var(--tap)}
  input[type=number]{-moz-appearance:textfield} input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0;}
  button.primary{background:#f1f3fb;color:#111;border:1px solid #cfd5ea;font-weight:600}
  .list{list-style:none;padding:0;margin:0}
  .list li{display:flex;gap:8px;justify-content:space-between;align-items:center;padding:12px 6px;border-bottom:1px dashed #22263a}
  .muted{color:var(--muted)}
  .sumrow{display:flex;justify-content:space-between;padding:10px 12px;margin:4px 0;border-radius:12px;background:#0f1220;border:1px solid var(--line)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:13px;margin-right:6px}
  .pill.food{background:var(--blue); color:#142033} .pill.fuel{background:var(--cyan); color:#142033}
  .pill.presh,.pill.daryl{background:var(--pink); color:#2a103a}
  .actions{display:flex;gap:8px}
  .iconbtn{min-height:var(--tap);padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#161a2b;color:var(--ink)}
  .edit{color:#b7c4ff;border-color:#25305a} .del{color:#ff7786;border-color:#3a1b28}

  /* Splash */
  #splash{position:fixed;inset:0;background:#0d101c url('splash.png') center/cover no-repeat;display:flex;align-items:flex-end;justify-content:center;z-index:50}
  #splash .footer{width:100%;text-align:center;padding:18px 0 calc(12px + env(safe-area-inset-bottom));background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.45) 100%);color:#cfe8d6;font-weight:600}
  .fadeout{animation:fade .6s ease forwards}
  @keyframes fade{to{opacity:0;visibility:hidden}}
</style>
</head>
<body>
<!-- Splash (1.8s) -->
<div id="splash"><div class="footer">Powered by Daryl G</div></div>

<div class="wrap">
  <div class="topbar">
    <h1>Task Pulse Money</h1>
    <div class="date" id="todayLabel"></div>

    <div class="tabs-wrap">
      <div class="tabs" role="tablist" id="tabsStrip">
        <button id="tabSpend" class="tab active" onclick="switchTab('spend')" aria-selected="true">Spend</button>
        <button id="tabGroceries" class="tab" onclick="switchTab('groceries')">Groceries</button>
        <button id="tabReports" class="tab" onclick="switchTab('reports')">Reports</button>
        <button id="tabSettings" class="tab" onclick="switchTab('settings')">Settings</button>
      </div>
    </div>
  </div>

  <!-- Spend -->
  <section id="screenSpend" class="card">
    <h3 style="margin:0 0 6px">Add spending</h3>
    <div class="row">
      <input id="itemInput" placeholder="item (e.g. bread)" style="flex:1 1 160px">
      <select id="typeInput">
        <option value="food">food</option>
        <option value="fuel">fuel</option>
        <option value="clothing">clothing</option>
        <option value="medicine">medicine</option>
        <option value="electricity">electricity</option>
      </select>
      <select id="payerInput">
        <option value="presh">presh</option>
        <option value="daryl">daryl</option>
      </select>
      <input id="shopInput" placeholder="shop (optional)" style="flex:1 1 130px">
      <input id="amountInput" type="number" step="0.01" min="0" inputmode="decimal" placeholder="amount" style="width:130px">
      <button class="primary" onclick="addSpend()">Add</button>
    </div>
    <div class="muted" id="todayTotal" style="margin-top:6px"></div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">Spending (this day)</h3>
    <ul id="spendList" class="list"></ul>
    <div class="sumrow" style="margin-top:6px"><div>Total</div><div id="dayTotal">R 0.00</div></div>
  </section>

  <!-- Groceries -->
  <section id="screenGroceries" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Groceries <span class="muted" id="groCount"></span></h3>
      <div class="muted">Offline list</div>
    </div>
    <div class="row" style="margin-top:6px">
      <input id="groInput" placeholder="Add grocery item…" style="flex:1 1 220px">
      <select id="groRating">
        <option value="y">• low</option>
        <option value="o">• med</option>
        <option value="r">• high</option>
      </select>
      <button class="primary" onclick="addGro()">Add</button>
    </div>
    <ul id="groList" class="list" style="margin-top:6px"></ul>
  </section>

  <!-- Reports -->
  <section id="screenReports" style="display:none">
    <div class="card">
      <h3 style="margin:0 0 6px">7-day & 30-day reports</h3>
      <div id="report7"></div>
      <hr style="border:0;border-top:1px dashed #30364d;margin:10px 0">
      <div id="report30"></div>
    </div>
  </section>

  <!-- Settings -->
  <section id="screenSettings" class="card" style="display:none">
    <h3 style="margin:0 0 6px">Settings</h3>
    <div class="row">
      <label class="muted">Daily limit (ZAR):</label>
      <input id="limitInput" type="number" step="0.01" min="0" placeholder="e.g. 600" style="width:140px;margin-left:8px">
      <button onclick="saveLimit()">Save</button>
      <span id="limitStatus" class="muted" style="margin-left:8px"></span>
    </div>
  </section>
</div>

<script>
/* ===== Local storage + utils ===== */
const LS_KEY_SPEND='tpm_spends', LS_KEY_GRO='tpm_groceries', LS_KEY_LIMIT='tpm_daily_limit', LS_KEY_LASTTAB='tpm_last_tab';
const currency='R'; const fmt=n=>currency+' '+Number(n||0).toFixed(2);
const todayISO=()=>new Date().toISOString().slice(0,10);
const fmtDate=d=>new Date(d).toLocaleDateString(); const fmtTime=d=>new Date(d).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
function save(k,v){localStorage.setItem(k,JSON.stringify(v));} function load(k,def){try{return JSON.parse(localStorage.getItem(k))??def;}catch(e){return def;}}
let spends=load(LS_KEY_SPEND,[]), groceries=load(LS_KEY_GRO,[]), dailyLimit=load(LS_KEY_LIMIT,null);

/* Splash 1.8s */
window.addEventListener('load',()=>{
  setTimeout(()=>{ const s=document.getElementById('splash'); s.classList.add('fadeout'); setTimeout(()=>s.style.display='none',600); },1800);
  renderHeader(); setInterval(renderHeader,60000);
  switchTab(load(LS_KEY_LASTTAB,'spend'));
});
function renderHeader(){const d=new Date(); document.getElementById('todayLabel').textContent = d.toLocaleDateString()+' · '+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}

/* Ensure active tab is visible */
function ensureTabVisible(id){
  const el=document.getElementById(id);
  if(!el) return;
  el.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
}

/* Tabs */
function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('section[id^="screen"]').forEach(s=>s.style.display='none');
  const tabId='tab'+name[0].toUpperCase()+name.slice(1);
  const screenId='screen'+name[0].toUpperCase()+name.slice(1);
  document.getElementById(tabId).classList.add('active');
  document.getElementById(screenId).style.display='block';
  ensureTabVisible(tabId);
  save(LS_KEY_LASTTAB,name);
  if(name==='reports') renderReports();
  if(name==='groceries') renderGro();
  if(name==='spend') renderSpend();
}

/* Spend */
function addSpend(){
  const item=document.getElementById('itemInput').value.trim();
  const type=document.getElementById('typeInput').value;
  const payer=document.getElementById('payerInput').value;
  const shop=document.getElementById('shopInput').value.trim();
  const amount=parseFloat(document.getElementById('amountInput').value||'0');
  if(!item||!amount){alert('Enter item and amount');return;}
  const now=new Date().toISOString();
  spends.push({id:'s_'+Math.random().toString(36).slice(2,8), item,type,payer,shop,amount,date:now});
  save(LS_KEY_SPEND,spends);
  if(dailyLimit){
    const daySum = sumForDate(todayISO());
    document.getElementById('todayTotal').innerHTML = daySum>dailyLimit ? `<span style="color:#ff5a71;font-weight:700">⚠ Over limit</span> ${fmt(daySum)} / ${fmt(dailyLimit)}` : `Today: ${fmt(daySum)} / limit ${fmt(dailyLimit)}`;
  }
  clearSpendInputs(); renderSpend();
}
function clearSpendInputs(){document.getElementById('itemInput').value='';document.getElementById('shopInput').value='';document.getElementById('amountInput').value='';}

function renderSpend(){
  const ul=document.getElementById('spendList'); ul.innerHTML='';
  const today=todayISO();
  const todays=spends.filter(s=>(new Date(s.date)).toISOString().slice(0,10)===today).sort((a,b)=>new Date(b.date)-new Date(a.date));
  let total=0;
  todays.forEach(s=>{
    total+=Number(s.amount);
    const li=document.createElement('li');
    const left=document.createElement('div');
    const right=document.createElement('div'); right.textContent=fmt(s.amount);
    const pills=`<span class="pill ${s.type}">${s.type}</span><span class="pill ${s.payer}">${s.payer}</span>${s.shop?`<span class="pill">${s.shop}</span>`:''}`;
    left.innerHTML = `<div><strong>${s.item}</strong></div><div class="muted">${fmtDate(s.date)} · ${fmtTime(s.date)}</div><div style="margin-top:4px">${pills}</div>`;
    const actions=document.createElement('div'); actions.className='actions';
    const eb=document.createElement('button'); eb.className='iconbtn edit'; eb.textContent='✎'; eb.onclick=()=>editSpend(s.id);
    const db=document.createElement('button'); db.className='iconbtn del'; db.textContent='×'; db.onclick=()=>delSpend(s.id);
    actions.appendChild(eb); actions.appendChild(db);
    li.appendChild(left); li.appendChild(right); li.appendChild(actions);
    ul.appendChild(li);
  });
  document.getElementById('dayTotal').textContent=fmt(total);
  if(dailyLimit){
    document.getElementById('todayTotal').innerHTML = total>dailyLimit ? `<span style="color:#ff5a71;font-weight:700">⚠ Over limit</span> ${fmt(total)} / ${fmt(dailyLimit)}` : `Today: ${fmt(total)} / limit ${fmt(dailyLimit)}`;
  } else {
    document.getElementById('todayTotal').textContent = `Today: ${fmt(total)}`;
  }
}
function editSpend(id){
  const s=spends.find(x=>x.id===id); if(!s) return;
  const item=prompt('Edit item', s.item); if(item===null) return;
  const amount=parseFloat(prompt('Edit amount', s.amount)||s.amount);
  const shop=prompt('Edit shop (optional)', s.shop||'') ?? s.shop;
  s.item=item.trim(); s.amount=amount; s.shop=(shop||'').trim();
  save(LS_KEY_SPEND,spends); renderSpend();
}
function delSpend(id){ if(!confirm('Delete this spend?')) return; spends=spends.filter(x=>x.id!==id); save(LS_KEY_SPEND,spends); renderSpend(); }

/* Groceries */
function addGro(){
  const name=document.getElementById('groInput').value.trim();
  const rating=document.getElementById('groRating').value;
  if(!name) return;
  const now=new Date().toISOString();
  groceries.push({id:'g_'+Math.random().toString(36).slice(2,8), name, done:false, rating, date:now});
  save(LS_KEY_GRO,groceries);
  document.getElementById('groInput').value=''; renderGro();
}
function renderGro(){
  const ul=document.getElementById('groList'); ul.innerHTML='';
  document.getElementById('groCount').textContent=`${groceries.length} items`;
  groceries.forEach(g=>{
    const li=document.createElement('li');
    const left=document.createElement('div');
    const dot=g.rating==='y'?'#ffd166':g.rating==='o'?'#ff9f1c':'#ef476f';
    left.innerHTML=`<span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${dot};margin-right:6px"></span> ${g.done?'<s>'+g.name+'</s>':g.name}<div class="muted">${fmtDate(g.date)} · ${fmtTime(g.date)}</div>`;
    const actions=document.createElement('div'); actions.className='actions';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=g.done; cb.onchange=()=>{ g.done=cb.checked; save(LS_KEY_GRO,groceries); };
    const eb=document.createElement('button'); eb.className='iconbtn edit'; eb.textContent='✎'; eb.onclick=()=>{ const n=prompt('Edit item', g.name); if(n!==null){ g.name=n.trim(); save(LS_KEY_GRO,groceries); renderGro(); }};
    const mb=document.createElement('button'); mb.className='iconbtn'; mb.textContent='→'; mb.title='Move to Spend'; mb.onclick=()=>moveGroToSpend(g.id);
    const db=document.createElement('button'); db.className='iconbtn del'; db.textContent='×'; db.onclick=()=>{ groceries=groceries.filter(x=>x.id!==g.id); save(LS_KEY_GRO,groceries); renderGro(); };
    actions.appendChild(cb); actions.appendChild(eb); actions.appendChild(mb); actions.appendChild(db);
    li.appendChild(left); li.appendChild(actions); ul.appendChild(li);
  });
}
function moveGroToSpend(id){ const g=groceries.find(x=>x.id===id); if(!g) return; document.getElementById('itemInput').value=g.name; switchTab('spend'); }

/* Reports */
function sumForDate(iso){ return spends.filter(s=>(new Date(s.date)).toISOString().slice(0,10)===iso).reduce((a,b)=>a+Number(b.amount),0); }
function rangeRows(days){ const now=new Date(); const start=new Date(); start.setDate(now.getDate()-days+1); return spends.filter(s=> new Date(s.date)>=start && new Date(s.date)<=now ); }
function groupSum(rows, key){ const m={}; rows.forEach(r=>{const k=r[key]||'(none)'; m[k]=(m[k]||0)+Number(r.amount);}); return m; }
function rowsHtml(obj){ return Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<div class='sumrow'><div>${k}</div><div>${fmt(v)}</div></div>`).join('') || '<div class="muted">no data</div>'; }
function renderReports(){
  const r7=rangeRows(7), r30=rangeRows(30);
  const total7=r7.reduce((a,b)=>a+Number(b.amount),0), total30=r30.reduce((a,b)=>a+Number(b.amount),0);
  document.getElementById('report7').innerHTML =
    `<strong>Total (7 days):</strong> ${fmt(total7)}<br><br>` +
    `<strong>By type</strong>${rowsHtml(groupSum(r7,'type'))}` +
    `<strong style='display:block;margin-top:6px'>By payer</strong>${rowsHtml(groupSum(r7,'payer'))}` +
    `<strong style='display:block;margin-top:6px'>Top shop</strong>${rowsHtml(groupSum(r7,'shop'))}`;
  document.getElementById('report30').innerHTML =
    `<strong>Total (30 days):</strong> ${fmt(total30)}<br><br>` +
    `<strong>By type</strong>${rowsHtml(groupSum(r30,'type'))}` +
    `<strong style='display:block;margin-top:6px'>By payer</strong>${rowsHtml(groupSum(r30,'payer'))}` +
    `<strong style='display:block;margin-top:6px'>Top shop</strong>${rowsHtml(groupSum(r30,'shop'))}`;
}

/* PWA */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
</script>
</body>
</html>

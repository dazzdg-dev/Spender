<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Pulse Smart V8.7</title>

<link rel="preload" as="image" href="taskpulse-splash-hex.jpeg" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon-192.png" sizes="192x192" />
<meta name="theme-color" content="#0f111a" />

<style>
/* ----------------------------------------------------
   ROOT THEME
-----------------------------------------------------*/
:root{
  --bg:#050611;
  --card:#141725;
  --ink:#e9ecf5;
  --muted:#a7b0cf;
  --line:#262a3c;
  --pill:#1b2440;
  --pad:14px;
  --radius:16px;
  --tap:50px;
  --fs:16px;

  --accent:#27b7ff;
  --accent-soft:#193b66;

  --good:#76e0a6;
  --warn:#ffcc66;
  --bad:#ff8ea1;

  --med-day:#26ffc3;
  --med-night:#32d4ff;

  --med-soft-bg:#060817;
}
@media (max-width:480px){
  :root{ --pad:12px; --radius:14px; --tap:56px; --fs:17px }
}

/* RESET */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
}
html,body{height:100%;}
body{
  background:radial-gradient(circle at top,#1d2440 0,#050611 55%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:12px;
  font-size:var(--fs);
}

/* ----------------------------------------------------
   SHELL
-----------------------------------------------------*/
.shell{
  width:100%;
  max-width:900px;
  background:#050814;
  border-radius:18px;
  border:1px solid #20263c;
  padding:16px 18px 14px;
  box-shadow:0 18px 60px rgba(0,0,0,.7);
}
.wrap{
  max-width:820px;
  margin:0 auto;
  padding:4px var(--pad) calc(40px + env(safe-area-inset-bottom));
}

/* ----------------------------------------------------
   SPLASH
-----------------------------------------------------*/
#splash{
  position:fixed;
  inset:0;
  z-index:9999;
  background:radial-gradient(circle at top,#2b2220 0,#050611 60%);
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
}
#splash::before{
  content:"";
  position:absolute;
  inset:0;
  background:url("taskpulse-splash-hex.jpeg") center/cover no-repeat;
  filter:contrast(108%) saturate(115%);
  opacity:0;
  animation:zoomfade 1.8s ease forwards;
}
#splash .label{
  color:white;
  font-size:28px;
  text-align:center;
  z-index:10;
  opacity:0;
  animation:textin .9s ease forwards .2s;
}
#splash .sub{
  font-size:14px;
  opacity:.85;
  margin-top:8px;
}
#splash .foot{
  font-size:13px;
  opacity:.85;
  margin-top:16px;
}
.hide-splash #splash{display:none;}

@keyframes zoomfade{
  0%{opacity:0;transform:scale(1.08);}
  20%{opacity:1;}
  100%{opacity:0;transform:scale(1);}
}
@keyframes textin{
  from{opacity:0;transform:translateY(8px);}
  to{opacity:1;transform:translateY(0);}
}

/* ----------------------------------------------------
   HEADER
-----------------------------------------------------*/
.hero-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.brand{
  display:flex;
  gap:10px;
  align-items:center;
}
.logo-pill{
  width:42px;
  height:42px;
  border-radius:50%;
  background:radial-gradient(circle at 30% 20%,#5fffd0 0,#0fd0ff 40%,#0b1428 80%);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 0 18px rgba(0,255,213,.5);
  font-weight:700;
  color:white;
  letter-spacing:.5px;
}
.brand-title{font-size:18px;font-weight:700;}
.brand-sub{font-size:11px;color:var(--muted);}
.top-right{font-size:11px;color:var(--muted);text-align:right;}
.badge{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid #3b425d;
  display:inline-block;
  margin-bottom:4px;
}
.badge.good{border-color:#3bd47a;color:#7fffb3;}
.badge.warn{border-color:#e7a74c;color:#ffd78a;}

/* ----------------------------------------------------
   TABS
-----------------------------------------------------*/
.tabs{
  margin-bottom:10px;
  padding:4px 0 6px;
  position:sticky;
  top:0;
  background:linear-gradient(180deg,#050814 .92,#05081480 70%,transparent 100%);
  backdrop-filter:blur(4px);
  z-index:50;
}
.tabbar{
  display:flex;
  overflow-x:auto;
  gap:6px;
}
.tabbar button{
  min-width:110px;
  flex:1;
  border-radius:999px;
  padding:9px 10px;
  background:var(--pill);
  border:1px solid transparent;
  color:var(--muted);
  cursor:pointer;
  font-size:13px;
  font-weight:500;
}
.tabbar button.active{
  background:linear-gradient(135deg,#27b7ff,#4df2ff);
  color:#04101b;
  font-weight:600;
  box-shadow:0 0 16px rgba(39,183,255,.5);
}
.tabpage{display:none;}
.tabpage.active{display:block;}

</style>
</head>

<body>

<!-- SPLASH -->
<div id="splash">
  <div class="label">
    <div>Task Pulse Smart</div>
    <div class="sub">Focus âˆ™ Sync âˆ™ Achieve (V8.7)</div>
    <div class="foot">Powered by Daryl G</div>
  </div>
</div>

<div class="shell">
  <div class="wrap">

    <!-- HEADER -->
    <header class="hero-header">
      <div class="brand">
        <div class="logo-pill">TP</div>
        <div>
          <div class="brand-title">Task Pulse Smart</div>
          <div class="brand-sub">Daily focus advisor Â· V8.7</div>
        </div>
      </div>
      <div class="top-right">
        <div id="syncState" class="badge">Local-only</div>
        <div id="tpLastBackup">Last backup: none</div>
      </div>
    </header>

    <!-- TABS -->
    <div class="tabs">
      <div class="tabbar">
        <button id="btnTabTasks" class="active" onclick="showTab('tasks')">Tasks</button>
        <button id="btnTabHistory" onclick="showTab('history')">History</button>
        <button id="btnTabSettings" onclick="showTab('settings')">Settings</button>
      </div>
    </div>

<!-- END PART 1 -->

    <!-- TAB: TASKS -->
<div id="tab-tasks" class="tabpage active">

  <!-- MEDICATION CARD -->
  <section class="card meds-card" id="medsCard">

    <!-- Header -->
    <div class="meds-head">
      <div class="meds-head-title">Medication â€” Today</div>
      <div class="meds-head-tag">TLE routine</div>
    </div>

    <!-- Day/Night Buttons -->
    <div class="meds-row">
      <button id="btnMedsDay" class="meds-btn" onclick="toggleMeds('day')" title="Log/undo Day dose">
        <!-- JS will populate -->
      </button>

      <button id="btnMedsNight" class="meds-btn" onclick="toggleMeds('night')" title="Log/undo Night dose">
        <!-- JS will populate -->
      </button>
    </div>

    <!-- Countdown -->
    <div id="medsCountdown" class="meds-countdown"></div>

    <!-- Streak / Meta -->
    <div id="medsMeta" class="muted" style="margin-top:6px;font-size:13px;"></div>

    <!-- Weekly Strip -->
    <div id="medsWeekStrip" class="week-strip"></div>

  </section>

  <!-- TASK ENTRY -->
  <section class="card">
    <h3 style="margin:0 0 8px">Today's Tasks</h3>

    <div class="row" style="margin-bottom:8px">
      <input id="taskInput" type="text" placeholder="Add taskâ€¦" list="taskSuggestions" autocomplete="off" />
      <datalist id="taskSuggestions"></datalist>

      <select id="prioSelect">
        <option value="low">low</option>
        <option value="med">med</option>
        <option value="high">high</option>
      </select>

      <button class="primary" onclick="addTask()">Add</button>
    </div>

    <div class="row">
      <button class="btn-ghost" onclick="clearCompleted()">Clear completed</button>
      <button class="btn-ghost" onclick="manualCarryOver()" title="Move all incomplete tasks to tomorrow">
        Carry incomplete â†’ tomorrow
      </button>
    </div>
  </section>

  <!-- TASK LIST -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">Viewing</div>
        <div id="viewingLabel" style="font-weight:600">â€”</div>
      </div>

      <div class="nav">
        <button class="btn-ghost" onclick="shiftDay(-1)">â—€</button>
        <button class="btn-ghost" onclick="shiftDay(+1)">â–¶</button>
      </div>
    </div>

    <ul id="taskList" class="list" style="margin-top:8px"></ul>

    <div class="sum">
      <div id="doneSummary">0 / 0 tasks done (0%)</div>
      <div id="qualitySummary">Quality 0%</div>
    </div>
  </section>

  <!-- MEDS BANNER WARNING -->
  <div id="medsReminder" class="meds-banner"></div>

  <!-- CARRYOVER BANNER -->
  <div id="carryWarn"></div>

</div> <!-- end tab-tasks -->

<!-- TAB: HISTORY -->
<div id="tab-history" class="tabpage">
  <section class="card">
    <h3 style="margin:0 0 8px">History</h3>

    <div class="row" style="gap:6px;margin-bottom:6px">
      <input id="histSearch" type="text" placeholder="Search text or YYYY-MM-DDâ€¦" oninput="renderHistory()" />
      <select id="histSpan" onchange="renderHistory()">
        <option value="7">Last 7 days</option>
        <option value="14">Last 14 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="all">All</option>
      </select>
    </div>

    <div id="histList"></div>
  </section>
</div>

<!-- TAB: SETTINGS -->
<div id="tab-settings" class="tabpage">

  <!-- SYNC -->
  <section class="card">
    <h3 style="margin:0 0 8px">Sync</h3>

    <div class="row">

      <input id="syncCode"
             placeholder="Sync code"
             style="flex:1 1 260px" />

      <button class="btn-ghost" onclick="copySyncCode()">Copy</button>
      <button class="btn-ghost" onclick="newSyncCode()">New code</button>
      <button class="primary" onclick="saveSyncCode()">Save</button>

    </div>

    <div class="muted" style="font-size:12px;margin-top:6px;">
      Open this site on your second device and use the same code.  
      Sync uses Firebase Realtime Database.
    </div>
  </section>

  <!-- BACKUP -->
  <section class="card" id="backupCard">
    <h3 style="margin:0 0 8px">Backup &amp; Restore</h3>

    <div class="row" style="align-items:center">
      <button id="btnBackup" class="primary" onclick="tpDownloadBackup()">â­³ Download Backup</button>

      <input id="tpRestoreFile" type="file" accept="application/json" style="display:none" />

      <button id="btnRestore" class="btn-ghost"
              onclick="document.getElementById('tpRestoreFile').click()">
        â­± Import Backup
      </button>
    </div>

    <div id="tpBackupStatus"
         class="muted"
         style="margin-top:6px;font-size:12px;"></div>
  </section>

  <!-- MEDS SETTINGS -->
  <section class="card">
    <h3 style="margin:0 0 8px">Meds Settings</h3>

    <div class="row" style="margin-bottom:8px">
      <input id="medsTablets" placeholder="Tablets on hand" />
      <input id="medsDoses" placeholder="Doses per day" />
      <button class="primary" onclick="saveMedsSettings()">Save</button>
    </div>

    <div class="muted" style="font-size:12px;">
      Used to estimate refill timing based on your Day/Night schedule.
    </div>
  </section>
</div>

<!-- FOOTER -->
<footer style="margin-top:8px;text-align:center;font-size:11px;color:var(--muted);">
  Task Pulse Smart V8.7 Â· Powered by D Gounder
</footer>

</div> <!-- wrap -->
</div> <!-- shell -->

  <script>
/* ============================================
   CORE CONSTANTS & LOAD
============================================ */
const LS_KEY         = 'tp_days_v1';
const LS_SYNC        = 'tp_sync_code';
const LS_TAB         = 'tp_last_tab';
const LS_LAST_OPEN   = 'tp_last_open';
const LS_LAST_CARRY  = 'tp_last_carry_count';
const LS_MEDS        = 'tp_meds_v1';
const LS_MEDS_SET    = 'tp_meds_settings_v1';

const TODAY = isoToday();
let days = load(LS_KEY, {});
let meds = load(LS_MEDS, {});
let medsSettings = load(LS_MEDS_SET, { tablets: '', doses: '' });
let viewing = TODAY;

/* Dirty save fallback */
let tpDirty = false;
function baseSave(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function save(k,v){
  try { baseSave(k,v); tpDirty=false; }
  catch(e){ tpDirty=true; }
}
setInterval(()=>{
  if(tpDirty){
    try { baseSave(LS_KEY, days); tpDirty=false; }
    catch(e){}
  }
}, 3500);

window.addEventListener('beforeunload',()=>{
  try {
    baseSave(LS_KEY, days);
    baseSave(LS_MEDS, meds);
  }catch{}
});

/* ============================================
   APP INIT
============================================ */
document.addEventListener('DOMContentLoaded', () => {
  /* Restore last tab */
  const lastTab = localStorage.getItem(LS_TAB) || 'tasks';
  showTab(lastTab);

  ensureSyncCode();
  tpUpdateLastBackupLabel();
  tpRenderDatalist('');

  autoCarryForwardIfNewDay();
  renderAll();          // tasks
  renderMeds();         // meds UI
  updateMedsReminder(); // banner
  scheduleMedsReminders();
  renderHistory();

  /* Remove splash */
  setTimeout(()=> document.body.classList.add('hide-splash'), 900);
});

/* ============================================
   TABS
============================================ */
function showTab(id){
  document.querySelectorAll('.tabpage').forEach(e=>e.classList.remove('active'));
  const pg = document.getElementById('tab-'+id);
  if(pg) pg.classList.add('active');

  document.querySelectorAll('.tabbar button').forEach(e=>e.classList.remove('active'));
  const btn = document.getElementById('btnTab'+cap(id));
  if(btn) btn.classList.add('active');

  localStorage.setItem(LS_TAB, id);
  if(id==='history') renderHistory();
}

function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* ============================================
   MEDICATION DATA HELPERS
============================================ */
function medsFor(iso){
  if(!meds[iso]) meds[iso] = { day:'', night:'' };
  return meds[iso];
}

function toggleMeds(which){
  const m = medsFor(TODAY);

  if(m[which]) {
    if(!confirm("Unmark this dose as taken?")) return;
    m[which] = '';
  } else {
    m[which] = new Date().toISOString();
  }

  baseSave(LS_MEDS, meds);
  renderMeds();
  updateMedsReminder();
  scheduleMedsReminders();
}

/* ============================================
   MEDS RENDER
============================================ */
function renderMeds(){
  const m = medsFor(TODAY);

  const dayBtn   = document.getElementById('btnMedsDay');
  const nightBtn = document.getElementById('btnMedsNight');
  const meta     = document.getElementById('medsMeta');

  if(dayBtn){
    const taken = !!m.day;
    dayBtn.className = taken ? "meds-btn meds-btn-taken" : "meds-btn";
    dayBtn.innerHTML = `
      <span class="meds-btn-title">ðŸŒ… Day dose</span>
      <span class="meds-btn-sub">
        ${taken ? "Day Â· " + fmtDateTime(m.day) : "Tap to log your Day dose"}
      </span>`;
  }

  if(nightBtn){
    const taken = !!m.night;
    nightBtn.className = taken ? "meds-btn meds-btn-taken" : "meds-btn";
    nightBtn.innerHTML = `
      <span class="meds-btn-title">ðŸŒ™ Night dose</span>
      <span class="meds-btn-sub">
        ${taken ? "Night Â· " + fmtDateTime(m.night) : "Tap to log your Night dose"}
      </span>`;
  }

  /* Streak + meta */
  const streak = computeMedsStreak();
  const a = m.day   ? `Day: ${fmtDateTime(m.day)}`   : "Day: â€”";
  const b = m.night ? `Night: ${fmtDateTime(m.night)}` : "Night: â€”";

  if(meta){
    meta.innerHTML = `
      ${a} â€¢ ${b}<br>
      Streak: <b>${streak.count}</b> day(s) in a row
    `;
  }

  renderMedsWeekStrip();
  updateMedsCountdown();
}

/* ============================================
   MEDS COUNTDOWN
============================================ */
function updateMedsCountdown(){
  const el = document.getElementById('medsCountdown');
  if(!el) return;

  const m = medsFor(TODAY);
  if(!m.day) { el.textContent = ""; return; }

  const start = new Date(m.day).getTime();
  const target = start + (12*60*60*1000);

  function tick(){
    const now = Date.now();
    const diff = target - now;
    if(diff <= 0){
      el.textContent = "Next dose window active";
      return;
    }
    const h = Math.floor(diff/3600000);
    const m = Math.floor((diff%3600000)/60000);
    el.textContent = `Next dose in ${h}h ${m}m`;
    requestAnimationFrame(tick);
  }
  tick();
}

/* ============================================
   MEDS BANNER
============================================ */
function updateMedsReminder(){
  const bar = document.getElementById('medsReminder');
  if(!bar) return;

  const m = medsFor(TODAY);

  if(!m.day && !m.night){
    bar.textContent = "Morning & Night meds not taken";
    bar.style.display = "block";
  }
  else if(!m.day){
    bar.textContent = "Morning meds not taken";
    bar.style.display = "block";
  }
  else if(!m.night){
    bar.textContent = "Night meds not taken";
    bar.style.display = "block";
  }
  else {
    bar.style.display = "none";
    bar.textContent = "";
  }
}

/* Timed reminder logic (simplified but precise) */
let medsTimers = [];
function clearMedsTimers(){
  medsTimers.forEach(id=>clearTimeout(id));
  medsTimers=[];
}

function scheduleMedsReminders(){
  clearMedsTimers();
  const m = medsFor(TODAY);
  if(!m.day) return;

  const dayTime = new Date(m.day);
  const nightDue = new Date(dayTime.getTime() + 12*60*60*1000);

  const now = new Date();
  const bar = document.getElementById('medsReminder');

  if(now >= nightDue && !m.night){
    bar.textContent = "Night meds not taken";
    bar.style.display='block';
  }else{
    medsTimers.push(setTimeout(()=>{
      const mm = medsFor(TODAY);
      if(!mm.night){
        bar.textContent = "Night meds not taken";
        bar.style.display='block';
      }
    }, Math.max(0, nightDue - now)));
  }
}

/* ============================================
   MEDS STREAK
============================================ */
function computeMedsStreak(){
  let count = 0;
  let d = new Date(TODAY);

  while(true){
    const iso = d.toISOString().slice(0,10);
    const m = medsFor(iso);
    if(m.day && m.night){
      count++;
      d.setDate(d.getDate() - 1);
    }else break;
  }
  return { count };
}

/* ============================================
   WEEK STRIP
============================================ */
function renderMedsWeekStrip(){
  const el = document.getElementById('medsWeekStrip');
  if(!el) return;

  const today = new Date();
  let html = "";

  for(let i=0;i<7;i++){
    const d = new Date(today);
    d.setDate(today.getDate()-i);
    const iso = d.toISOString().slice(0,10);
    const m = medsFor(iso);

    const ok = (m.day && m.night);
    const label = d.toLocaleDateString(undefined, { weekday:'short' });

    html = `
      <div class="${ok?'week-ok':'week-miss'}">${label}</div>
    ` + html;
  }

  el.innerHTML = html;
}

/* ============================================
   TASKS
============================================ */
function addTask(){
  const name = document.getElementById('taskInput').value.trim();
  const prio = document.getElementById('prioSelect').value;
  if(!name) return;

  const t = {
    id:'t_'+Math.random().toString(36).slice(2,8),
    name, prio, done:false,
    stars:0,
    createdAt:new Date().toISOString()
  };

  ensureDay(viewing).unshift(t);
  save(LS_KEY, days);

  document.getElementById('taskInput').value='';
  renderAll();
  tpRenderDatalist('');
}

function toggleDone(dayKey,id,el){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.done = el.checked;
  t.timeCompleted = t.done ? new Date().toISOString() : '';
  save(LS_KEY, days);
  renderAll();
}

function setStars(dayKey,id,s){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.stars = s===t.stars ? 0 : s;
  save(LS_KEY, days);
  renderAll();
}

function editTask(dayKey,id){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;

  const name=prompt('Edit task',t.name);
  if(name===null) return;

  const pr=prompt('Priority (low/med/high)', t.prio);
  t.name = name.trim();
  t.prio = ['low','med','high'].includes(pr) ? pr : t.prio;

  save(LS_KEY, days);
  renderAll();
}

function delTask(dayKey,id){
  if(!confirm("Delete this task?")) return;
  days[dayKey] = ensureDay(dayKey).filter(x=>x.id!==id);
  save(LS_KEY, days);
  renderAll();
}

function clearCompleted(){
  days[viewing] = ensureDay(viewing).filter(x=>!x.done);
  save(LS_KEY, days);
  renderAll();
}

function shiftDay(n){
  const d = new Date(viewing);
  d.setDate(d.getDate()+n);
  viewing = d.toISOString().slice(0,10);
  renderAll();
}

/* ============================================
   CARRYOVER
============================================ */
function ensureDay(iso){
  if(!days[iso]) days[iso]=[];
  return days[iso];
}

function autoCarryForwardIfNewDay(){
  const last = localStorage.getItem(LS_LAST_OPEN);
  const today= isoToday();
  let carried=0;

  if(last && last !== today){
    const prev = ensureDay(last).filter(t=>!t.done);
    if(prev.length){
      ensureDay(today).unshift(
        ...prev.map(t=>({...t, id:'t_'+Math.random().toString(36).slice(2,8)}))
      );
      days[last] = ensureDay(last).filter(t=>t.done);
      carried = prev.length;
      save(LS_KEY, days);
    }
  }
  localStorage.setItem(LS_LAST_OPEN, today);
  localStorage.setItem(LS_LAST_CARRY, carried);
}

function renderAll(){
  const viewingLabel=document.getElementById('viewingLabel');
  if(viewingLabel) viewingLabel.textContent = fmtHumanDate(viewing);

  const list = ensureDay(viewing);
  const ul = document.getElementById('taskList');
  if(ul){
    ul.innerHTML='';
    list.forEach(t=>{
      const li=document.createElement('li');
      li.className='task';

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=t.done;
      cb.onchange=e=>toggleDone(viewing,t.id,e.target);

      const center=document.createElement('div');
      const prioc=t.prio==='low'?'p-low':t.prio==='med'?'p-med':'p-high';
      const meta=(t.done&&t.timeCompleted)?`<div class="meta">âœ” ${fmtDateTime(t.timeCompleted)}</div>`:'';

      center.innerHTML=`
        <div style="font-weight:600;${t.done?'opacity:.7;text-decoration:line-through':''}">
          ${escapeHtml(t.name)}
        </div>
        <div><span class="priority ${prioc}">${t.prio}</span></div>
        ${meta}
      `;

      const stars=document.createElement('div');
      stars.className='stars';
      for(let s=1;s<=3;s++){
        const b=document.createElement('button');
        b.textContent='â˜…';
        if(t.stars>=s) b.classList.add('on');
        b.onclick=()=>setStars(viewing,t.id,s);
        stars.appendChild(b);
      }

      const act=document.createElement('div');
      act.className='actions';
      const e=document.createElement('button');
      e.textContent='âœŽ';
      e.onclick=()=>editTask(viewing,t.id);
      const d=document.createElement('button');
      d.className='del';
      d.textContent='Ã—';
      d.onclick=()=>delTask(viewing,t.id);

      act.appendChild(e);
      act.appendChild(d);

      li.appendChild(cb);
      li.appendChild(center);
      li.appendChild(stars);
      li.appendChild(act);
      ul.appendChild(li);
    });
  }

  const total=list.length;
  const done=list.filter(x=>x.done).length;
  const pct=total?Math.round((done/total)*100):0;

  const qsum=list.filter(x=>x.done).reduce((a,b)=>a+(b.stars||0),0);
  const qPct=done?Math.round((qsum/(done*3))*100):0;

  const doneSummary=document.getElementById('doneSummary');
  const qualitySummary=document.getElementById('qualitySummary');

  if(doneSummary) doneSummary.textContent = `${done} / ${total} tasks done (${pct}%)`;
  if(qualitySummary) qualitySummary.textContent = `Quality ${qPct}%`;

  renderMeds();
}

/* ============================================
   HISTORY
============================================ */
function renderHistory(){
  const wrap=document.getElementById('histList');
  if(!wrap) return;

  const q=document.getElementById('histSearch').value.trim().toLowerCase();
  const spanSel=document.getElementById('histSpan').value;

  let keys = Object.keys(days);

  if(spanSel!=='all'){
    const daysSpan=parseInt(spanSel,10);
    const min=new Date();
    min.setDate(min.getDate()-daysSpan);
    keys = keys.filter(k=> new Date(k)>=min );
  }

  if(q){
    keys = keys.filter(k=>{
      if(k.includes(q)) return true;
      return (days[k]||[]).some(t=> (t.name||'').toLowerCase().includes(q));
    });
  }

  keys.sort((a,b)=> new Date(b)-new Date(a));

  if(!keys.length){
    wrap.innerHTML = '<div class="muted">No history found.</div>';
    return;
  }

  wrap.innerHTML='';

  keys.forEach(k=>{
    const arr=days[k]||[];
    const total=arr.length;
    const done=arr.filter(t=>t.done).length;
    const pct=total?Math.round(done/total*100):0;
    const qsum=arr.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
    const qPct=done?Math.round((qsum/(done*3))*100):0;

    const row=document.createElement('div');
    row.className='hist-row';

    row.innerHTML = `
      <div>
        <div style="font-weight:700">${fmtHumanDate(k)}</div>
        <div class="meta">${done}/${total} done â€¢ ${pct}% Â· Quality ${qPct}%</div>
      </div>
      <div><button class="btn-ghost" onclick="viewDay('${k}')">Open</button></div>
    `;

    wrap.appendChild(row);
  });
}

function viewDay(iso){
  viewing = iso;
  showTab('tasks');
  renderAll();
}

/* ============================================
   BACKUP / RESTORE
============================================ */
function tpDownloadBackup(){
  try{
    const dump={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(/^tp_/.test(k)) dump[k] = localStorage.getItem(k);
    }

    const payload={
      app:'taskpulse',
      version:'v8.7',
      exportedAt:new Date().toISOString(),
      dump
    };

    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='taskpulse_backup.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    localStorage.setItem('tp_last_backup', new Date().toLocaleString());
    tpUpdateLastBackupLabel();
  }catch(e){
    alert('Backup failed: '+e.message);
  }
}

function tpUpdateLastBackupLabel(){
  const el=document.getElementById('tpLastBackup');
  if(el) el.textContent = `Last backup: ${localStorage.getItem('tp_last_backup')||'none'}`;
}

document.getElementById('tpRestoreFile')?.addEventListener('change', async e=>{
  const f=e.target.files[0];
  if(!f) return;

  try{
    const text=await f.text();
    const data=JSON.parse(text);
    if(data && data.dump){
      Object.entries(data.dump).forEach(([k,v])=>{
        if(/^tp_/.test(k)) localStorage.setItem(k,v);
      });
    }
    alert("Restore complete. Reloadingâ€¦");
    location.reload();
  }catch(err){
    alert("Restore failed: "+err.message);
  }finally{
    e.target.value='';
  }
});

/* ============================================
   SYNC (FIREBASE)
============================================ */
const TP_UID = (localStorage.getItem('tp_uid') ||
  (()=>{ const v='u_'+Math.random().toString(36).slice(2,10);
         localStorage.setItem('tp_uid',v); return v; })()
);

let syncRef=null, syncOff=null, writeTimer=null;

function ensureSyncCode(){
  let code = localStorage.getItem(LS_SYNC);
  if(!code){
    code = "grp-"+randomCode(6);
    localStorage.setItem(LS_SYNC, code);
  }
  const inp=document.getElementById('syncCode');
  if(inp) inp.value=code;

  if(isFirebaseReady()) attachSync(code);
}

function randomCode(len=6){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}

function copySyncCode(){
  const i=document.getElementById('syncCode');
  if(!i || !i.value) return;
  navigator.clipboard.writeText(i.value)
    .then(()=>alert("Sync code copied"));
}

function newSyncCode(){
  if(!confirm("Generate a new sync code?")) return;

  const code="grp-"+randomCode(6);
  localStorage.setItem(LS_SYNC,code);
  const inp=document.getElementById('syncCode');
  if(inp) inp.value=code;

  if(syncOff) syncOff();
  if(isFirebaseReady()) attachSync(code);
}

function saveSyncCode(){
  const i=document.getElementById('syncCode');
  if(!i) return;
  const v=i.value.trim();
  if(!v) return;

  localStorage.setItem(LS_SYNC,v);

  if(syncOff) syncOff();
  if(isFirebaseReady()) attachSync(v);

  alert("Sync code saved.");
}

function isFirebaseReady(){
  return (window.firebase && firebase.apps && firebase.apps.length);
}

function attachSync(code){
  if(!isFirebaseReady()) return;

  if(syncOff) syncOff();

  syncRef = firebase.database().ref("taskpulse/"+code);

  syncRef.get().then(snap=>{
    const val=snap.val();
    if(val && (val.days || val.meds)){
      days = mergeDays(days, val.days||{});
      meds = mergeMeds(meds, val.meds||{});
      baseSave(LS_KEY, days);
      baseSave(LS_MEDS, meds);
      renderAll();
    } else {
      debouncedPush();
    }
  });

  const handler = syncRef.on("value", snap=>{
    const val=snap.val();
    if(!val) return;
    if(val._meta && val._meta.by===TP_UID) return;

    if(val.days){ days = mergeDays(days, val.days); baseSave(LS_KEY, days); }
    if(val.meds){ meds = mergeMeds(meds, val.meds); baseSave(LS_MEDS, meds); }
    renderAll();
  });

  syncOff = ()=> syncRef.off("value", handler);
}

function debouncedPush(){
  if(!syncRef) return;
  clearTimeout(writeTimer);
  writeTimer=setTimeout(()=>{
    syncRef.set({
      days,
      meds,
      _meta:{by:TP_UID,at:Date.now()}
    }).catch(()=>{});
  }, 250);
}

function mergeDays(local, remote){
  const out={...local};
  for(const d of Object.keys(remote)){
    const L=out[d]||[];
    const R=remote[d]||[];
    const stamp = arr=> Math.max(...arr.map(t=> new Date(t.timeCompleted||t.createdAt||0).getTime()),0);
    out[d] = (stamp(R) > stamp(L)) ? R : L;
  }
  return out;
}

function mergeMeds(local, remote){
  const out={...local};
  for(const d of Object.keys(remote)){
    const lr=out[d]||{day:'',night:''};
    const rr=remote[d]||{day:'',night:''};

    const pick=(a,b)=>{
      const ta=a?Date.parse(a):0;
      const tb=b?Date.parse(b):0;
      return tb>ta ? b : a;
    };

    out[d]={day:pick(lr.day,rr.day), night:pick(lr.night,rr.night)};
  }
  return out;
}

/* ============================================
   PREDICTIVE TEXT
============================================ */
function tpCollectTaskStats(){
  const stats=new Map();
  for(const dk of Object.keys(days)){
    for(const t of (days[dk]||[])){
      const nm=(t.name||'').trim();
      if(!nm) continue;
      const key=nm.toLowerCase();
      const last=new Date(t.createdAt||t.timeCompleted||0).getTime();
      if(!stats.has(key)) stats.set(key,{name:nm,count:0,last:0});
      const s=stats.get(key);
      s.count++; s.last = Math.max(s.last,last);
    }
  }
  return stats;
}

function tpRankedNames(stats){
  return [...stats.values()]
    .sort((a,b)=>(b.count-a.count)||(b.last-a.last))
    .map(v=>v.name);
}

function tpGetSuggestions(prefix){
  const ranked = tpRankedNames(tpCollectTaskStats());
  const p = prefix.trim().toLowerCase();
  if(!p) return ranked.slice(0,10);

  const pref = ranked.filter(n=> n.toLowerCase().startsWith(p));
  const rest = ranked.filter(n=> !n.toLowerCase().startsWith(p) && n.toLowerCase().includes(p));

  return [...pref, ...rest].slice(0,10);
}

function tpRenderDatalist(prefix){
  const dl=document.getElementById('taskSuggestions');
  if(!dl) return;
  const opts=tpGetSuggestions(prefix);
  dl.innerHTML = opts.map(n=>`<option value="${escapeHtml(n)}"></option>`).join('');
}

/* ============================================
   MEDS SETTINGS
============================================ */
function saveMedsSettings(){
  const t=document.getElementById('medsTablets').value.trim();
  const d=document.getElementById('medsDoses').value.trim();

  medsSettings={ tablets:t, doses:d };
  save(LS_MEDS_SET, medsSettings);

  alert("Meds settings saved.");
}

/* ============================================
   UTILS
============================================ */
function isoToday(){ return new Date().toISOString().slice(0,10); }
function fmtHumanDate(iso){ const d=new Date(iso); return d.toLocaleDateString(); }

function fmtDateTime(iso){
  try{
    const d=new Date(iso);
    return d.toLocaleDateString() + " Â· " + d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
  }catch{ return ''; }
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
}

/* ============================================
   SERVICE WORKER
============================================ */
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>


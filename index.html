<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Pulse Smart V.10.4</title>

<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon-192.png" sizes="192x192" />
<meta name="theme-color" content="#050611" />

<style>
  :root{
    --bg:#050611;
    --card:#141725;
    --ink:#e9ecf5;
    --muted:#a7b0cf;
    --line:#262a3c;
    --pill:#111524;
    --pad:14px;
    --radius:16px;
    --tap:46px;
    --fs:16px;
    --accent:#27b7ff;
    --accent-soft:#193b66;
    --good:#70e6af;
    --warn:#ffcc66;
    --bad:#ff8ea1;
  }
  @media (max-width:480px){
    :root{ --pad:12px; --radius:14px; --tap:52px; --fs:17px }
  }
  *{
    box-sizing:border-box;
    -webkit-tap-highlight-color:transparent;
    margin:0;
    padding:0;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);
    font-size:var(--fs);
    background:radial-gradient(circle at top,#182445 0,#050611 60%);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:10px;
  }

  .shell{
    max-width:900px;
    width:100%;
    background:#050814;
    border-radius:18px;
    box-shadow:0 18px 60px rgba(0,0,0,.75);
    padding:16px 18px 14px;
    border:1px solid #20263c;
  }
  .wrap{
    max-width:820px;
    margin:0 auto;
    padding:4px var(--pad) calc(42px + env(safe-area-inset-bottom));
  }

  .hero-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo-pill{
    width:40px;
    height:40px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 15%,#ffe27a 0,#ff8b3d 40%,#1b1020 80%);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:800;
    letter-spacing:.03em;
    box-shadow:0 0 18px rgba(255,160,60,.55);
  }
  .brand-title{font-size:18px;font-weight:700;}
  .brand-sub{font-size:11px;color:var(--muted);}
  .top-right{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:4px;
    font-size:11px;
    color:var(--muted);
  }
  .badge{
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #3b425d;
    background:var(--pill);
    font-size:11px;
  }
  .badge.good{border-color:#32d284;color:#88ffc2;}
  .badge.warn{border-color:#e7a74c;color:#ffd78a;}

  .kpi-pill{
    margin:4px 0 10px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    color:var(--muted);
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:rgba(8,12,24,.9);
  }

  .tabs{
    position:sticky;
    top:0;
    z-index:40;
    padding:4px 0 4px;
    margin-bottom:6px;
    background:linear-gradient(180deg,rgba(5,8,20,.98) 0,rgba(5,8,20,.88) 66%,rgba(5,8,20,0) 100%);
    backdrop-filter:saturate(130%) blur(4px);
  }
  .tabbar{
    display:flex;
    gap:6px;
    overflow-x:auto;
    padding-bottom:4px;
  }
  .tabbar button{
    flex:1;
    min-width:110px;
    padding:7px 10px;
    font-size:13px;
    border-radius:999px;
    border:1px solid transparent;
    background:var(--pill);
    color:var(--muted);
    cursor:pointer;
    font-weight:500;
    white-space:nowrap;
  }
  .tabbar button.active{
    background:linear-gradient(135deg,#27b7ff,#4df2ff);
    color:#04101b;
    font-weight:600;
    box-shadow:0 0 16px rgba(39,183,255,.65);
  }
  .tabpage{display:none;}
  .tabpage.active{display:block;}

  .card{
    background:var(--);
    border-radius:var(--radius);
    border:1px solid var(--line);
    padding:10px 10px 8px;
    margin:8px 0;
    box-shadow:0 6px 28px rgba(0,0,0,.28);
  }

  .row{
    display:flex;
    gap:6px;
    align-items:center;
    flex-wrap:wrap;
  }
  input,select,button{
    border-radius:999px;
    border:1px solid var(--line);
    background:#050814;
    color:var(--ink);
    padding:7px 11px;
    min-height:var(--tap);
    font-size:13px;
  }
  input[type=text]{flex:1 1 200px;min-width:0;}
  button.primary{
    background:linear-gradient(135deg,#27b7ff,#4df2ff);
    color:#04121e;
    border:none;
    font-weight:600;
    cursor:pointer;
  }
  button{cursor:pointer;}
  .btn-ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted);
  }
  .btn-danger{
    background:rgba(224,82,100,.12);
    border:1px solid #e05264;
    color:#ff9da8;
  }
  .muted{color:var(--muted);}
  .list{list-style:none;margin:0;padding:0;}

  .task{
    display:grid;
    grid-template-columns:auto 1fr auto auto;
    gap:8px;
    align-items:center;
    padding:7px 8px;
    margin-bottom:4px;
    border-radius:10px;
    background:#101528;
    border:1px solid #1f2637;
  }
  .task input[type="checkbox"]{width:16px;height:16px;}
  .task div:first-of-type{
    min-height:40px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .priority{
    display:inline-block;
    border-radius:999px;
    padding:1px 6px;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.04em;
    margin-top:4px;
  }
  .p-low{background:#16352b;color:#7af3b1;}
  .p-med{background:#3a321b;color:#ffe08a;}
  .p-high{background:#3d1b25;color:#ff9ab2;}

  .stars{
    display:flex;
    gap:2px;
    justify-content:center;
  }
  .stars button{
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:17px;
    opacity:.35;
    line-height:1;
  }
  .stars button.on{
    opacity:1;
    text-shadow:0 0 10px rgba(255,218,120,.75);
  }

  .actions{display:flex;gap:4px;}
  .actions button{
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:15px;
    padding:0 2px;
    color:#a0abd9;
  }
  .actions .del{color:#ff9ba9;}

  .task .meta{
    margin-top:4px;
    font-size:12px;
    color:#9fb0d0;
    opacity:.9;
  }

  .sum{
    display:flex;
    justify-content:space-between;
    padding:7px 10px;
    background:#0e1324;
    border-radius:12px;
    border:1px solid var(--line);
    font-size:12px;
    margin-top:6px;
  }
  .nav{display:flex;gap:4px;justify-content:flex-end;}

  .hist-row{
    border-radius:12px;
    border:1px solid var(--line);
    padding:10px 12px;
    margin:6px 0;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#101528;
  }
  .hist-row .meta{color:#9fb0d0;font-size:12px;margin-top:4px;}
  .hist-row button{border-radius:999px;padding:6px 10px;}

  #carryWarn{
    display:none;
    margin:6px 0 0;
    padding:6px 9px;
    border-radius:9px;
    background:#221525;
    border:1px solid #b26ad5;
    font-size:11px;
    color:#f0d5ff;
  }

  #medsBanner{
    display:none;
    margin:8px 0 0;
    padding:9px 11px;
    border-radius:12px;
    border:1px solid #ffb44d;
    background:#241a05;
    color:#ffe1a2;
    font-size:12px;
  }

  .meds-{padding:10px 10px 10px;}
  .meds-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
  }
  .meds-head-title{font-size:14px;font-weight:600;}
  .meds-head-tag{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    background:#101828;
    color:#9fd2ff;
    border:1px solid #294064;
  }

  .meds-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:8px;
  }
  .meds-btn{
    flex:1 1 160px;
    min-width:0;
    border-radius:18px;
    padding:10px 14px;
    background:radial-gradient(circle at 0 0,#10c8ff20 0,#050814 60%);
    border:1px solid #233049;
    text-align:left;
    display:flex;
    flex-direction:column;
    gap:3px;
    color:#e7f0ff;
    transition:box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .15s ease;
  }
  .meds-btn:hover{transform:translateY(-1px);}
  .meds-btn-title{
    font-size:13px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .meds-btn-sub{
    font-size:11px;
    color:#a7b8d9;
  }

  .meds-btn.taken{
    background:radial-gradient(circle at 15% 0,#22ffb180 0,#036455 45%,#020d13 90%);
    border-color:#3cf7bd;
    box-shadow:0 0 18px rgba(60,247,189,.6);
  }

  .meds-timer{
    margin-top:4px;
    padding:8px 12px;
    border-radius:14px;
    background:linear-gradient(135deg,#4350e6,#6f7bfd);
    color:#f9fbff;
    font-size:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .meds-timer-label{
    text-transform:uppercase;
    letter-spacing:.12em;
    font-size:10px;
    opacity:.9;
  }
  .meds-timer-value{
    font-size:18px;
    font-weight:700;
  }

  .meds-meta{
    margin-top:6px;
    font-size:11px;
    color:#aeb9e5;
  }

  .focus-toggle{
    margin-top:6px;
    font-size:12px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:6px;
  }
  .focus-toggle input{width:15px;height:15px;}

  @media (max-width:600px){
    .shell{padding:14px 10px 12px;}
    .hero-header{flex-direction:column;align-items:flex-start;gap:8px;}
    .top-right{align-items:flex-start;}
    .task{grid-template-columns:auto 1fr auto;}
    .task .actions{grid-column:1/-1;justify-content:flex-end;}
    .meds-timer{flex-direction:column;align-items:flex-start;gap:3px;}
  }

  #splash{
    position:fixed;
    inset:0;
    z-index:9999;
    background:radial-gradient(circle at top,#2b2220 0,#050611 60%);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  #splashInner{
    text-align:center;
    color:#fff;
    text-shadow:0 6px 26px rgba(0,0,0,.55);
    animation:textin .6s ease both .15s;
  }
  #splashInner h2{margin:0 0 6px;font-size:28px;letter-spacing:.5px;}
  #splashInner .sub{opacity:.88;font-size:12px;}
  #splashInner .foot{margin-top:10px;font-size:12px;opacity:.9;}
  #splash::before{
    content:"";
    position:absolute;
    inset:-8%;
    background:radial-gradient(circle at 10% 0,#ffcc8840 0,transparent 45%),
               radial-gradient(circle at 90% 0,#5fd9ff40 0,transparent 45%),
               radial-gradient(circle at 50% 100%,#3c4cff40 0,transparent 55%);
    opacity:0;
    animation:glowfade 1.9s ease forwards;
  }
  .hide-splash #splash{display:none;}

  @keyframes glowfade{
    0%{opacity:0;transform:scale(1.02);}
    15%{opacity:1;}
    100%{opacity:0;transform:scale(1);}
  }
  @keyframes textin{
    from{opacity:0;transform:translateY(6px);}
    to{opacity:1;transform:translateY(0);}
  }
</style>
</head>
<body>

<div id="splash">
  <div id="splashInner">
    <h2>Task Pulse Smart</h2>
    <div class="sub">Focus Â· Sync Â· Achieve (V.10.4)</div>
    <div class="foot">Powered by Daryl G</div>
  </div>
</div>

<div class="shell">
  <div class="wrap">
    <header class="hero-header">
      <div class="brand">
        <div class="logo-pill">TP</div>
        <div>
          <div class="brand-title">Task Pulse Smart</div>
          <div class="brand-sub">Daily focus advisor Â· V.10.4</div>
        </div>
      </div>
      <div class="top-right">
        <div id="syncState" class="badge">Local-only</div>
        <div id="tpLastBackup">Last backup: none</div>
      </div>
    </header>

    <div class="kpi-pill" id="kpiRow">
      <span>0 / 0 done (0%) Â· Quality 0%</span>
      <span id="todayLabel" class="muted">â€”</span>
    </div>

    <div id="carryWarn"></div>
    <div id="medsBanner"></div>

    <div class="tabs">
      <div class="tabbar">
        <button id="btnTabTasks" class="active" onclick="showTab('tasks')">Tasks</button>
        <button id="btnTabHistory" onclick="showTab('history')">History</button>
        <button id="btnTabSettings" onclick="showTab('settings')">Settings</button>
      </div>
    </div>

    <!-- TASKS TAB -->
    <div id="tab-tasks" class="tabpage active">
      <section class="card meds-card" id="medsCard">
        <div class="meds-head">
          <div class="meds-head-title">Medication â€” Today</div>
          <div class="meds-head-tag">TLE routine</div>
        </div>
        <div class="meds-row">
          <button id="btnMorn" class="meds-btn" onclick="toggleMeds('morning')">
            <span class="meds-btn-title">ðŸŒ… Morning Dose</span>
            <span class="meds-btn-sub">Tap to log</span>
          </button>
          <button id="btnNight" class="meds-btn" onclick="toggleMeds('night')">
            <span class="meds-btn-title">ðŸŒ™ Night Dose</span>
            <span class="meds-btn-sub">Tap to log</span>
          </button>
        </div>
        <div id="medsTimer" class="meds-timer" style="display:none;">
          <div class="meds-timer-label">Next dose</div>
          <div id="medsTimerValue" class="meds-timer-value">â€”</div>
        </div>
        <div id="medsMeta" class="meds-meta"></div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px;">Today's Tasks</h3>
        <div class="row" style="margin-bottom:8px;">
          <input id="taskInput" type="text" placeholder="Add taskâ€¦" list="taskSuggestions" autocomplete="off" oninput="tpRenderDatalist(this.value)" />
          <datalist id="taskSuggestions"></datalist>
          <select id="prioSelect">
            <option value="low">low</option>
            <option value="med">med</option>
            <option value="high">high</option>
          </select>
          <button class="primary" onclick="addTask()">Add</button>
        </div>
        <div class="row">
          <button class="btn-ghost" onclick="clearCompleted()">Clear completed</button>
          <button class="btn-ghost" onclick="manualCarryOver()">Carry incomplete â†’ tomorrow</button>
        </div>
        <label class="focus-toggle">
          <input id="focusToggle" type="checkbox" onchange="toggleFocusLane(this.checked)">
          <span>Focus lane (only high priority / starred / carried)</span>
        </label>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="muted">Viewing</div>
            <div id="viewingLabel" style="font-weight:600;">â€”</div>
          </div>
          <div class="nav">
            <button class="btn-ghost" onclick="shiftDay(-1)">â—€</button>
            <button class="btn-ghost" onclick="shiftDay(+1)">â–¶</button>
          </div>
        </div>
        <ul id="taskList" class="list" style="margin-top:8px;"></ul>
        <div class="sum">
          <div id="doneSummary">0 / 0 tasks done (0%)</div>
          <div id="qualitySummary">Quality 0%</div>
        </div>
      </section>
    </div>





    
    <!-- HISTORY TAB -->
    <div id="tab-history" class="tabpage">
      <section class="card">
        <h3 style="margin:0 0 8px;">History</h3>
        <div class="row" style="gap:6px;margin-bottom:6px;">
          <input id="histSearch" type="text" placeholder="Search text or YYYY-MM-DDâ€¦" oninput="renderHistory()" />
          <select id="histSpan" onchange="renderHistory()">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="all">All</option>
          </select>
        </div>
        <div id="histList"></div>
      </section>
    </div>

    <!-- SETTINGS TAB -->
    <div id="tab-settings" class="tabpage">
      <section class="card">
        <h3 style="margin:0 0 8px;">Sync</h3>
        <div class="row" style="margin-bottom:8px;">
          <input id="syncCode" placeholder="Sync code" style="flex:1 1 260px;" />
          <button class="btn-ghost" onclick="copySyncCode()">Copy</button>
          <button class="btn-ghost" onclick="newSyncCode()">New code</button>
          <button class="primary" onclick="saveSyncCode()">Save</button>
        </div>
        <div class="muted" style="font-size:12px;">
          Open this site on your second device and use the same code. Sync uses Firebase Realtime Database.
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px;">Backup &amp; Restore</h3>
        <div class="row">
          <button id="btnBackup" class="primary" onclick="tpDownloadBackup()">â­³ Download Backup</button>
          <input id="tpRestoreFile" type="file" accept="application/json" style="display:none;" />
          <button id="btnRestore" class="btn-ghost" onclick="document.getElementById('tpRestoreFile').click()">â­± Import Backup</button>
        </div>
        <div id="tpBackupStatus" class="muted" style="margin-top:6px;font-size:12px;"></div>
      </section>
    </div>
  </div>

  <footer style="margin-top:4px;text-align:center;font-size:11px;color:var(--muted);">
    Task Pulse Smart V.10.4 Â· Powered by D Gounder
  </footer>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
/* ---------- Firebase config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDXbxWT9viGCGDpPxlzp45QaBr3zUUn2UU",
  authDomain: "taskpulse-9a6ab.firebaseapp.com",
  databaseURL: "https://taskpulse-9a6ab-default-rtdb.firebaseio.com",
  projectId: "taskpulse-9a6ab",
  storageBucket: "taskpulse-9a6ab.firebasestorage.app",
  messagingSenderId: "92117591983",
  appId: "1:92117591983:web:dd1d73226dbb112c58f15a",
  measurementId: "G-SN3T2B2RMY"
};

(function initFirebase(){
  if(typeof firebase==="undefined"){
    console.log("[Sync] Firebase global missing (SDK script not loaded)");
    return;
  }
  if(!firebase.apps.length){
    firebase.initializeApp(firebaseConfig);
    console.log("[Sync] Firebase initialised");
  }else{
    console.log("[Sync] Firebase already initialised");
  }
})();

function isFirebaseReady(){
  return (
    typeof firebase!=="undefined" &&
    Array.isArray(firebase.apps) &&
    firebase.apps.length>0
  );
}

console.log(
  "[Sync] Firebase ready?",
  isFirebaseReady(),
  typeof firebase!=="undefined" && firebase.apps ? firebase.apps.length : 0
);

function inferPriority(taskName) {
  const map = load('tp_priority_map', {});
  const words = taskName.toLowerCase().split(/\W+/);
  for (const w of words) {
    if (map[w]) return map[w];
  }
  return null;
}



  
/* ---------Mood Monitor------ */

tp_mood_log = {
  "2025-03-10": {
    mood: 2, // 0â€“4 scale
    note: "Low energy, headache"
  }
}


  
/* ---------- Core constants & helpers ---------- */
const LS_KEY  = "tp_days_v1";
const LS_SYNC = "tp_sync_code";
const LS_TAB  = "tp_last_tab";
const LS_LAST_OPEN        = "tp_last_open";
const LS_LAST_CARRY_COUNT = "tp_last_carry_count";
const LS_MEDS             = "tp_meds_v1";
const LS_FOCUS            = "tp_focus_lane_v1";

function pad(n){ n=Math.floor(n); return n<10?"0"+n:String(n); }

function load(key, def){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return def;
    const parsed = JSON.parse(raw);
    return parsed==null ? def : parsed;
  }catch(e){
    console.warn("[TaskPulse] load failed", key, e);
    return def;
  }
}
function isoToday(){ return new Date().toISOString().slice(0,10); }
function isoOffset(iso, days){
  const d=new Date(iso);
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}

let days = load(LS_KEY, {});
let meds = load(LS_MEDS, {});
let viewing = isoToday();
const TODAY = isoToday();
let focusLane = load(LS_FOCUS, false);

function ensureDay(iso){
  if(!days[iso]) days[iso]=[];
  return days[iso];
}
function medsFor(iso){
  if(!meds[iso]) meds[iso]={morning:"",night:""};
  return meds[iso];
}

function fmtHumanDate(iso){
  const d=new Date(iso);
  return d.toLocaleDateString(undefined,{day:"2-digit",month:"2-digit",year:"numeric"});
}
function fmtDateTime(iso){
  try{
    const d=new Date(iso);
    const date=d.toLocaleDateString(undefined,{day:"2-digit",month:"2-digit",year:"numeric"});
    const time=d.toLocaleTimeString(undefined,{hour:"numeric",minute:"2-digit"});
    return `${date} Â· ${time}`;
  }catch(e){ return ""; }
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

/* Auto-save safety net */
let tpDirty=false;
function baseSave(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

let save=function(k,v){
  try{ baseSave(k,v); tpDirty=false; }
  catch(e){ console.warn("save failed, will retry",e); tpDirty=true; }
};

setInterval(()=>{
  if(!tpDirty) return;
  try{
    baseSave(LS_KEY,days);
    baseSave(LS_MEDS,meds);
    tpDirty=false;
  }catch(e){}
},4000);

window.addEventListener("beforeunload",()=>{
  try{
    baseSave(LS_KEY,days);
    baseSave(LS_MEDS,meds);
  }catch(e){}
});

/* ---------- Splash ---------- */
window.addEventListener("load",()=>{
  setTimeout(()=>document.body.classList.add("hide-splash"),1700);
});

/* ---------- Auto carry ---------- */
function autoCarryForwardIfNewDay(){
  const lastOpen = load(LS_LAST_OPEN,"");
  const today    = isoToday();
  let carried=0;

  if(lastOpen && lastOpen!==today){
    const prevIncomplete = (ensureDay(lastOpen)||[]).filter(t=>!t.done);
    if(prevIncomplete.length){
      const dest = ensureDay(today);
      const nowIso=new Date().toISOString();
      dest.unshift(...prevIncomplete.map(t=>({
        ...t,
        id:"t_"+Math.random().toString(36).slice(2,8),
        createdAt:nowIso,
        fromCarry:true
      })));
      days[lastOpen]=ensureDay(lastOpen).filter(t=>t.done);
      carried=prevIncomplete.length;
      save(LS_KEY,days);
    }
  }
  save(LS_LAST_OPEN,today);
  localStorage.setItem(LS_LAST_CARRY_COUNT,String(carried));
}
function showCarryBannerIfAny(){
  const cnt=parseInt(localStorage.getItem(LS_LAST_CARRY_COUNT)||"0",10);
  const bar=document.getElementById("carryWarn");
  if(!bar) return;
  if(cnt>0){
    bar.style.display="block";
    bar.textContent=`âš ï¸ ${cnt} incomplete task(s) were automatically carried over to today.`;
  }else{
    bar.style.display="none";
  }
}

/* ---------- Meds logic ---------- */
let medsTimerInterval=null;

function toggleMeds(which){
  const todayIso=isoToday();
  const m=medsFor(todayIso);
  if(m[which]){
    if(!confirm("Unmark this dose as taken?")) return;
    m[which]="";
  }else{
    m[which]=new Date().toISOString();
  }
  save(LS_MEDS,meds);
  renderMeds();
  notifyLocalChanged();
}

function computeMedsStreak(){
  const keys=Object.keys(meds||{}).sort();
  let best=0,current=0,lastIso=null;
  for(const iso of keys){
    const d=medsFor(iso);
    const full=!!(d.morning && d.night);
    if(!full){ current=0; lastIso=null; continue; }
    if(!lastIso) current=1;
    else{
      const expected=isoOffset(lastIso,1);
      current = expected===iso ? current+1 : 1;
    }
    lastIso=iso;
    if(current>best) best=current;
  }

  const todayFull = (()=>{
    const d=medsFor(isoToday());
    return !!(d.morning && d.night);
  })();
  if(!todayFull){
    const yesterday=isoOffset(isoToday(),-1);
    const keys2=keys.filter(k=>k<=yesterday);
    let cur=0,best2=0,last=null;
    for(const iso of keys2){
      const d=medsFor(iso);
      const full=!!(d.morning && d.night);
      if(!full){cur=0;last=null;continue;}
      if(!last) cur=1;
      else{
        const exp=isoOffset(last,1);
        cur = exp===iso ? cur+1 : 1;
      }
      last=iso;
      if(cur>best2) best2=cur;
    }
    return {current:cur,best:Math.max(best,best2)};
  }
  return {current,best};
}

function computeNextDoseTarget(){
  const todayIso=isoToday();
  const mToday=medsFor(todayIso);

  if(mToday.morning && !mToday.night){
    const morn=new Date(mToday.morning);
    return new Date(morn.getTime()+12*60*60*1000); // same-day night
  }
  if(mToday.morning && mToday.night){
    const morn=new Date(mToday.morning);
    return new Date(morn.getTime()+24*60*60*1000); // next morning
  }
  if(!mToday.morning){
    const y=isoOffset(todayIso,-1);
    const mY=meds[y];
    if(mY && mY.morning){
      const prev=new Date(mY.morning);
      return new Date(prev.getTime()+24*60*60*1000); // today morning estimate
    }
  }
  return null;
}

  /*-------Meds â€“ lightweight notes-------*/
tp_meds_notes = {
  "2025-03-10": "nausea"
}


  
function startMedsTimer(){
  const box=document.getElementById("medsTimer");
  const valueEl=document.getElementById("medsTimerValue");
  if(!box || !valueEl) return;

  if(medsTimerInterval) clearInterval(medsTimerInterval);

  function tick(){
    const target=computeNextDoseTarget();
    if(!target){
      box.style.display="none";
      valueEl.textContent="â€”";
      return;
    }
    const now=new Date();
    let diff=target-now;
    if(diff<0) diff=0;
    const secTotal=Math.floor(diff/1000);
    const h=Math.floor(secTotal/3600);
    const m=Math.floor((secTotal%3600)/60);
    const s=secTotal%60;
    valueEl.textContent=`${pad(h)}h ${pad(m)}m ${pad(s)}s`;
    box.style.display="flex";
  }
  tick();
  medsTimerInterval=setInterval(tick,1000);
}

function renderMeds(){
  const todayIso=isoToday();
  const m=medsFor(todayIso);
  const btnM=document.getElementById("btnMorn");
  const btnN=document.getElementById("btnNight");
  const banner=document.getElementById("medsBanner");
  const meta=document.getElementById("medsMeta");

  if(btnM){
    const taken=!!m.morning;
    btnM.classList.toggle("taken",taken);
    btnM.querySelector(".meds-btn-sub").textContent =
      taken ? `Logged Â· ${fmtDateTime(m.morning)}` : "Tap to log";
  }
  if(btnN){
    const taken=!!m.night;
    btnN.classList.toggle("taken",taken);
    btnN.querySelector(".meds-btn-sub").textContent =
      taken ? `Logged Â· ${fmtDateTime(m.night)}` : "Tap to log";
  }

  const missing=[];
  if(!m.morning) missing.push("Morning meds not taken");
  if(!m.night)   missing.push("Night meds not taken");
  if(missing.length){
    banner.style.display="block";
    banner.textContent=missing.join(" â€¢ ");
  }else{
    banner.style.display="none";
    banner.textContent="";
  }

  const {current,best}=computeMedsStreak();
  if(meta) meta.textContent=`Adherence streak: ${current} full day(s) Â· Best: ${best}`;

  startMedsTimer();
}

/*---------meds_inventory---------------*/
  
tp_meds_inventory = {
  "2025-03-10T09:14": [
{ med: "Epilim 500"},
{ med: "Epilim 500"},
{ med: "Epilim 200"}
{ med: "Lamictin 200"},
{ med: "Vimcosa 100"},
{ med: "Cilift 20"},
{ med: "Tegretol 200"},
  ]
}


  
/* ---------- Tasks ---------- */
function addTask(){
  const input=document.getElementById("taskInput");
  const name=input.value.trim();
  if(!name) return;
  const prio=document.getElementById("prioSelect").value;
  const t={
    id:"t_"+Math.random().toString(36).slice(2,8),
    name, prio,
    done:false,
    stars:0,
    createdAt:new Date().toISOString()
  };
  ensureDay(viewing).unshift(t);
  save(LS_KEY,days);
  input.value="";
  renderAll();
  tpRenderDatalist("");
  notifyLocalChanged();
}
function toggleDone(dayKey,id,checked){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.done=checked;
  t.timeCompleted=checked?new Date().toISOString():"";
  save(LS_KEY,days);
  renderAll();
  notifyLocalChanged();
}
function setStars(dayKey,id,s){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.stars=(s===t.stars?0:s);
  save(LS_KEY,days);
  renderAll();
  notifyLocalChanged();
}
function editTask(dayKey,id){
  const t=ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  const name=prompt("Edit task",t.name);
  if(name===null) return;
  const prio=prompt("Priority (low/med/high)",t.prio)||t.prio;
  t.name=name.trim();
  if(["low","med","high"].includes(prio)) t.prio=prio;
  save(LS_KEY,days);
  renderAll();
  notifyLocalChanged();
}
function delTask(dayKey,id){
  if(!confirm("Delete task?")) return;
  days[dayKey]=ensureDay(dayKey).filter(t=>t.id!==id);
  save(LS_KEY,days);
  renderAll();
  notifyLocalChanged();
}
function clearCompleted(){
  days[viewing]=ensureDay(viewing).filter(t=>!t.done);
  save(LS_KEY,days);
  renderAll();
  notifyLocalChanged();
}
function shiftDay(delta){
  const d=new Date(viewing+"T00:00:00");
  d.setDate(d.getDate()+delta);
  viewing=d.toISOString().slice(0,10);
  renderAll();
}

/*--------Priority Auto-Selection------*/
  
  tp_priority_map = {
  cook: "high",
  wash_dishes: "high",
  bins: "med",
  Take_out_bin: "high",
  Collect_bin: "high",
  laundry: "med",
  meds: "high",
  tidy: "high"
}




  
/* Carry */
function manualCarryOver(){
  const list=ensureDay(viewing);
  const inc=list.filter(t=>!t.done);
  if(!inc.length){ alert("No incomplete tasks to carry."); return; }
  const destIso=isoOffset(viewing,1);
  const dest=ensureDay(destIso);
  const nowIso=new Date().toISOString();
  dest.unshift(...inc.map(t=>({
    ...t,
    id:"t_"+Math.random().toString(36).slice(2,8),
    createdAt:nowIso,
    fromCarry:true,
    done:false,
    timeCompleted:""
  })));
  days[viewing]=list.filter(t=>t.done);
  save(LS_KEY,days);
  renderAll();
  notifyLocalChanged();
  alert(`Carried ${inc.length} task(s) to ${fmtHumanDate(destIso)}.`);
}

/* Focus lane */
function toggleFocusLane(enabled){
  focusLane=!!enabled;
  save(LS_FOCUS,focusLane);
  renderAll();
}

/* ---------- Predictive suggestions ---------- */
const SUGGEST_MAX=10;
function tpCollectTaskStats(){
  const stats=new Map();
  for(const dk of Object.keys(days||{})){
    for(const t of (days[dk]||[])){
      const nm=(t.name||"").trim();
      if(!nm) continue;
      const key=nm.toLowerCase();
      const last=new Date(t.createdAt||t.timeCompleted||new Date()).getTime();
      if(!stats.has(key)) stats.set(key,{name:nm,count:0,last:0});
      const s=stats.get(key);
      s.count++;
      s.last=Math.max(s.last,last);
    }
  }
  return stats;
}
function tpRankedNames(stats){
  return Array.from(stats.values())
    .sort((a,b)=>(b.count-a.count)||(b.last-a.last))
    .map(v=>v.name);
}
function tpGetSuggestions(prefix){
  const ranked=tpRankedNames(tpCollectTaskStats());
  const p=(prefix||"").trim().toLowerCase();
  if(!p) return ranked.slice(0,SUGGEST_MAX);
  const pref=ranked.filter(n=>n.toLowerCase().startsWith(p));
  if(pref.length>=SUGGEST_MAX) return pref.slice(0,SUGGEST_MAX);
  const rest=ranked.filter(n=>!n.toLowerCase().startsWith(p)&&n.toLowerCase().includes(p));
  return [...pref,...rest].slice(0,SUGGEST_MAX);
}
function tpRenderDatalist(prefix){
  const dl=document.getElementById("taskSuggestions");
  if(!dl) return;
  const opts=tpGetSuggestions(prefix);
  dl.innerHTML=opts.map(n=>`<option value="${escapeHtml(n)}"></option>`).join("");
}

/* ---------- Rendering ---------- */
function renderAll(){
  const todayLabel=document.getElementById("todayLabel");
  if(todayLabel) todayLabel.textContent=fmtHumanDate(TODAY);
  const viewingLabel=document.getElementById("viewingLabel");
  if(viewingLabel) viewingLabel.textContent=fmtHumanDate(viewing);

  const list=ensureDay(viewing);
  const ul=document.getElementById("taskList");
  if(ul){
    ul.innerHTML="";
    const filtered = focusLane
      ? list.filter(t => t.prio==="high" || (t.stars||0)>0 || t.fromCarry)
      : list;

    filtered.forEach(t=>{
      const li=document.createElement("li");
      li.className="task";

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=t.done;
      cb.onchange=e=>toggleDone(viewing,t.id,e.target.checked);

      const center=document.createElement("div");
      const prioc=t.prio==="low"?"p-low":t.prio==="med"?"p-med":"p-high";
      const completedMeta=(t.done&&t.timeCompleted)
        ? `<div class="meta">âœ” completed ${fmtDateTime(t.timeCompleted)}</div>`
        : "";
      center.innerHTML=
        `<div style="font-weight:600;${t.done?"text-decoration:line-through;opacity:.7":""}">
           ${escapeHtml(t.name)}
         </div>
         <div><span class="priority ${prioc}">${t.prio}</span>${t.fromCarry?" Â· carried":""}</div>
         ${completedMeta}`;

      const stars=document.createElement("div");
      stars.className="stars";
      for(let s=1;s<=3;s++){
        const b=document.createElement("button");
        b.textContent="â˜…";
        if((t.stars||0)>=s) b.classList.add("on");
        b.onclick=()=>setStars(viewing,t.id,s);
        stars.appendChild(b);
      }

      const act=document.createElement("div");
      act.className="actions";
      const e=document.createElement("button");
      e.textContent="âœŽ";
      e.onclick=()=>editTask(viewing,t.id);
      const d=document.createElement("button");
      d.textContent="Ã—";
      d.className="del";
      d.onclick=()=>delTask(viewing,t.id);
      act.appendChild(e);
      act.appendChild(d);

      li.appendChild(cb);
      li.appendChild(center);
      li.appendChild(stars);
      li.appendChild(act);
      ul.appendChild(li);
    });
  }

  const total=list.length;
  const done=list.filter(x=>x.done).length;
  const pct=total?Math.round(done/total*100):0;
  const q=list.filter(x=>x.done).reduce((a,b)=>a+(b.stars||0),0);
  const qPct=done?Math.round((q/(done*3))*100):0;

  const doneSummary=document.getElementById("doneSummary");
  if(doneSummary) doneSummary.textContent=`${done} / ${total} tasks done (${pct}%)`;
  const qualitySummary=document.getElementById("qualitySummary");
  if(qualitySummary) qualitySummary.textContent=`Quality ${qPct}%`;
  const kpiRow=document.getElementById("kpiRow");
  if(kpiRow && kpiRow.firstElementChild){
    kpiRow.firstElementChild.textContent=
      `${done} / ${total} done (${pct}%) Â· Quality ${qPct}%`;
  }

  const focusChk=document.getElementById("focusToggle");
  if(focusChk) focusChk.checked=focusLane;

  renderMeds();
}

/* ---------- History ---------- */
function renderHistory(){
  const wrap=document.getElementById("histList");
  if(!wrap) return;
  const q=(document.getElementById("histSearch").value||"").trim().toLowerCase();
  const spanSel=document.getElementById("histSpan").value;
  let keys=Object.keys(days||{});
  if(spanSel!=="all"){
    const span=parseInt(spanSel,10);
    const min=new Date();
    min.setDate(min.getDate()-span);
    keys=keys.filter(k=>new Date(k+"T00:00:00")>=min);
  }
  keys.sort((a,b)=>new Date(b+"T00:00:00")-new Date(a+"T00:00:00"));
  if(q){
    keys=keys.filter(k=>{
      if(k.includes(q)) return true;
      const arr=days[k]||[];
      return arr.some(t=>(t.name||"").toLowerCase().includes(q));
    });
  }
  wrap.innerHTML="";
  if(!keys.length){
    wrap.innerHTML='<div class="muted">No history found.</div>';
    return;
  }
  keys.forEach(k=>{
    const arr=days[k]||[];
    const total=arr.length;
    const done=arr.filter(t=>t.done).length;
    const pct=total?Math.round(done/total*100):0;
    const qsum=arr.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
    const qPct=done?Math.round((qsum/(done*3))*100):0;
    const row=document.createElement("div");
    row.className="hist-row";
    const left=document.createElement("div");
    left.innerHTML=
      `<div style="font-weight:700">${fmtHumanDate(k)}</div>
       <div class="meta">${done}/${total} done â€¢ ${pct}% Â· Quality ${qPct}%</div>`;
    const right=document.createElement("div");
    const btn=document.createElement("button");
    btn.textContent="Open";
    btn.onclick=()=>{ viewing=k; showTab("tasks"); renderAll(); };
    right.appendChild(btn);
    row.appendChild(left);
    row.appendChild(right);
    wrap.appendChild(row);
  });
}

/* ---------- Backup ---------- */
(function(){
  function buildBackupPayload(){
    const dump={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(/^tp_/.test(k)) dump[k]=localStorage.getItem(k);
    }
    dump[LS_KEY]=JSON.stringify(days||{});
    dump[LS_MEDS]=JSON.stringify(meds||{});
    dump[LS_SYNC]=localStorage.getItem(LS_SYNC)||"";
    dump[LS_TAB]=localStorage.getItem(LS_TAB)||"tasks";
    dump[LS_LAST_OPEN]=localStorage.getItem(LS_LAST_OPEN)||isoToday();
    dump[LS_LAST_CARRY_COUNT]=localStorage.getItem(LS_LAST_CARRY_COUNT)||"0";
    dump[LS_FOCUS]=JSON.stringify(focusLane);
    return {app:"taskpulse",version:"V.10.4",exportedAt:new Date().toISOString(),dump};
  }
  window.tpDownloadBackup=function(){
    try{
      const payload=buildBackupPayload();
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download="taskpulse_backup.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      localStorage.setItem("tp_last_backup",new Date().toLocaleString());
      tpUpdateLastBackupLabel();
      setStatus("Backup downloaded.");
    }catch(e){
      console.error("Backup failed:",e);
      setStatus("Backup failed: "+e.message);
      alert("Backup failed: "+e.message);
    }
  };
  const fi=document.getElementById("tpRestoreFile");
  if(fi){
    fi.addEventListener("change",async e=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const text=await f.text();
        const data=JSON.parse(text);
        if(data && data.dump){
          Object.entries(data.dump).forEach(([k,v])=>{
            if(/^tp_/.test(k)) localStorage.setItem(k,v);
          });
        }
        setStatus("Restore complete. Reloadingâ€¦");
        setTimeout(()=>location.reload(),600);
      }catch(err){
        console.error("Restore failed:",err);
        setStatus("Restore failed: "+err.message);
        alert("Restore failed: "+err.message);
      }finally{e.target.value="";}
    });
  }
  function setStatus(msg){
    const el=document.getElementById("tpBackupStatus");
    if(el) el.textContent=msg;
  }
})();
function tpUpdateLastBackupLabel(){
  const el=document.getElementById("tpLastBackup");
  if(!el) return;
  el.textContent="Last backup: "+(localStorage.getItem("tp_last_backup")||"none");
}

/* ---------- Tabs ---------- */
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function showTab(id){
  document.querySelectorAll(".tabpage").forEach(el=>el.classList.remove("active"));
  const page=document.getElementById("tab-"+id);
  if(page) page.classList.add("active");
  document.querySelectorAll(".tabbar button").forEach(b=>b.classList.remove("active"));
  const btn=document.getElementById("btnTab"+cap(id));
  if(btn) btn.classList.add("active");
  localStorage.setItem(LS_TAB,id);
  if(id==="history") renderHistory();
}

/* ---------- Sync (Firebase) ---------- */
const TP_UID=(localStorage.getItem("tp_uid")||(()=>{
  const v="u_"+Math.random().toString(36).slice(2,10);
  localStorage.setItem("tp_uid",v);
  return v;
})());
let syncRef=null,syncOff=null,writeTimer=null;

function setSyncBadge(text,kind){
  const el=document.getElementById("syncState");
  if(!el) return;
  el.textContent=text;
  el.className="badge"+(kind?" "+kind:"");
}
const SYNC_PREFIX="grp-";
function randomCode(len=6){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}

function ensureSyncCode(){
  let code=localStorage.getItem(LS_SYNC);
  if(!code || !code.trim()){
    code=SYNC_PREFIX+randomCode(6);
    localStorage.setItem(LS_SYNC,code);
  }
  const inp=document.getElementById("syncCode");
  if(inp) inp.value=code;

  console.log("[Sync] Firebase ready?", isFirebaseReady(),
    typeof firebase!=="undefined" && firebase.apps ? firebase.apps.length : 0);

  if(isFirebaseReady()) attachSync(code);
}
function copySyncCode(){
  const i=document.getElementById("syncCode");
  if(!i||!i.value) return;
  navigator.clipboard.writeText(i.value).then(()=>alert("Sync code copied"));
}
function newSyncCode(){
  if(!confirm("Generate a new sync code? Devices must use this new code.")) return;
  const code=SYNC_PREFIX+randomCode(6);
  localStorage.setItem(LS_SYNC,code);
  const inp=document.getElementById("syncCode");
  if(inp) inp.value=code;
  if(typeof syncOff==="function" && syncOff) syncOff();
  if(isFirebaseReady()) attachSync(code);
  alert("New code generated.");
}
function saveSyncCode(){
  const i=document.getElementById("syncCode");
  if(!i) return;
  const v=(i.value||"").trim();
  if(!v) return;
  localStorage.setItem(LS_SYNC,v);
  alert("Sync code saved.");
  if(typeof syncOff==="function" && syncOff) syncOff();
  if(isFirebaseReady()) attachSync(v);
}
function notifyLocalChanged(){ debouncedPush(); }
function debouncedPush(){
  if(!syncRef) return;
  clearTimeout(writeTimer);
  writeTimer=setTimeout(()=>{
    syncRef.set({days,meds,_meta:{by:TP_UID,at:Date.now()}})
      .catch(console.warn);
  },250);
}
function mergeDays(localDays,remoteDays){
  const out={...(localDays||{})};
  for(const d of Object.keys(remoteDays||{})){
    if(!out[d]){ out[d]=remoteDays[d]; continue; }
    const L=out[d]||[], R=remoteDays[d]||[];
    const stamp=arr=>arr.reduce((m,t)=>Math.max(m,new Date(t.timeCompleted||t.createdAt||0).getTime()),0);
    out[d]=(stamp(R)>stamp(L))?R:L;
  }
  return out;
}
function mergeMeds(localM,remoteM){
  const out={...(localM||{})};
  for(const day of Object.keys(remoteM||{})){
    const r=remoteM[day]||{}, l=out[day]||{morning:"",night:""};
    const pick=(a,b)=>{
      const ta=a?Date.parse(a):0, tb=b?Date.parse(b):0;
      return (tb>ta)?b:a;
    };
    out[day]={morning:pick(l.morning,r.morning), night:pick(l.night,r.night)};
  }
  return out;
}

const prevSave = save;
save = function(k,v){
  prevSave(k,v);
  if(k===LS_KEY || k===LS_MEDS) notifyLocalChanged();
};

function attachSync(code){
  if(!isFirebaseReady()){
    setSyncBadge("Local-only");
    return;
  }
  if(!code) return;
  if(syncOff){ syncOff(); syncOff=null; }
  syncRef=firebase.database().ref("taskpulse/"+code);
  setSyncBadge("Sync: "+code,"good");

  syncRef.get().then(snap=>{
    const val=snap.val();
    if(val && (val.days||val.meds)){
      days=mergeDays(days,val.days||{});
      meds=mergeMeds(meds,val.meds||{});
      baseSave(LS_KEY,days);
      baseSave(LS_MEDS,meds);
      renderAll();
    }else{
      debouncedPush();
    }
  }).catch(e=>{
    console.warn(e);
    setSyncBadge("Sync error","warn");
  });

  const handler=syncRef.on("value",snap=>{
    const val=snap.val();
    if(!val) return;
    if(val._meta && val._meta.by===TP_UID) return;
    if(val.days){
      days=mergeDays(days,val.days);
      baseSave(LS_KEY,days);
    }
    if(val.meds){
      meds=mergeMeds(meds,val.meds);
      baseSave(LS_MEDS,meds);
    }
    renderAll();
  });
  syncOff=()=>syncRef.off("value",handler);
}

/* ---------- Service worker ---------- */
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/* ---------- Init ---------- */
document.addEventListener("DOMContentLoaded",()=>{
  autoCarryForwardIfNewDay();
  showCarryBannerIfAny();

  const lastTab=localStorage.getItem(LS_TAB)||"tasks";
  showTab(lastTab);

  ensureSyncCode();
  tpUpdateLastBackupLabel();
  tpRenderDatalist("");
  renderAll();
  renderHistory();
});
</script>
</body>
</html>

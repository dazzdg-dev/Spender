<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Pulse Smart V10.6</title>

<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon-192.png" sizes="192x192" />
<meta name="theme-color" content="#0f111a" />

<style>
  :root{
    --bg:#050611;
    --shell:#050814;
    --card:#141725;
    --ink:#e9ecf5;
    --muted:#a7b0cf;
    --line:#262a3c;
    --pill:#1b2440;
    --pad:14px;
    --radius:16px;
    --tap:50px;
    --fs:16px;

    --accent:#27b7ff;
    --accent2:#4df2ff;

    --warn:#ffcc66;
    --good:#76e0a6;
    --bad:#ff8ea1;

    --doseEdge:#2b3b56;
    --doseGlow:#2aa7ff33;
    --doseTakenEdge:#ff9d3b;
    --doseTakenGlow:#ff9d3b44;

    --timerBg:#5067ff;
    --timerInk:#eef2ff;
  }

  @media (max-width:480px){
    :root{ --pad:12px; --radius:14px; --tap:56px; --fs:17px }
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; margin:0; padding:0; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);
    font-size:var(--fs);
    background:radial-gradient(circle at top,#1d2440 0,#050611 55%);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:12px;
  }

  .shell{
    max-width:900px;
    width:100%;
    background:var(--shell);
    border-radius:18px;
    box-shadow:0 18px 60px rgba(0,0,0,.7);
    padding:16px 18px 14px;
    border:1px solid #20263c;
  }
  .wrap{ max-width:820px; margin:0 auto; padding:4px var(--pad) calc(40px + env(safe-area-inset-bottom)); }

  .hero-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
    gap:10px;
  }
  .brand{ display:flex; align-items:center; gap:10px; }
  .logo-pill{
    width:42px;height:42px;border-radius:999px;
    background:radial-gradient(circle at 30% 20%,#5fffd0 0,#0fd0ff 40%,#0b1428 80%);
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 0 18px rgba(0,255,213,.35);
    font-weight:800;letter-spacing:.03em;color:white;
  }
  .brand-title{ font-size:18px;font-weight:700; }
  .brand-sub{ font-size:11px;color:var(--muted); }
  .top-right{ display:flex; flex-direction:column; align-items:flex-end; gap:4px; font-size:11px; color:var(--muted); }
  .badge{
    padding:2px 8px;border-radius:999px;border:1px solid #3b425d;
    font-size:11px;background:var(--pill);
  }
  .badge.good{ border-color:#3bd47a;color:#7fffb3; }
  .badge.warn{ border-color:#e7a74c;color:#ffd78a; }
  .badge.bad{ border-color:#e05264;color:#ff9da8; }

  .kpi-pill{
    margin:6px 0 10px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    color:var(--muted);
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:rgba(10,15,30,.9);
    gap:10px;
  }

  /* Tabs */
  .tabs{
    position:sticky; top:0; z-index:50;
    padding:6px 0 6px;
    background:linear-gradient(180deg, rgba(5,8,20,.98) 0%, rgba(5,8,20,.88) 70%, rgba(5,8,20,0) 100%);
    backdrop-filter:saturate(130%) blur(4px);
    margin:10px 0 8px;
  }
  .tabbar{ display:flex; gap:8px; overflow:auto; padding-bottom:4px; }
  .tabbar button{
    flex:1; min-width:110px;
    padding:10px 12px;
    font-size:13px;
    border-radius:999px;
    border:1px solid #1f2a44;
    background:#0e1324;
    color:#c2c9e3;
    cursor:pointer;
    font-weight:600;
    white-space:nowrap;
  }
  .tabbar button.active{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#04101b;
    box-shadow:0 0 18px rgba(39,183,255,.35);
    border-color:transparent;
  }

  .tabpage{ display:none; }
  .tabpage.active{ display:block; }

  /* Cards */
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:12px 12px 10px;
    margin:10px 0;
    box-shadow:0 6px 30px rgba(0,0,0,.25);
  }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  input,select,button,textarea{
    border-radius:999px;
    border:1px solid var(--line);
    background:#050814;
    color:var(--ink);
    padding:10px 12px;
    min-height:var(--tap);
    font-size:13px;
  }
  input[type=text]{ flex:1 1 220px; min-width:0; }
  textarea{
    border-radius:14px;
    min-height:70px;
    resize:vertical;
    width:100%;
    padding:10px 12px;
    line-height:1.25;
  }
  button.primary{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#04101b;
    border:none;
    font-weight:800;
    cursor:pointer;
    white-space:nowrap;
  }
  button{ cursor:pointer; }
  .btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--muted); }
  .btn-danger{ background:rgba(224,82,100,.12); border:1px solid #e05264; color:#ff9da8; }

  .muted{ color:var(--muted); }
  .list{ list-style:none; margin:0; padding:0; }

  /* Banner */
  .banner{
    display:none;
    margin:6px 0 0 0;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid #3b3a1c;
    background:rgba(32,28,10,.6);
    color:#ffe3a3;
    font-size:13px;
    line-height:1.25;
  }
  .banner .mini{ display:block; font-size:12px; color:#f6d792; opacity:.95; margin-top:5px; }
  .banner button{
    margin-left:8px;
    border-radius:999px;
    padding:8px 12px;
    border:1px solid #ff9d3b;
    background:#2a1b0d;
    color:#ffd8a2;
    box-shadow:0 0 10px rgba(255,140,40,0.25);
  }

  /* Meds */
  .meds-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .meds-head-title{ font-size:16px; font-weight:800; }
  .meds-head-tag{
    font-size:11px;
    padding:3px 10px;
    border-radius:999px;
    background:#101828;
    color:#9fd2ff;
    border:1px solid #294064;
    white-space:nowrap;
  }
  .meds-row{ display:flex; flex-wrap:wrap; gap:10px; }
  .meds-btn{
    flex:1 1 240px;
    min-width:0;
    border-radius:18px;
    padding:14px 14px;
    background:#070a18;
    border:1px solid var(--doseEdge);
    text-align:left;
    display:flex;
    flex-direction:column;
    gap:4px;
    box-shadow:0 0 0 0 rgba(0,0,0,0);
    transition:transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
  }
  .meds-btn:hover{ transform:translateY(-1px); }
  .meds-btn .topline{ display:flex; align-items:center; gap:10px; }
  .meds-icon{ font-size:18px; width:22px; text-align:center; }
  .meds-btn-title{ font-size:15px; font-weight:900; color:#f5f8ff; letter-spacing:.2px; }
  .meds-btn-sub{ font-size:12px; color:#a7b8d9; }

  /* taken (not neon-fill; border glow like V8.8 vibe) */
  .meds-btn.taken{
    background:linear-gradient(180deg,#0b1022 0%, #070a18 100%);
    border-color:rgba(255,157,59,.75);
    box-shadow:0 0 0 2px rgba(255,157,59,.18), 0 0 18px rgba(255,157,59,.18);
  }
  .meds-btn.taken .meds-btn-sub{ color:#ffd8a2; }

  .pulse-once{ animation:pulse .55s ease-out 1; }
  @keyframes pulse{
    0%{ transform:scale(1); box-shadow:0 0 0 0 rgba(255,157,59,.0); }
    40%{ transform:scale(1.01); box-shadow:0 0 0 3px rgba(255,157,59,.18); }
    100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(255,157,59,.0); }
  }

  .meds-meta{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .meds-kpis{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#0e1324;
    color:#c9d2f0;
    font-size:12px;
  }
  .chip strong{ color:#fff; font-weight:900; }

  .next-dose{
    margin-top:10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(90deg, rgba(80,103,255,.98), rgba(80,103,255,.82));
    color:var(--timerInk);
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .next-dose .label{
    font-size:11px;
    letter-spacing:.14em;
    opacity:.95;
  }
  .next-dose .time{
    font-size:18px;
    font-weight:900;
    letter-spacing:.4px;
    font-variant-numeric:tabular-nums;
  }

  /* Mood */
  .mood-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .mood-btn{
    flex:1 1 120px;
    border-radius:16px;
    padding:12px 12px;
    border:1px solid #263252;
    background:#0b1022;
    font-weight:800;
    text-align:center;
  }
  .mood-btn.active{
    border-color:rgba(39,183,255,.8);
    box-shadow:0 0 0 2px rgba(39,183,255,.14), 0 0 18px rgba(39,183,255,.14);
  }
  .mood-mini{
    display:flex;
    gap:6px;
    align-items:flex-end;
    height:38px;
    margin-top:10px;
  }
  .mood-bar{
    flex:1;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.06);
    position:relative;
    overflow:hidden;
  }
  .mood-bar i{
    display:block;
    width:100%;
    position:absolute;
    bottom:0;
    height:50%;
    background:linear-gradient(180deg, rgba(39,183,255,.9), rgba(79,242,255,.65));
  }
  .mood-bar small{
    position:absolute;
    top:6px;
    left:6px;
    font-size:10px;
    color:#dbe5ff;
    opacity:.85;
  }

  /* Tasks */
  .task{
    display:grid;
    grid-template-columns:auto 1fr auto auto;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    margin-bottom:6px;
    border-radius:14px;
    background:#101528;
    border:1px solid #1e2234;
  }
  .task input[type="checkbox"]{ width:16px;height:16px; }
  .task .name{ font-weight:900; }
  .task .subline{ font-size:12px; color:#9fb0d0; margin-top:4px; display:flex; flex-wrap:wrap; gap:6px; }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    font-size:11px;
    color:#cdd6f1;
  }
  .priority{
    display:inline-block;
    border-radius:999px;
    padding:2px 8px;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.05em;
    font-weight:900;
  }
  .p-low{ background:#16352b;color:#7af3b1; }
  .p-med{ background:#3a321b;color:#ffe08a; }
  .p-high{ background:#3d1b25;color:#ff9ab2; }

  .stars button{
    border:none;background:transparent;cursor:pointer;font-size:14px;opacity:.35;
    padding:4px 3px;
  }
  .stars button.on{ opacity:1; text-shadow:0 0 8px rgba(255,215,120,.55); }
  .actions{ display:flex; gap:6px; }
  .actions button{
    border:none;background:transparent;cursor:pointer;font-size:16px;padding:2px 4px;color:#99a4d2;
  }
  .actions .del{ color:#ff9ba9; }

  .sum{
    display:flex;
    justify-content:space-between;
    padding:8px 10px;
    background:#0e1324;
    border:1px solid var(--line);
    border-radius:12px;
    font-size:12px;
    margin-top:8px;
  }

  /* Focus lane */
  .focus-box{
    margin-top:10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#0e1324;
    padding:10px 10px;
  }
  .focus-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .focus-head .label{ font-weight:900; }
  .focus-toggle{
    display:flex; align-items:center; gap:8px; color:#cbd6ff; font-size:12px;
  }
  .focus-list{ margin-top:10px; display:none; }
  .focus-list.active{ display:block; }
  .focus-item{
    padding:10px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    margin:6px 0;
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
  }
  .focus-item strong{ font-weight:900; }
  .focus-item small{ display:block; color:#a7b0cf; font-size:12px; margin-top:2px; }

  /* History rows */
  .hist-row{
    border-radius:12px;border:1px solid var(--line);
    padding:12px 12px;margin:8px 0;
    display:flex;justify-content:space-between;align-items:center;
    background:#101528; gap:10px;
  }
  .hist-row .meta{ color:#9fb0d0;font-size:12px;margin-top:4px; }
  .hist-row button{ border-radius:999px;padding:8px 12px; }

  /* Mobile tweaks */
  @media (max-width:600px){
    .shell{ padding:14px 10px 12px; }
    .hero-header{ flex-direction:column; align-items:flex-start; }
    .top-right{ align-items:flex-start; }
    .task{ grid-template-columns:auto 1fr auto; }
    .task .actions{ grid-column:1 / -1; justify-content:flex-end; }
    .next-dose .time{ font-size:16px; }
  }
</style>
</head>

<body>
<div class="shell">
  <div class="wrap">
    <header class="hero-header">
      <div class="brand">
        <div class="logo-pill">TP</div>
        <div>
          <div class="brand-title">Task Pulse Smart</div>
          <div class="brand-sub">Daily focus advisor ¬∑ V10.6</div>
        </div>
      </div>
      <div class="top-right">
        <div id="syncState" class="badge">Local-only</div>
        <div id="tpLastBackup">Last backup: none</div>
      </div>
    </header>

    <div class="kpi-pill" id="kpiRow">
      <span id="kpiText">0 / 0 done (0%) ¬∑ Quality 0%</span>
      <span id="todayLabel" class="muted">‚Äî</span>
    </div>

    <div id="medsBanner" class="banner"></div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tabbar">
        <button id="btnTabTasks" class="active" onclick="showTab('tasks')">Tasks</button>
        <button id="btnTabHistory" onclick="showTab('history')">History</button>
        <button id="btnTabSettings" onclick="showTab('settings')">Settings</button>
      </div>
    </div>

    <!-- TAB: TASKS -->
    <div id="tab-tasks" class="tabpage active">

      <!-- Meds -->
      <section class="card" id="medsCard">
        <div class="meds-head">
          <div class="meds-head-title">Medication ‚Äî Today</div>
          <div class="meds-head-tag">TLE routine</div>
        </div>

        <div class="meds-row">
          <button id="btnMorn" class="meds-btn" onclick="toggleMeds('morning')" title="Log/undo Morning dose"></button>
          <button id="btnNight" class="meds-btn" onclick="toggleMeds('night')" title="Log/undo Night dose"></button>
        </div>

        <div class="next-dose" id="nextDoseBar" style="display:none;">
          <div>
            <div class="label">NEXT DOSE</div>
          </div>
          <div class="time" id="nextDoseTime">‚Äî</div>
        </div>

        <div class="meds-meta">
          <div class="meds-kpis" id="medsKpis"></div>
          <div class="muted" id="medsMeta"></div>
        </div>
      </section>

      <!-- Mood -->
      <section class="card" id="moodCard">
        <div class="row" style="justify-content:space-between; gap:10px;">
          <div>
            <div style="font-weight:900;font-size:16px;">Mood ‚Äî Today</div>
            <div class="muted" style="font-size:12px;margin-top:3px;">Quick check-in (helps Focus Lane adapt)</div>
          </div>
          <div class="chip" id="moodChip">No mood logged</div>
        </div>

        <div class="mood-row" style="margin-top:10px;">
          <button class="mood-btn" id="mood1" onclick="setMood(1)">üòû Low</button>
          <button class="mood-btn" id="mood2" onclick="setMood(2)">üòê Okay</button>
          <button class="mood-btn" id="mood3" onclick="setMood(3)">üôÇ Good</button>
          <button class="mood-btn" id="mood4" onclick="setMood(4)">üòÑ Great</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <select id="energySel" onchange="saveMoodExtras()">
            <option value="">Energy (optional)</option>
            <option value="1">Low energy</option>
            <option value="2">Medium energy</option>
            <option value="3">High energy</option>
          </select>

          <input id="moodTags" type="text" placeholder="Tags (comma): stress, sleep, work‚Ä¶" onblur="saveMoodExtras()" />
        </div>

        <div style="margin-top:10px;">
          <textarea id="moodNote" placeholder="Notes (optional) ‚Äî keep it short‚Ä¶" onblur="saveMoodExtras()"></textarea>
        </div>

        <div class="mood-mini" id="moodMini"></div>
      </section>

      <!-- Tasks input -->
      <section class="card">
        <h3 style="margin:0 0 10px">Today's Tasks</h3>

        <div class="row" style="margin-bottom:10px">
          <input id="taskInput" type="text" placeholder="Add task‚Ä¶" list="taskSuggestions" autocomplete="off"
                 oninput="onTaskTyping(this.value)" />
          <datalist id="taskSuggestions"></datalist>

          <select id="prioSelect" title="Priority">
            <option value="low">low</option>
            <option value="med" selected>med</option>
            <option value="high">high</option>
          </select>

          <select id="diffSelect" title="Difficulty">
            <option value="1">D1</option>
            <option value="2">D2</option>
            <option value="3" selected>D3</option>
            <option value="4">D4</option>
            <option value="5">D5</option>
          </select>

          <select id="estSelect" title="Estimate">
            <option value="">‚Äî</option>
            <option value="5">5m</option>
            <option value="10">10m</option>
            <option value="20">20m</option>
            <option value="40">40m</option>
            <option value="60">60m</option>
          </select>

          <button class="primary" onclick="addTask()">Add</button>
        </div>

        <div class="row">
          <button class="btn-ghost" onclick="clearCompleted()">Clear completed</button>
          <button class="btn-ghost" onclick="manualCarryOver()" title="Move all incomplete tasks to tomorrow">Carry incomplete ‚Üí tomorrow</button>
        </div>
      </section>

      <!-- Focus lane -->
      <section class="card">
        <div class="focus-head">
          <div class="label">Focus Lane</div>
          <label class="focus-toggle">
            <input id="focusToggle" type="checkbox" onchange="toggleFocusLane()" />
            only high / starred / carried
          </label>
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px;">
          Focus adapts slightly to meds + mood (gentle nudges, not judgement).
        </div>

        <div class="focus-list" id="focusList"></div>
      </section>

      <!-- Task list -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Viewing</div>
            <div id="viewingLabel" style="font-weight:900">‚Äî</div>
          </div>
          <div class="row" style="gap:6px">
            <button class="btn-ghost" onclick="shiftDay(-1)">‚óÄ</button>
            <button class="btn-ghost" onclick="shiftDay(+1)">‚ñ∂</button>
          </div>
        </div>

        <ul id="taskList" class="list" style="margin-top:10px"></ul>

        <div class="sum">
          <div id="doneSummary">0 / 0 tasks done (0%)</div>
          <div id="qualitySummary">Quality 0%</div>
        </div>
      </section>
    </div>

    <!-- TAB: HISTORY -->
    <div id="tab-history" class="tabpage">
      <section class="card">
        <h3 style="margin:0 0 10px">Weekly Review</h3>
        <div class="row" style="gap:10px; flex-wrap:wrap;">
          <div class="chip" id="wkMedsChip">Meds: ‚Äî</div>
          <div class="chip" id="wkMoodChip">Mood avg: ‚Äî</div>
          <div class="chip" id="wkTasksChip">Tasks: ‚Äî</div>
        </div>
        <div class="muted" style="margin-top:10px;font-size:12px;" id="wkInsight">‚Äî</div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px">History</h3>
        <div class="row" style="gap:8px;margin-bottom:8px">
          <input id="histSearch" type="text" placeholder="Search text or YYYY-MM-DD‚Ä¶" oninput="renderHistory()" />
          <select id="histSpan" onchange="renderHistory()">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="all">All</option>
          </select>
        </div>
        <div id="histList"></div>
      </section>
    </div>

    <!-- TAB: SETTINGS -->
    <div id="tab-settings" class="tabpage">
      <section class="card">
        <h3 style="margin:0 0 10px">Sync</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="syncCode" placeholder="Sync code" style="flex:1 1 260px" />
          <button class="btn-ghost" onclick="copySyncCode()">Copy</button>
          <button class="btn-ghost" onclick="newSyncCode()">New code</button>
          <button class="primary" onclick="saveSyncCode()">Save</button>
        </div>
        <div class="muted" id="syncHint" style="font-size:12px;">
          Open this site on your second device and use the same code. Sync uses Firebase Realtime Database.
        </div>
        <div class="muted" style="font-size:12px;margin-top:8px;">
          <strong>Note:</strong> paste your Firebase config inside the script block below (look for <code>TP_FIREBASE_CONFIG</code>).
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px">Task Rules (auto priority & difficulty)</h3>
        <div class="muted" style="font-size:12px;margin-bottom:10px;">
          Add keywords like <code>cook</code>, <code>email</code>, <code>study</code>. When your task contains them, priority/difficulty auto-fills.
        </div>

        <div class="row" style="margin-bottom:10px;">
          <input id="ruleKeyword" type="text" placeholder="Keyword (e.g. cook)" />
          <select id="rulePrio">
            <option value="low">low</option>
            <option value="med" selected>med</option>
            <option value="high">high</option>
          </select>
          <select id="ruleDiff">
            <option value="1">D1</option><option value="2">D2</option><option value="3" selected>D3</option><option value="4">D4</option><option value="5">D5</option>
          </select>
          <button class="primary" onclick="addRule()">Add</button>
          <button class="btn-ghost" onclick="seedDefaultRules()">Seed defaults</button>
        </div>

        <div id="rulesList" class="muted" style="font-size:12px;"></div>
      </section>

      <section class="card" id="backupCard">
        <h3 style="margin:0 0 10px">Backup &amp; Restore</h3>
        <div class="row" style="align-items:center">
          <button id="btnBackup" class="primary" onclick="tpDownloadBackup()">‚≠≥  Download Backup</button>
          <input id="tpRestoreFile" type="file" accept="application/json" style="display:none" />
          <button id="btnRestore" class="btn-ghost" onclick="document.getElementById('tpRestoreFile').click()">‚≠±  Import Backup</button>
        </div>
        <div id="tpBackupStatus" class="muted" style="margin-top:8px;font-size:12px;"></div>
      </section>
    </div>

    <footer style="margin-top:8px;text-align:center;font-size:11px;color:var(--muted);">
      Task Pulse Smart V10.6 ¬∑ Powered by D Gounder
    </footer>
  </div>
</div>

<!-- Firebase (optional) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
/* ===========================
   Task Pulse Smart V10.6
   - Meds: morning/night + 12h timer from last logged dose (even if morning missed)
   - Adherence KPIs + streaks
   - Mood tracking (daily) + weekly review
   - Task difficulty + auto rules (keyword -> prio/diff)
   - Focus Lane (functional) + gentle influence from meds/mood
   - LocalStorage + optional Firebase sync
   =========================== */

/* ===== Schema / Storage Keys ===== */
const TP_SCHEMA = '10.6';
const LS_KEY='tp_days_v1';
const LS_MEDS='tp_meds_v2';          // morning/night
const LS_MOOD='tp_mood_v1';
const LS_RULES='tp_task_rules_v1';
const LS_SYNC='tp_sync_code';
const LS_TAB='tp_last_tab';
const LS_LAST_OPEN='tp_last_open';
const LS_LAST_CARRY_COUNT='tp_last_carry_count';
const LS_LAST_BACKUP='tp_last_backup';
const LS_FOCUS='tp_focus_on';

/* ===== Utils ===== */
function isoToday(){ return new Date().toISOString().slice(0,10); }
function isoOffset(iso, days){ const d=new Date(iso); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function load(k,def){ try{ const v=JSON.parse(localStorage.getItem(k)||'null'); return (v ?? def); }catch(e){ return def; } }
function baseSave(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
let save = function(k,v){ try{ baseSave(k,v); }catch(e){ console.warn('save failed, will retry', e); } };
function fmtHumanDate(iso){ const d=new Date(iso); return d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'}); }
function fmtDateTime(iso){
  try{
    const d=new Date(iso);
    const date=d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
    const time=d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
    return `${date} ¬∑ ${time}`;
  }catch{ return '‚Äî'; }
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m])); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

/* ===== Core State ===== */
const TODAY = isoToday();
let viewing = TODAY;

let days = load(LS_KEY, {});
let meds = load(LS_MEDS, {});
let mood = load(LS_MOOD, {});
let rules = load(LS_RULES, {});   // { keywordLower: {prio, diff} }

/* ===== Initialize ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  autoCarryForwardIfNewDay();
  viewing = TODAY;

  document.getElementById('todayLabel').textContent = fmtHumanDate(TODAY);
  renderAll();

  const lastTab = localStorage.getItem(LS_TAB) || 'tasks';
  showTab(lastTab);

  ensureSyncCode();
  renderRules();
  tpUpdateLastBackupLabel();
  renderHistory();
  renderWeeklyReview();
});

/* ===== Tabs ===== */
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function showTab(id){
  document.querySelectorAll('.tabpage').forEach(el=>el.classList.remove('active'));
  const page=document.getElementById('tab-'+id);
  if(page) page.classList.add('active');

  document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('btnTab'+cap(id));
  if(btn) btn.classList.add('active');

  localStorage.setItem(LS_TAB,id);

  if(id==='history'){ renderHistory(); renderWeeklyReview(); }
  if(id==='settings'){ renderRules(); }
}

/* ===== Data helpers ===== */
function ensureDay(iso){ if(!days[iso]) days[iso]=[]; return days[iso]; }
function medsFor(iso){
  if(!meds[iso]) meds[iso]={ morning:'', night:'' };
  return meds[iso];
}
function moodFor(iso){
  if(!mood[iso]) mood[iso]={ mood:0, energy:'', tags:[], note:'' };
  return mood[iso];
}

/* ===== Meds logic ===== */
let medsTimerInterval=null;

function latestDoseIso(dayIso){
  const m = medsFor(dayIso);
  const a = m.morning ? Date.parse(m.morning) : 0;
  const b = m.night ? Date.parse(m.night) : 0;
  if(!a && !b) return '';
  return (b>a) ? m.night : m.morning;
}

function getNextDoseTarget(){
  // 12h from last logged dose (morning OR night). Works even if morning missed.
  const lastIso = latestDoseIso(TODAY);
  if(!lastIso) return null;
  return new Date(Date.parse(lastIso) + 12*60*60*1000);
}

function toggleMeds(which){
  const todayIso = isoToday();
  const m = medsFor(todayIso);

  const wasTaken = !!m[which];
  if(wasTaken){
    if(!confirm("Unmark this dose as taken?")) return;
    m[which] = "";
  }else{
    m[which] = new Date().toISOString();
  }

  save(LS_MEDS, meds);

  const btn = document.getElementById(which === "morning" ? "btnMorn" : "btnNight");
  if(btn && !wasTaken){
    btn.classList.add("pulse-once");
    setTimeout(()=>btn.classList.remove("pulse-once"), 600);
  }

  renderMeds();
  renderWeeklyReview();
  notifyLocalChanged();
}

function formatCountdown(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${String(hh).padStart(2,'0')}h ${String(mm).padStart(2,'0')}m ${String(ss).padStart(2,'0')}s`;
}

function tickMedsTimer(){
  const bar = document.getElementById('nextDoseBar');
  const out = document.getElementById('nextDoseTime');
  const target = getNextDoseTarget();

  if(!target){
    if(bar) bar.style.display='none';
    if(out) out.textContent='‚Äî';
    return;
  }

  const now = new Date();
  let ms = target - now;

  // If timer hit 0, keep showing 00:00:00 until next dose logged.
  // (This avoids weird ‚Äúauto reset‚Äù that could be wrong if you intentionally skip.)
  if(ms < 0) ms = 0;

  if(bar) bar.style.display='flex';
  if(out) out.textContent = formatCountdown(ms);
}

function medsAdherenceWindow(daysBack){
  // percent of doses taken (2 per day)
  let dosesTaken=0, dosesTotal=0;
  for(let i=0;i<daysBack;i++){
    const d = isoOffset(TODAY, -i);
    const m = medsFor(d);
    dosesTotal += 2;
    if(m.morning) dosesTaken++;
    if(m.night) dosesTaken++;
  }
  const pct = dosesTotal ? Math.round((dosesTaken/dosesTotal)*100) : 0;
  return { dosesTaken, dosesTotal, pct };
}

function medsFullDayStreak(){
  // consecutive days from today backwards with BOTH doses
  let streak=0;
  for(let i=0;i<365;i++){
    const d = isoOffset(TODAY, -i);
    const m = medsFor(d);
    if(m.morning && m.night) streak++;
    else break;
  }
  return streak;
}

function medsBestStreak(){
  // best historical streak (simple scan of last 365 days)
  let best=0, cur=0;
  for(let i=0;i<365;i++){
    const d = isoOffset(TODAY, -i);
    const m = medsFor(d);
    if(m.morning && m.night){ cur++; best=Math.max(best,cur); }
    else cur=0;
  }
  return best;
}

function updateMedsBanner(){
  const bar = document.getElementById('medsBanner');
  if(!bar) return;

  const m = medsFor(TODAY);
  const missing = [];
  if(!m.morning) missing.push('Morning meds not taken');
  if(!m.night) missing.push('Night meds not taken');

  if(missing.length===0){
    bar.style.display='none';
    bar.innerHTML='';
    return;
  }

  bar.style.display='block';
  bar.innerHTML = `
    ${missing.join(' ‚Ä¢ ')}
    <span class="mini">Tap the dose buttons to log. Timer runs 12h from your last logged dose.</span>
    <button onclick="scrollToMeds()">Go to Meds</button>
  `;
}

function scrollToMeds(){
  const el=document.getElementById('medsCard');
  if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
}

function renderMeds(){
  const m = medsFor(TODAY);

  const btnM = document.getElementById('btnMorn');
  const btnN = document.getElementById('btnNight');
  const meta = document.getElementById('medsMeta');
  const kpis = document.getElementById('medsKpis');

  if(btnM){
    const isTaken = !!m.morning;
    btnM.className = 'meds-btn' + (isTaken ? ' taken' : '');
    btnM.innerHTML = `
      <div class="topline">
        <div class="meds-icon">üåÖ</div>
        <div class="meds-btn-title">Morning Dose</div>
      </div>
      <div class="meds-btn-sub">${isTaken ? `Logged ¬∑ ${fmtDateTime(m.morning)}` : 'Tap to log'}</div>
    `;
  }

  if(btnN){
    const isTaken = !!m.night;
    btnN.className = 'meds-btn' + (isTaken ? ' taken' : '');
    btnN.innerHTML = `
      <div class="topline">
        <div class="meds-icon">üåô</div>
        <div class="meds-btn-title">Night Dose</div>
      </div>
      <div class="meds-btn-sub">${isTaken ? `Logged ¬∑ ${fmtDateTime(m.night)}` : 'Tap to log'}</div>
    `;
  }

  if(meta){
    const a = m.morning ? `Morning: ${fmtDateTime(m.morning)}` : 'Morning: ‚Äî';
    const b = m.night ? `Night: ${fmtDateTime(m.night)}` : 'Night: ‚Äî';
    meta.textContent = `${a}   ‚Ä¢   ${b}`;
  }

  if(kpis){
    const a7 = medsAdherenceWindow(7);
    const a30 = medsAdherenceWindow(30);
    const streak = medsFullDayStreak();
    const best = medsBestStreak();
    kpis.innerHTML = `
      <span class="chip">7-day adherence <strong>${a7.pct}%</strong></span>
      <span class="chip">30-day adherence <strong>${a30.pct}%</strong></span>
      <span class="chip">Streak <strong>${streak}</strong> day(s)</span>
      <span class="chip">Best <strong>${best}</strong></span>
    `;
  }

  updateMedsBanner();

  if(medsTimerInterval) clearInterval(medsTimerInterval);
  tickMedsTimer();
  medsTimerInterval = setInterval(tickMedsTimer, 1000);
}

/* ===== Mood logic ===== */
function setMood(val){
  const m = moodFor(TODAY);
  m.mood = val;
  save(LS_MOOD, mood);
  renderMood();
  renderWeeklyReview();
  renderAll(); // so Focus Lane can react
  notifyLocalChanged();
}
function saveMoodExtras(){
  const m = moodFor(TODAY);
  const e = document.getElementById('energySel').value;
  const tags = document.getElementById('moodTags').value
    .split(',')
    .map(x=>x.trim())
    .filter(Boolean)
    .slice(0,12);
  const note = document.getElementById('moodNote').value.trim().slice(0,280);

  m.energy = e || '';
  m.tags = tags;
  m.note = note;

  save(LS_MOOD, mood);
  renderMood();
  renderWeeklyReview();
  notifyLocalChanged();
}
function moodLabel(n){
  return ({1:'Low',2:'Okay',3:'Good',4:'Great'}[n] || '‚Äî');
}
function renderMood(){
  const m = moodFor(TODAY);

  // buttons
  for(let i=1;i<=4;i++){
    const b = document.getElementById('mood'+i);
    if(b) b.classList.toggle('active', m.mood===i);
  }

  // fields
  const eSel = document.getElementById('energySel');
  if(eSel) eSel.value = m.energy || '';

  const tIn = document.getElementById('moodTags');
  if(tIn) tIn.value = (m.tags||[]).join(', ');

  const note = document.getElementById('moodNote');
  if(note) note.value = m.note || '';

  // chip
  const chip = document.getElementById('moodChip');
  if(chip){
    if(!m.mood) chip.textContent = 'No mood logged';
    else chip.innerHTML = `Mood <strong>${moodLabel(m.mood)}</strong>`;
  }

  // 7-day mini bars
  const mini = document.getElementById('moodMini');
  if(mini){
    mini.innerHTML='';
    for(let i=6;i>=0;i--){
      const d = isoOffset(TODAY, -i);
      const md = mood[d]?.mood || 0;
      const h = md ? (md/4)*100 : 8;
      const el = document.createElement('div');
      el.className='mood-bar';
      el.innerHTML = `<small>${d.slice(5)}</small><i style="height:${h}%;opacity:${md?1:0.15};"></i>`;
      mini.appendChild(el);
    }
  }
}

/* ===== Task rules (keyword -> prio/diff) ===== */
function addRule(){
  const k = (document.getElementById('ruleKeyword').value||'').trim().toLowerCase();
  const p = document.getElementById('rulePrio').value;
  const d = parseInt(document.getElementById('ruleDiff').value,10);

  if(!k) return alert('Enter a keyword.');
  rules[k] = { prio:p, diff: clamp(d,1,5) };
  save(LS_RULES, rules);
  document.getElementById('ruleKeyword').value='';
  renderRules();
  notifyLocalChanged();
}
function delRule(k){
  if(!confirm(`Remove rule for "${k}"?`)) return;
  delete rules[k];
  save(LS_RULES, rules);
  renderRules();
  notifyLocalChanged();
}
function seedDefaultRules(){
  const defaults = {
    'cook':{prio:'high',diff:3},
    'study':{prio:'high',diff:4},
    'assignment':{prio:'high',diff:4},
    'email':{prio:'med',diff:2},
    'laundry':{prio:'med',diff:2},
    'clean':{prio:'med',diff:3},
    'gym':{prio:'high',diff:3},
    'groceries':{prio:'med',diff:2},
    'pay':{prio:'high',diff:3}
  };
  rules = {...defaults, ...rules};
  save(LS_RULES, rules);
  renderRules();
  alert('Default rules added.');
}
function renderRules(){
  const wrap = document.getElementById('rulesList');
  if(!wrap) return;

  const keys = Object.keys(rules||{}).sort();
  if(!keys.length){
    wrap.innerHTML = 'No rules yet.';
    return;
  }
  wrap.innerHTML = keys.map(k=>{
    const r = rules[k];
    return `<div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin:8px 0;">
      <div><strong style="color:#fff;">${escapeHtml(k)}</strong> ‚Üí prio <strong>${r.prio}</strong>, diff <strong>D${r.diff}</strong></div>
      <button class="btn-danger" onclick="delRule('${escapeHtml(k)}')">Remove</button>
    </div>`;
  }).join('');
}
function applyRulesToInput(text){
  const t = (text||'').toLowerCase();
  let matched=null;
  for(const k of Object.keys(rules||{})){
    if(!k) continue;
    if(t.includes(k)){
      matched = { key:k, ...rules[k] };
      break;
    }
  }
  return matched;
}
function onTaskTyping(text){
  tpRenderDatalist(text);
  const hit = applyRulesToInput(text);
  if(hit){
    document.getElementById('prioSelect').value = hit.prio;
    document.getElementById('diffSelect').value = String(hit.diff);
  }
}

/* ===== Tasks ===== */
function addTask(){
  const name = document.getElementById('taskInput').value.trim();
  if(!name) return;

  const prio = document.getElementById('prioSelect').value;
  const diff = clamp(parseInt(document.getElementById('diffSelect').value,10)||3,1,5);
  const estVal = document.getElementById('estSelect').value;
  const est = estVal ? parseInt(estVal,10) : null;

  const t = {
    id:'t_'+Math.random().toString(36).slice(2,9),
    name,
    prio,
    diff,
    est,
    done:false,
    stars:0,
    createdAt:new Date().toISOString(),
    carried:false
  };

  ensureDay(viewing).unshift(t);
  save(LS_KEY, days);
  document.getElementById('taskInput').value='';
  renderAll();
  notifyLocalChanged();
}

function toggleDone(dayKey,id,el){
  const t = ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.done = el.checked;
  t.timeCompleted = t.done ? new Date().toISOString() : '';
  save(LS_KEY, days);
  renderAll();
  notifyLocalChanged();
}

function setStars(dayKey,id,s){
  const t = ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.stars = s;
  save(LS_KEY, days);
  renderAll();
  notifyLocalChanged();
}

function editTask(dayKey,id){
  const t = ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  const name = prompt('Edit task', t.name);
  if(name===null) return;

  const prio = prompt('Priority (low/med/high)', t.prio) || t.prio;
  const diff = prompt('Difficulty (1-5)', String(t.diff||3)) || String(t.diff||3);
  const est  = prompt('Estimate minutes (blank for none)', t.est?String(t.est):'') ?? (t.est?String(t.est):'');

  t.name = name.trim();
  t.prio = ['low','med','high'].includes(prio) ? prio : t.prio;
  t.diff = clamp(parseInt(diff,10)||t.diff||3, 1, 5);
  t.est  = (String(est).trim()==='') ? null : clamp(parseInt(est,10)||t.est||0, 0, 600);

  save(LS_KEY, days);
  renderAll();
  notifyLocalChanged();
}

function delTask(dayKey,id){
  if(!confirm('Delete task?')) return;
  days[dayKey] = ensureDay(dayKey).filter(x=>x.id!==id);
  save(LS_KEY, days);
  renderAll();
  notifyLocalChanged();
}

function clearCompleted(){
  days[viewing] = ensureDay(viewing).filter(x=>!x.done);
  save(LS_KEY, days);
  renderAll();
  notifyLocalChanged();
}

function shiftDay(d){
  viewing = isoOffset(viewing, d);
  renderAll();
}

/* Carry-over */
function manualCarryOver(){
  const list=ensureDay(viewing);
  const incomplete=list.filter(t=>!t.done);
  if(!incomplete.length){ alert('No incomplete tasks to carry.'); return; }
  const tomorrowIso = isoOffset(viewing, +1);
  ensureDay(tomorrowIso).unshift(...incomplete.map(t=>({
    ...t,
    id:'t_'+Math.random().toString(36).slice(2,9),
    createdAt:new Date().toISOString(),
    carried:true
  })));
  days[viewing] = list.filter(t=>t.done);
  save(LS_KEY,days);
  renderAll();
  notifyLocalChanged();
  alert(`Carried ${incomplete.length} task(s) to ${fmtHumanDate(tomorrowIso)}.`);
}

function autoCarryForwardIfNewDay(){
  const lastOpen = load(LS_LAST_OPEN,'');
  const today = isoToday();
  let carried = 0;

  if(lastOpen && lastOpen !== today){
    const prev = ensureDay(lastOpen).filter(t=>!t.done);
    if(prev.length){
      const dest = ensureDay(today);
      dest.unshift(...prev.map(t=>({
        ...t,
        id:'t_'+Math.random().toString(36).slice(2,9),
        createdAt:new Date().toISOString(),
        carried:true
      })));
      days[lastOpen] = ensureDay(lastOpen).filter(t=>t.done);
      carried = prev.length;
      save(LS_KEY, days);
    }
  }

  save(LS_LAST_OPEN, today);
  localStorage.setItem(LS_LAST_CARRY_COUNT, String(carried));
}

/* ===== Focus Lane ===== */
function toggleFocusLane(){
  const on = document.getElementById('focusToggle').checked;
  localStorage.setItem(LS_FOCUS, on ? '1':'0');
  renderFocusLane();
}
function focusIsOn(){
  return (localStorage.getItem(LS_FOCUS)||'0')==='1';
}
function scoreTask(t, moodLevel, medsMissingCount){
  // Base from priority
  const p = (t.prio==='high') ? 3 : (t.prio==='med') ? 2 : 1;
  const stars = t.stars||0;
  const carried = t.carried ? 1 : 0;

  // Difficulty penalty if mood is low
  const diff = clamp(t.diff||3,1,5);
  const moodPenalty = (moodLevel===1) ? (diff>=4?2:diff>=3?1:0) : (moodLevel===2 ? (diff>=5?1:0) : 0);

  // Meds missing: gently boost ‚Äúeasier wins‚Äù by penalizing high difficulty
  const medsPenalty = (medsMissingCount>0) ? (diff>=4?1:0) : 0;

  return (p*10) + (stars*3) + (carried*4) - (moodPenalty*5) - (medsPenalty*4) - (diff*1);
}
function renderFocusLane(){
  const wrap = document.getElementById('focusList');
  const toggle = document.getElementById('focusToggle');
  if(!wrap || !toggle) return;

  toggle.checked = focusIsOn();

  const list = ensureDay(viewing);
  const moodLevel = moodFor(TODAY).mood || 0;
  const m = medsFor(TODAY);
  const medsMissingCount = (!m.morning?1:0)+(!m.night?1:0);

  let items = list.filter(t=>!t.done);
  if(focusIsOn()){
    items = items.filter(t=> t.prio==='high' || (t.stars||0)>0 || !!t.carried );
  }

  items.sort((a,b)=> scoreTask(b,moodLevel,medsMissingCount) - scoreTask(a,moodLevel,medsMissingCount));
  items = items.slice(0, (moodLevel===1 ? 3 : 6));

  wrap.classList.toggle('active', true);
  wrap.innerHTML = items.length ? items.map(t=>{
    const prioc = t.prio==='low'?'p-low':t.prio==='med'?'p-med':'p-high';
    const est = t.est ? `${t.est}m` : '‚Äî';
    return `
      <div class="focus-item">
        <div>
          <strong>${escapeHtml(t.name)}</strong>
          <small>
            <span class="priority ${prioc}">${t.prio}</span>
            <span class="pill">D${t.diff||3}</span>
            <span class="pill">Est ${est}</span>
            ${t.carried?'<span class="pill">carried</span>':''}
          </small>
        </div>
        <button class="btn-ghost" onclick="jumpToTask('${t.id}')">Open</button>
      </div>
    `;
  }).join('') : `<div class="muted" style="padding:8px 2px;">No focus tasks yet.</div>`;
}
function jumpToTask(id){
  // switch to tasks and scroll to task row
  showTab('tasks');
  setTimeout(()=>{
    const el = document.querySelector(`[data-task-id="${id}"]`);
    if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
  }, 100);
}

/* ===== Render Tasks ===== */
function renderAll(){
  document.getElementById('todayLabel').textContent = fmtHumanDate(TODAY);
  document.getElementById('viewingLabel').textContent = fmtHumanDate(viewing);

  const list = ensureDay(viewing);
  const ul = document.getElementById('taskList');
  if(ul){
    ul.innerHTML='';
    list.forEach(t=>{
      const li=document.createElement('li');
      li.className='task';
      li.dataset.taskId = t.id;

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=!!t.done;
      cb.onchange=e=>toggleDone(viewing,t.id,e.target);

      const center=document.createElement('div');
      const prioc=t.prio==='low'?'p-low':t.prio==='med'?'p-med':'p-high';
      const metaParts = [];
      metaParts.push(`<span class="priority ${prioc}">${t.prio}</span>`);
      metaParts.push(`<span class="pill">D${t.diff||3}</span>`);
      metaParts.push(`<span class="pill">Est ${t.est?t.est+'m':'‚Äî'}</span>`);
      if(t.carried) metaParts.push(`<span class="pill">carried</span>`);
      if(t.done && t.timeCompleted) metaParts.push(`<span class="pill">‚úî ${fmtDateTime(t.timeCompleted)}</span>`);

      center.innerHTML = `
        <div class="name" style="${t.done?'text-decoration:line-through;opacity:.7':''}">${escapeHtml(t.name)}</div>
        <div class="subline">${metaParts.join(' ')}</div>
      `;

      const stars=document.createElement('div');
      stars.className='stars';
      for(let s=1;s<=3;s++){
        const b=document.createElement('button');
        b.textContent='‚òÖ';
        if((t.stars||0)>=s) b.classList.add('on');
        b.onclick=()=>setStars(viewing,t.id,(s===(t.stars||0))?0:s);
        stars.appendChild(b);
      }

      const act=document.createElement('div');
      act.className='actions';
      const e=document.createElement('button'); e.textContent='‚úé'; e.onclick=()=>editTask(viewing,t.id);
      const d=document.createElement('button'); d.textContent='√ó'; d.className='del'; d.onclick=()=>delTask(viewing,t.id);
      act.appendChild(e); act.appendChild(d);

      li.appendChild(cb);
      li.appendChild(center);
      li.appendChild(stars);
      li.appendChild(act);
      ul.appendChild(li);
    });
  }

  const total=list.length;
  const done=list.filter(x=>x.done).length;
  const pct=total?Math.round(done/total*100):0;

  const q=list.filter(x=>x.done).reduce((a,b)=>a+(b.stars||0),0);
  const qPct=done?Math.round((q/(done*3))*100):0;

  document.getElementById('doneSummary').textContent = `${done} / ${total} tasks done (${pct}%)`;
  document.getElementById('qualitySummary').textContent = `Quality ${qPct}%`;
  document.getElementById('kpiText').textContent = `${done} / ${total} done (${pct}%) ¬∑ Quality ${qPct}%`;

  renderMeds();
  renderMood();
  renderFocusLane();
  tpRenderDatalist(document.getElementById('taskInput')?.value || '');
}

/* ===== Weekly Review ===== */
function renderWeeklyReview(){
  const wkM = document.getElementById('wkMedsChip');
  const wkMood = document.getElementById('wkMoodChip');
  const wkTasks = document.getElementById('wkTasksChip');
  const wkInsight = document.getElementById('wkInsight');

  const a7 = medsAdherenceWindow(7);
  if(wkM) wkM.innerHTML = `Meds: <strong>${a7.pct}%</strong> (7d)`;

  // mood avg
  let sum=0, cnt=0;
  for(let i=0;i<7;i++){
    const d = isoOffset(TODAY, -i);
    const v = mood[d]?.mood || 0;
    if(v){ sum+=v; cnt++; }
  }
  const avg = cnt ? (sum/cnt) : 0;
  if(wkMood) wkMood.innerHTML = `Mood avg: <strong>${avg?avg.toFixed(1):'‚Äî'}</strong>`;

  // tasks
  let tTotal=0, tDone=0;
  for(let i=0;i<7;i++){
    const d = isoOffset(TODAY, -i);
    const arr = days[d]||[];
    tTotal += arr.length;
    tDone  += arr.filter(x=>x.done).length;
  }
  const tpct = tTotal ? Math.round((tDone/tTotal)*100) : 0;
  if(wkTasks) wkTasks.innerHTML = `Tasks: <strong>${tpct}%</strong> (7d)`;

  // gentle insight
  if(wkInsight){
    let msg = `This week: meds adherence ${a7.pct}%, task completion ${tpct}%.`;
    if(a7.pct>=85) msg += ` Strong consistency on meds.`;
    else if(a7.pct>0) msg += ` Consider aiming for small consistency wins on meds.`;
    else msg += ` Start with logging one dose per day ‚Äî build the habit.`;
    if(avg && avg<=2) msg += ` Mood looks a bit heavy ‚Äî Focus Lane will keep suggestions smaller.`;
    wkInsight.textContent = msg;
  }
}

/* ===== History ===== */
function renderHistory(){
  const wrap=document.getElementById('histList'); if(!wrap) return;
  const q=(document.getElementById('histSearch').value||'').trim().toLowerCase();
  const spanSel=document.getElementById('histSpan').value;

  let keys=Object.keys(days||{});

  if(spanSel!=='all'){
    const span=parseInt(spanSel,10);
    const min=new Date(); min.setDate(min.getDate()-span);
    keys=keys.filter(k=>new Date(k)>=min);
  }

  keys.sort((a,b)=>new Date(b)-new Date(a));

  if(q){
    keys=keys.filter(k=>{
      if(k.includes(q)) return true;
      const arr=days[k]||[];
      return arr.some(t=>(t.name||'').toLowerCase().includes(q));
    });
  }

  wrap.innerHTML='';
  if(!keys.length){
    wrap.innerHTML='<div class="muted">No history found.</div>';
    return;
  }

  keys.forEach(k=>{
    const arr=days[k]||[];
    const total=arr.length;
    const done=arr.filter(t=>t.done).length;
    const pct=total?Math.round(done/total*100):0;

    const qsum=arr.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
    const qPct=done?Math.round((qsum/(done*3))*100):0;

    const md = medsFor(k);
    const medsTxt = `${md.morning?'üåÖ':'‚Äî'} ${md.night?'üåô':'‚Äî'}`;
    const mv = mood[k]?.mood || 0;

    const row=document.createElement('div');
    row.className='hist-row';

    const left=document.createElement('div');
    left.innerHTML=`
      <div style="font-weight:900">${fmtHumanDate(k)}</div>
      <div class="meta">${done}/${total} done ‚Ä¢ ${pct}% ¬∑ Quality ${qPct}%</div>
      <div class="meta">Meds: ${medsTxt} ¬∑ Mood: ${mv?moodLabel(mv):'‚Äî'}</div>
    `;

    const right=document.createElement('div');
    const btn=document.createElement('button');
    btn.textContent='Open';
    btn.onclick=()=>{ viewing=k; showTab('tasks'); renderAll(); };
    right.appendChild(btn);

    row.appendChild(left);
    row.appendChild(right);
    wrap.appendChild(row);
  });
}

/* ===== Backup / Restore ===== */
(function(){
  function buildBackupPayload(){
    const dump={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(/^tp_/.test(k)) dump[k]=localStorage.getItem(k);
    }
    dump[LS_KEY] = JSON.stringify(days||{});
    dump[LS_MEDS]= JSON.stringify(meds||{});
    dump[LS_MOOD]= JSON.stringify(mood||{});
    dump[LS_RULES]=JSON.stringify(rules||{});
    dump[LS_SYNC]= localStorage.getItem(LS_SYNC)||'';
    dump[LS_TAB]= localStorage.getItem(LS_TAB)||'tasks';

    return { app:'taskpulse', schema:TP_SCHEMA, exportedAt:new Date().toISOString(), dump };
  }

  window.tpDownloadBackup=function(){
    try{
      const payload=buildBackupPayload();
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='taskpulse_backup.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      localStorage.setItem(LS_LAST_BACKUP, new Date().toLocaleString());
      tpUpdateLastBackupLabel();
      setStatus('Backup downloaded.');
    }catch(e){
      console.error('[TaskPulse] Backup failed:',e);
      setStatus('Backup failed: '+e.message);
      alert('Backup failed: '+e.message);
    }
  };

  const fi=document.getElementById('tpRestoreFile');
  if(fi){
    fi.addEventListener('change',async e=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const text=await f.text();
        const data=JSON.parse(text);
        if(data && data.dump){
          Object.entries(data.dump).forEach(([k,v])=>{ if(/^tp_/.test(k)) localStorage.setItem(k,v); });
        }
        setStatus('Restore complete. Reloading‚Ä¶');
        setTimeout(()=>location.reload(),600);
      }catch(err){
        console.error('[TaskPulse] Restore failed:',err);
        setStatus('Restore failed: '+err.message);
        alert('Restore failed: '+err.message);
      }finally{ e.target.value=''; }
    });
  }

  function setStatus(msg){
    const el=document.getElementById('tpBackupStatus');
    if(el) el.textContent=msg;
  }
})();
function tpUpdateLastBackupLabel(){
  const el=document.getElementById('tpLastBackup');
  if(!el) return;
  el.textContent=`Last backup: ${localStorage.getItem(LS_LAST_BACKUP)||'none'}`;
}

/* ===== Predictive suggestions ===== */
var SUGGEST_MAX=10;
function tpCollectTaskStats(){
  const stats=new Map();
  for(const dk of Object.keys(days||{})){
    for(const t of (days[dk]||[])){
      const nm=(t.name||'').trim();
      if(!nm) continue;
      const key=nm.toLowerCase();
      const last=new Date(t.createdAt||t.timeCompleted||0).getTime();
      if(!stats.has(key)) stats.set(key,{name:nm,count:0,last:0});
      const s=stats.get(key);
      s.count++; s.last=Math.max(s.last,last);
    }
  }
  return stats;
}
function tpRankedNames(stats){
  return Array.from(stats.values())
    .sort((a,b)=>(b.count-a.count)||(b.last-a.last))
    .map(v=>v.name);
}
function tpGetSuggestions(prefix){
  const ranked=tpRankedNames(tpCollectTaskStats());
  const p=(prefix||'').trim().toLowerCase();
  if(!p) return ranked.slice(0,SUGGEST_MAX);
  const pref=ranked.filter(n=>n.toLowerCase().startsWith(p));
  if(pref.length>=SUGGEST_MAX) return pref.slice(0,SUGGEST_MAX);
  const rest=ranked.filter(n=>!n.toLowerCase().startsWith(p)&&n.toLowerCase().includes(p));
  return [...pref,...rest].slice(0,SUGGEST_MAX);
}
function tpRenderDatalist(prefix){
  const dl=document.getElementById('taskSuggestions'); if(!dl) return;
  const opts=tpGetSuggestions(prefix);
  dl.innerHTML=opts.map(n=>`<option value="${escapeHtml(n)}"></option>`).join('');
}

/* ===== Firebase Sync ===== */
const TP_UID=(localStorage.getItem('tp_uid')||(()=>{const v='u_'+Math.random().toString(36).slice(2,10);localStorage.setItem('tp_uid',v);return v;})());
let syncRef=null, syncOff=null, writeTimer=null;

/* Paste your Firebase config here (from Firebase console -> Project settings -> web app config) */
const TP_FIREBASE_CONFIG = null; // <-- replace with { apiKey: "...", authDomain: "...", databaseURL:"...", projectId:"...", ... }

function isFirebaseReady(){
  return (window.firebase && firebase.apps && firebase.apps.length);
}
function initFirebase(){
  if(!TP_FIREBASE_CONFIG) return false;
  try{
    if(!firebase.apps.length) firebase.initializeApp(TP_FIREBASE_CONFIG);
    return true;
  }catch(e){
    console.warn('[Sync] Firebase init failed', e);
    return false;
  }
}
function setSyncBadge(text,kind=''){
  const el=document.getElementById('syncState');
  if(!el) return;
  el.textContent=text;
  el.className='badge '+(kind||'');
}

const SYNC_PREFIX='grp-';
function randomCode(len=6){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out='';
  for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}
function ensureSyncCode(){
  let code=localStorage.getItem(LS_SYNC);
  if(!code || !code.trim()){
    code=SYNC_PREFIX+randomCode(6);
    localStorage.setItem(LS_SYNC,code);
  }
  const inp=document.getElementById('syncCode');
  if(inp) inp.value=code;

  // init + attach if config exists
  if(initFirebase() && isFirebaseReady()) attachSync(code);
  else setSyncBadge('Local-only');
}
function copySyncCode(){
  const i=document.getElementById('syncCode');
  if(!i||!i.value) return;
  navigator.clipboard.writeText(i.value).then(()=>alert('Sync code copied'));
}
function newSyncCode(){
  if(!confirm('Generate a new sync code? Devices must use this new code.')) return;
  const code=SYNC_PREFIX+randomCode(6);
  localStorage.setItem(LS_SYNC,code);
  const inp=document.getElementById('syncCode'); if(inp) inp.value=code;
  if(typeof syncOff==='function' && syncOff) syncOff();
  if(initFirebase() && isFirebaseReady()) attachSync(code);
  alert('New code generated.');
}
function saveSyncCode(){
  const i=document.getElementById('syncCode'); if(!i) return;
  const v=(i.value||'').trim(); if(!v) return;
  localStorage.setItem(LS_SYNC,v);
  alert('Sync code saved.');
  if(typeof syncOff==='function' && syncOff) syncOff();
  if(initFirebase() && isFirebaseReady()) attachSync(v);
}

function notifyLocalChanged(){
  debouncedPush();
}
function debouncedPush(){
  if(!syncRef) return;
  clearTimeout(writeTimer);
  writeTimer=setTimeout(()=>{
    syncRef.set({
      schema: TP_SCHEMA,
      days,
      meds,
      mood,
      rules,
      _meta:{ by:TP_UID, at:Date.now() }
    }).catch((e)=>{
      console.warn('[Sync] write failed', e);
      setSyncBadge('Sync error','warn');
    });
  }, 260);
}

function attachSync(code){
  if(!isFirebaseReady()){
    setSyncBadge('Local-only');
    return;
  }
  if(!code) return;

  if(syncOff){ syncOff(); syncOff=null; }

  syncRef=firebase.database().ref(`taskpulse/${code}`);
  setSyncBadge(`Sync: ${code}`,'good');

  syncRef.get().then(snap=>{
    const val=snap.val();
    if(val && (val.days||val.meds||val.mood||val.rules)){
      // merge strategy: prefer remote if it has newer _meta.at, else keep local
      const remoteAt = val._meta?.at || 0;
      const localAt = load('tp_last_sync_at',0) || 0;

      if(remoteAt > localAt){
        days = val.days || days;
        meds = val.meds || meds;
        mood = val.mood || mood;
        rules = val.rules || rules;

        baseSave(LS_KEY, days);
        baseSave(LS_MEDS, meds);
        baseSave(LS_MOOD, mood);
        baseSave(LS_RULES, rules);

        save('tp_last_sync_at', remoteAt);
        renderAll();
        renderHistory();
        renderWeeklyReview();
      }else{
        debouncedPush();
      }
    }else{
      debouncedPush();
    }
  }).catch(e=>{
    console.warn('[Sync] read failed', e);
    setSyncBadge('Sync error','warn');
  });

  const handler = syncRef.on('value', snap=>{
    const val=snap.val();
    if(!val) return;
    if(val._meta && val._meta.by===TP_UID) return;

    // accept remote
    if(val.days){ days = val.days; baseSave(LS_KEY,days); }
    if(val.meds){ meds = val.meds; baseSave(LS_MEDS,meds); }
    if(val.mood){ mood = val.mood; baseSave(LS_MOOD,mood); }
    if(val.rules){ rules = val.rules; baseSave(LS_RULES,rules); }

    const at = val._meta?.at || Date.now();
    save('tp_last_sync_at', at);

    renderAll();
    renderHistory();
    renderWeeklyReview();
  });

  syncOff = ()=>syncRef.off('value', handler);
}

/* override save so changes push */
const prevSave = save;
save = function(k,v){
  prevSave(k,v);
  if(k===LS_KEY || k===LS_MEDS || k===LS_MOOD || k===LS_RULES){
    notifyLocalChanged();
  }
};

/* ===== Service worker ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Task Pulse Money</title>
<meta name="theme-color" content="#0f111a" />

<style>
  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;
  }
  body{
    background:#0f111a;
    background-image:
      radial-gradient(circle at 20% 20%, rgba(80,90,255,.16) 0%, rgba(15,17,26,0) 60%),
      radial-gradient(circle at 80% 30%, rgba(255,0,128,.12) 0%, rgba(15,17,26,0) 60%);
    background-size:100% 100%;
    color:#e9e9ef;
    max-width:480px;
    margin:0 auto;
  }

  main{
    padding:16px 16px 120px;
  }

  header{
    background:radial-gradient(circle at 20% 20%,#2f324a 0%,#0f111a 60%);
    color:#fff;
    padding:16px;
    border-bottom:1px solid rgba(255,255,255,0.07);
    border-radius:0 0 20px 20px;
    box-shadow:
      0 30px 80px rgba(0,0,0,.8),
      0 0 60px rgba(89,102,255,.4);
  }
  .app-label{
    font-size:.8rem;
    color:#bdbdfd;
    font-weight:500;
  }
  .today-date{
    color:#fff;
    font-size:1.1rem;
    font-weight:600;
    line-height:1.3;
  }

  .build-banner{
    text-align:center;
    font-size:.7rem;
    color:#9ca0ff;
    padding:4px 0 12px;
    text-shadow:0 0 8px rgba(89,102,255,.6);
  }

  .card{
    background:#ffffff;
    border:1px solid rgba(255,255,255,0.6);
    border-radius:16px;
    box-shadow:0 20px 50px rgba(0,0,0,.5);
    padding:16px;
    margin-bottom:20px;
    color:#1a1a1a;
  }

  .section-headline{
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    row-gap:8px;
    margin-bottom:12px;
  }
  .section-title{
    font-size:1rem;
    font-weight:600;
    color:#111;
  }
  .section-sub{
    font-size:.8rem;
    color:#444;
    text-align:right;
    min-width:max-content;
    padding-left:8px;
    line-height:1.3;
  }
  .small{
    font-size:.8rem;
    color:#666;
  }

  /* table-ish rows */
  .spend-header-row,
  .spend-row,
  .spend-total-row{
    display:grid;
    grid-template-columns: 1fr auto auto;
    grid-template-areas:
      "left middle right";
    align-items:flex-start;
    column-gap:8px;
    font-size:.8rem;
    line-height:1.4;
    word-break:break-word;
  }

  /* nicer header bar */
  .spend-header-row{
    background:#f5f5f7;
    border:1px solid #d9d9de;
    border-radius:10px;
    padding:10px 12px;
    font-weight:600;
    color:#111;
    margin-bottom:8px;
  }

  .spend-row{
    padding:8px 0;
    border-bottom:1px solid #e4e4e7;
  }

  .spend-total-row{
    border-bottom:none;
    font-weight:600;
    color:#c00000;
    padding-top:12px;
  }

  .spend-left    { grid-area:left; }
  .spend-middle  { grid-area:middle; text-align:right; }
  .spend-right   { grid-area:right; text-align:right; min-width:70px; }

  /* chips */
  .chip-item{
    background:#e8f8d8;
    border-radius:4px;
    padding:2px 4px;
    font-weight:600;
    color:#1a1a1a;
    display:inline-block;
    max-width:100%;
  }
  .chip-shop{
    background:#fff8d6;
    border-radius:4px;
    padding:2px 4px;
    color:#4a3b00;
    display:inline-block;
    max-width:100%;
    margin-top:2px;
  }
  .chip-type{
    background:#d5efff;
    border-radius:4px;
    padding:2px 4px;
    color:#003049;
    display:inline-block;
    max-width:100%;
    margin-top:2px;
  }
  .chip-payer{
    background:#f2d9f6;
    border-radius:4px;
    padding:2px 4px;
    color:#4a125c;
    display:inline-block;
    max-width:100%;
    margin-top:2px;
  }

  .spend-meta{
    font-size:.7rem;
    color:#444;
    line-height:1.3;
  }

  .spend-amount{
    font-size:.8rem;
    font-weight:600;
    color:#1a1a1a;
  }

  .spend-total-row .spend-right{
    color:#c00000;
  }

  /* Add Spend form */
  .input-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:8px;
  }
  .input-field,
  .input-select{
    flex:1;
    min-width:120px;
    border:1px solid #cfcfd3;
    border-radius:10px;
    padding:10px 12px;
    font-size:.9rem;
    outline:none;
    background:#fff;
    color:#1a1a1a;
  }
  .input-small{
    width:90px;
    flex:0 0 auto;
  }
  .add-btn{
    border-radius:10px;
    background:#1d1d1f;
    color:#fff;
    border:1px solid #1d1d1f;
    font-size:.85rem;
    font-weight:500;
    padding:10px 14px;
    min-width:70px;
  }
  .clear-btn{
    border-radius:10px;
    background:#fff;
    color:#1d1d1f;
    border:1px solid #cfcfd3;
    font-size:.8rem;
    font-weight:500;
    padding:8px 12px;
    min-width:110px;
    line-height:1.2;
  }

  .history-headline{
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    row-gap:8px;
    margin-bottom:12px;
    align-items:flex-start;
  }
  .history-left .small-top{
    font-size:.8rem;
    color:#444;
    line-height:1.2;
  }
  .history-left .hist-date{
    font-size:.9rem;
    font-weight:600;
    color:#111;
    line-height:1.3;
  }
  .history-nav{
    display:flex;
    gap:8px;
  }
  .history-nav button{
    background:#fff;
    border:1px solid #cfcfd3;
    color:#1d1d1f;
    padding:8px 10px;
    border-radius:10px;
    font-weight:500;
    min-width:44px;
    min-height:36px;
    line-height:1;
    font-size:1rem;
  }

  /* summary card (7 days from viewingDate) */
  .summary-grid{
    width:100%;
    font-size:.8rem;
    line-height:1.4;
    border-top:1px solid #e4e4e7;
    margin-top:8px;
    padding-top:8px;
  }

  .summary-block-title{
    font-size:.75rem;
    font-weight:600;
    color:#111;
    margin:12px 0 4px;
    line-height:1.2;
    display:flex;
    justify-content:space-between;
  }
  .summary-block-title span{
    font-weight:400;
    font-size:.7rem;
    color:#666;
  }

  .summary-row{
    display:flex;
    justify-content:space-between;
    border-radius:8px;
    align-items:flex-start;
    padding:4px 8px;
    margin-bottom:4px;
  }

  /* colored summary rows */
  .sum-type{
    background:#d5efff;
    color:#003049;
  }
  .sum-payer{
    background:#f2d9f6;
    color:#4a125c;
  }

  .sum-left{
    font-weight:500;
  }
  .sum-right{
    min-width:90px;
    text-align:right;
    font-weight:500;
  }

  .summary-total{
    color:#c00000;
    font-weight:600;
    padding:6px 0 0;
    margin-top:8px;
    display:flex;
    justify-content:space-between;
  }
  .summary-total .sum-right{
    color:#c00000;
  }

  /* Report cards (7-day + month) */

  .report-header{
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    row-gap:8px;
    margin-bottom:12px;
    align-items:flex-start;
  }
  .report-left{
    display:flex;
    flex-direction:column;
    line-height:1.3;
  }
  .report-title{
    color:#111;
    font-size:1rem;
    font-weight:600;
  }
  .report-range{
    color:#666;
    font-size:.75rem;
  }
  .report-right{
    text-align:right;
    min-width:max-content;
    color:#111;
    font-size:.8rem;
  }
  .report-input{
    border:1px solid #cfcfd3;
    border-radius:8px;
    padding:6px 8px;
    font-size:.8rem;
    background:#fff;
    color:#1a1a1a;
  }

  .report-block-title{
    font-size:.75rem;
    font-weight:600;
    color:#111;
    margin:16px 0 4px;
    line-height:1.2;
    display:flex;
    justify-content:space-between;
  }
  .report-block-title span{
    font-weight:400;
    font-size:.7rem;
    color:#666;
  }

  .highlight-block{
    background:#f5f5f7;
    border:1px solid #d9d9de;
    border-radius:10px;
    padding:8px 12px;
    font-size:.75rem;
    line-height:1.4;
    color:#1a1a1a;
    margin-top:8px;
  }
  .highlight-line{
    display:flex;
    justify-content:space-between;
    margin-bottom:4px;
  }
  .highlight-left{
    font-weight:500;
    color:#111;
  }
  .highlight-right{
    font-weight:500;
    text-align:right;
    min-width:90px;
    color:#111;
  }
</style>
</head>
<body>

<header>
  <div class="app-label">Spending</div>
  <div class="today-date" id="headerToday">--</div>
</header>

<div class="build-banner">
  Task Pulse Money · offline v5 · Powered by Daryl G
</div>

<main>

  <!-- CARD 1: Today's / Viewing Day Entries -->
  <section class="card" id="dayCard">
    <div class="section-headline">
      <div class="section-title">Spending (this day)</div>
      <div class="section-sub" id="dayTotalLine">R 0.00</div>
    </div>

    <!-- header bar -->
    <div class="spend-header-row">
      <div class="spend-left">item · shop · type · payer</div>
      <div class="spend-middle">date · time</div>
      <div class="spend-right">amount</div>
    </div>

    <!-- day rows -->
    <div id="spendList"></div>

    <!-- footer total -->
    <div class="spend-total-row">
      <div class="spend-left"></div>
      <div class="spend-middle"></div>
      <div class="spend-right" id="spendTotalRed">R 0.00</div>
    </div>
  </section>

  <!-- CARD 2: Add Spend -->
  <section class="card">
    <div class="section-headline" style="margin-bottom:8px;">
      <div class="section-title">Add new purchase</div>
      <div class="section-sub" style="font-size:.7rem;line-height:1.3;">
        date/time auto<br/>saved
      </div>
    </div>

    <div class="input-row">
      <input id="newItem"  class="input-field" placeholder="item (what was bought?)" />
      <input id="newShop"  class="input-field" placeholder="shop (bp / food lovers…)" />
    </div>

    <div class="input-row">
      <select id="newType" class="input-select">
        <option value="food">food</option>
        <option value="fuel">fuel</option>
        <option value="clothing">clothing</option>
        <option value="Medicine">Medicine</option>
        <option value="electricity">electricity</option>
      </select>

      <select id="newPayer" class="input-select">
        <option value="presh">presh</option>
        <option value="daryl">daryl</option>
      </select>

      <input id="newAmount" class="input-field input-small" type="number" min="0" step="0.01" placeholder="R" />
    </div>

    <div class="input-row" style="align-items:flex-start;">
      <button id="addSpendBtn" class="add-btn">Add</button>
      <button id="clearDayBtn" class="clear-btn">Clear this day</button>
    </div>

    <div class="small" style="color:#666;">
      • Amount is in Rand (R).<br/>
      • Payer = who paid.<br/>
      • Type = fuel / food / etc.<br/>
      • Shop = where you swiped / bought.<br/>
      • After Add: entry is saved on this device.
    </div>
  </section>

  <!-- CARD 3: Day Navigation -->
  <section class="card">
    <div class="history-headline">
      <div class="history-left">
        <div class="small-top small">Viewing</div>
        <div class="hist-date" id="viewingDateLabel">--</div>
      </div>
      <div class="history-nav">
        <button id="prevDayBtn">◀</button>
        <button id="nextDayBtn">▶</button>
      </div>
    </div>

    <div class="small" id="viewingDayStats" style="color:#444;margin-bottom:8px;">
      0 entries · R 0.00
    </div>
    <div class="small" style="color:#444;">
      Use ◀ ▶ to move through dates. Totals + summary update.
    </div>
  </section>

  <!-- CARD 4: Summary (auto 7-day window from current viewingDate) -->
  <section class="card">
    <div class="section-headline">
      <div class="section-title">Summary</div>
      <div class="section-sub" style="line-height:1.3;text-align:right;">
        <div id="summaryRangeDate">--</div>
        <div style="font-size:.7rem;color:#666;">7 days from view</div>
      </div>
    </div>

    <div class="summary-grid" id="summaryGrid">
      <!-- dynamic -->
    </div>
  </section>

  <!-- CARD 5: 7 Day Report (choose end date) -->
  <section class="card">
    <div class="report-header">
      <div class="report-left">
        <div class="report-title">7 Day Report</div>
        <div class="report-range">Custom 7-day window</div>
      </div>
      <div class="report-right">
        <input id="weekPicker" class="report-input" type="date" />
      </div>
    </div>

    <div class="summary-grid" id="weekReportGrid">
      <!-- dynamic -->
    </div>
  </section>

  <!-- CARD 6: Monthly Report (choose month) -->
  <section class="card">
    <div class="report-header">
      <div class="report-left">
        <div class="report-title">Monthly Report</div>
        <div class="report-range">Full month totals</div>
      </div>
      <div class="report-right">
        <input id="monthPicker" class="report-input" type="month" />
      </div>
    </div>

    <div class="summary-grid" id="monthReportGrid">
      <!-- dynamic -->
    </div>
  </section>

</main>

<script>
/* ========== 0. TIME / DATE HELPERS ========== */
function pad2(n){ return String(n).padStart(2,"0"); }

function todayISO(){
  const d=new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function formatISOasDMY(iso){
  const [y,m,d]=iso.split("-");
  return d+"-"+m+"-"+y;
}
function formatCurrencyR(amount){
  const n = Number(amount||0);
  return "R " + n.toLocaleString("en-ZA", {
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}
function nowTime12h(){
  const d=new Date();
  let h=d.getHours(), m=d.getMinutes();
  const ampm = h>=12 ? "PM":"AM";
  h = (h%12)||12;
  return h+":"+pad2(m)+" "+ampm;
}
function shiftISO(iso, delta){
  const [Y,M,D]=iso.split("-");
  const base=new Date(Number(Y),Number(M)-1,Number(D));
  base.setDate(base.getDate()+delta);
  return base.getFullYear()+"-"+pad2(base.getMonth()+1)+"-"+pad2(base.getDate());
}
function getISODateNDaysBefore(iso, n){
  return shiftISO(iso, -n);
}

/* ========== 1. STORAGE ========== */
function loadSpends(){
  return JSON.parse(localStorage.getItem("tp_spends")||"[]");
}
function saveSpends(list){
  localStorage.setItem("tp_spends",JSON.stringify(list));
}
/*
Spend shape:
{
  id: "s_abc123",
  item: "chicken",
  shop: "food lovers",
  type: "food",
  payer:"daryl",
  amount: 3500.00,
  date: "2025-10-27",
  time: "6:45 PM"
}
*/
function newSpend({item,shop,type,payer,amount}){
  return {
    id: "s_"+Math.random().toString(36).slice(2,9),
    item,
    shop,
    type,
    payer,
    amount: Number(amount)||0,
    date: todayISO(),
    time: nowTime12h()
  };
}

/* ========== 2. STATE ========== */
let viewingDate = todayISO();

/* ========== 3. CORE ACTIONS ========== */
function addSpend(){
  const itemEl   = document.getElementById("newItem");
  const shopEl   = document.getElementById("newShop");
  const typeEl   = document.getElementById("newType");
  const payerEl  = document.getElementById("newPayer");
  const amtEl    = document.getElementById("newAmount");

  const itemVal  = itemEl.value.trim();
  const shopVal  = shopEl.value.trim();
  const typeVal  = typeEl.value;
  const payerVal = payerEl.value;
  const amtVal   = amtEl.value.trim();

  if(!itemVal || !amtVal){
    return;
  }

  const all = loadSpends();
  all.push(newSpend({
    item:itemVal,
    shop:shopVal,
    type:typeVal,
    payer:payerVal,
    amount:amtVal
  }));
  saveSpends(all);

  itemEl.value="";
  shopEl.value="";
  amtEl.value="";

  viewingDate = todayISO();
  renderAll();
}
function clearDay(){
  const all = loadSpends();
  const keep = all.filter(s=>s.date!==viewingDate);
  saveSpends(keep);
  renderAll();
}
function goPrevDay(){
  viewingDate = shiftISO(viewingDate, -1);
  renderAll();
}
function goNextDay(){
  viewingDate = shiftISO(viewingDate, +1);
  renderAll();
}

/* ========== 4. CALCULATIONS / GROUPING HELPERS ========== */

function inRange(dateIso, startIso, endIso){
  return dateIso >= startIso && dateIso <= endIso;
}

function collectRangeData(startIso, endIso){
  // groups by type, payer, shop for any inclusive [startIso, endIso]
  const all = loadSpends();
  const byType = {};
  const byPayer = {};
  const byShop = {};
  let totalAll = 0;

  for(const s of all){
    if(inRange(s.date, startIso, endIso)){
      const amt = Number(s.amount||0);
      totalAll += amt;

      if(!byType[s.type]) byType[s.type]=0;
      byType[s.type]+=amt;

      if(!byPayer[s.payer]) byPayer[s.payer]=0;
      byPayer[s.payer]+=amt;

      const shopKey = s.shop && s.shop.trim() ? s.shop.trim() : "(no shop)";
      if(!byShop[shopKey]) byShop[shopKey]=0;
      byShop[shopKey]+=amt;
    }
  }

  // find topShop, topType
  let topShopName="", topShopAmt=0;
  Object.keys(byShop).forEach(shop=>{
    if(byShop[shop] > topShopAmt){
      topShopAmt = byShop[shop];
      topShopName = shop;
    }
  });

  let topTypeName="", topTypeAmt=0;
  Object.keys(byType).forEach(t=>{
    if(byType[t] > topTypeAmt){
      topTypeAmt = byType[t];
      topTypeName = t;
    }
  });

  return {
    totalAll,
    byType,
    byPayer,
    byShop,
    topShop:{name:topShopName, amount:topShopAmt},
    topType:{name:topTypeName, amount:topTypeAmt}
  };
}

function get7DaySummaryFromViewing(viewIso){
  // for Card 4: uses viewingDate as end
  const endIso = viewIso;
  const startIso = getISODateNDaysBefore(viewIso,6);
  return collectRangeData(startIso,endIso);
}

function getCustom7DaySummary(endIso){
  // for Card 5: uses user-chosen end date
  const startIso = getISODateNDaysBefore(endIso,6);
  return { ...collectRangeData(startIso,endIso), startIso, endIso };
}

function getMonthSummary(monthStr){
  // monthStr "2025-10"
  // start = first of month, end = last of that month
  if(!monthStr || !monthStr.includes("-")) return null;
  const [Y,M] = monthStr.split("-");
  const startIso = Y+"-"+M+"-01";

  // calc last day of month
  const lastDay = new Date(Number(Y), Number(M), 0).getDate(); // trick: month index 0-based so Number(M) gives next month
  const endIso = Y+"-"+M+"-"+pad2(lastDay);

  return { ...collectRangeData(startIso,endIso), startIso, endIso, monthLabel:monthStr };
}

/* ========== 5. RENDER UI ========== */
function renderHeader(){
  document.getElementById("headerToday").textContent =
    formatISOasDMY(todayISO());
}
function escapeHTML(str){
  return String(str).replace(/[&<>"]/g, c=>{
    const map={"&":"&amp;","<":"&lt;",">":"&gt;"};
    return map[c]||c;
  });
}

function sumAmounts(list){
  return list.reduce((acc,s)=>acc+Number(s.amount||0),0);
}

function getSpendsForDate(dateIso){
  const all = loadSpends();
  return all.filter(s=>s.date===dateIso);
}

function renderDayCard(){
  const listEl  = document.getElementById("spendList");
  const totalEl = document.getElementById("spendTotalRed");
  const lineEl  = document.getElementById("dayTotalLine");

  const dayList = getSpendsForDate(viewingDate);
  const dayTotal = sumAmounts(dayList);

  listEl.innerHTML = dayList.map(s=>{
    return `
      <div class="spend-row">
        <div class="spend-left">
          <div class="chip-item">${escapeHTML(s.item)}</div>
          ${s.shop ? `<div class="chip-shop">${escapeHTML(s.shop)}</div>` : ``}
          <div class="chip-type">${escapeHTML(s.type)}</div>
          <div class="chip-payer">${escapeHTML(s.payer)}</div>
        </div>
        <div class="spend-middle">
          <div>${formatISOasDMY(s.date)}</div>
          <div class="spend-meta">${escapeHTML(s.time)}</div>
        </div>
        <div class="spend-right spend-amount">${formatCurrencyR(s.amount)}</div>
      </div>
    `;
  }).join("");

  totalEl.textContent = formatCurrencyR(dayTotal);
  lineEl.textContent  = formatCurrencyR(dayTotal);
}

function renderViewingCard(){
  const vDateLabel = document.getElementById("viewingDateLabel");
  const statsEl    = document.getElementById("viewingDayStats");

  const dayList = getSpendsForDate(viewingDate);
  const dayTotal = sumAmounts(dayList);

  vDateLabel.textContent = formatISOasDMY(viewingDate);
  statsEl.textContent =
    `${dayList.length} entr${dayList.length===1?"y":"ies"} · ${formatCurrencyR(dayTotal)}`;
}

/* ----- CARD 4: Summary (auto 7 days from viewingDate) ----- */
function renderSummaryCard(){
  const sumData = get7DaySummaryFromViewing(viewingDate);
  const rangeDateEl = document.getElementById("summaryRangeDate");
  const gridEl      = document.getElementById("summaryGrid");

  rangeDateEl.textContent = formatISOasDMY(viewingDate);

  // build "By type", "By payer", total
  let html = "";

  html += `
    <div class="summary-block-title">
      <div>By type</div>
      <span>last 7 days</span>
    </div>
  `;
  Object.keys(sumData.byType).forEach(typeKey=>{
    const val = sumData.byType[typeKey];
    if(val>0){
      html += `
        <div class="summary-row sum-type">
          <div class="sum-left">${escapeHTML(typeKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  html += `
    <div class="summary-block-title" style="margin-top:16px;">
      <div>By payer</div>
      <span>last 7 days</span>
    </div>
  `;
  Object.keys(sumData.byPayer).forEach(payerKey=>{
    const val = sumData.byPayer[payerKey];
    if(val>0){
      html += `
        <div class="summary-row sum-payer">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  html += `
    <div class="summary-total">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(sumData.totalAll)}</div>
    </div>
  `;

  gridEl.innerHTML = html;
}

/* ----- CARD 5: 7 Day Report (user-picked end date) ----- */
function renderWeekReportCard(){
  const picker = document.getElementById("weekPicker");
  let endIso = picker.value;
  if(!endIso){
    // default to today if empty
    endIso = todayISO();
    picker.value = endIso;
  }
  const data = getCustom7DaySummary(endIso);
  const gridEl = document.getElementById("weekReportGrid");

  const startDMY = formatISOasDMY(data.startIso);
  const endDMY   = formatISOasDMY(data.endIso);

  let html = "";

  // Total
  html += `
    <div class="report-block-title">
      <div>Totals</div>
      <span>${startDMY} → ${endDMY}</span>
    </div>
    <div class="summary-total" style="margin-top:4px;">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(data.totalAll)}</div>
    </div>
  `;

  // By type
  html += `
    <div class="report-block-title">
      <div>By type</div>
      <span>7 days</span>
    </div>
  `;
  Object.keys(data.byType).forEach(typeKey=>{
    const val = data.byType[typeKey];
    if(val>0){
      html += `
        <div class="summary-row sum-type">
          <div class="sum-left">${escapeHTML(typeKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // By payer
  html += `
    <div class="report-block-title">
      <div>By payer</div>
      <span>7 days</span>
    </div>
  `;
  Object.keys(data.byPayer).forEach(payerKey=>{
    const val = data.byPayer[payerKey];
    if(val>0){
      html += `
        <div class="summary-row sum-payer">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // Highlights block (top shop / top type)
  html += `
    <div class="report-block-title">
      <div>Highlights</div>
      <span>7 days</span>
    </div>
    <div class="highlight-block">
      <div class="highlight-line">
        <div class="highlight-left">🏪 Top shop</div>
        <div class="highlight-right">${escapeHTML(data.topShop.name || "-")} — ${formatCurrencyR(data.topShop.amount||0)}</div>
      </div>
      <div class="highlight-line">
        <div class="highlight-left">🧾 Top type</div>
        <div class="highlight-right">${escapeHTML(data.topType.name || "-")} — ${formatCurrencyR(data.topType.amount||0)}</div>
      </div>
    </div>
  `;

  gridEl.innerHTML = html;
}

/* ----- CARD 6: Monthly Report (user-picked month) ----- */
function renderMonthReportCard(){
  const picker = document.getElementById("monthPicker");
  let monthVal = picker.value;
  if(!monthVal){
    // default to current year-month
    const d = new Date();
    const ym = d.getFullYear()+"-"+pad2(d.getMonth()+1);
    monthVal = ym;
    picker.value = ym;
  }

  const data = getMonthSummary(monthVal);
  const gridEl = document.getElementById("monthReportGrid");

  if(!data){
    gridEl.innerHTML = "<div class='small' style='color:#444;'>No data</div>";
    return;
  }

  const startDMY = formatISOasDMY(data.startIso);
  const endDMY   = formatISOasDMY(data.endIso);

  let html = "";

  // Total
  html += `
    <div class="report-block-title">
      <div>Totals</div>
      <span>${startDMY} → ${endDMY}</span>
    </div>
    <div class="summary-total" style="margin-top:4px;">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(data.totalAll)}</div>
    </div>
  `;

  // By type
  html += `
    <div class="report-block-title">
      <div>By type</div>
      <span>this month</span>
    </div>
  `;
  Object.keys(data.byType).forEach(typeKey=>{
    const val = data.byType[typeKey];
    if(val>0){
      html += `
        <div class="summary-row sum-type">
          <div class="sum-left">${escapeHTML(typeKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // By payer
  html += `
    <div class="report-block-title">
      <div>By payer</div>
      <span>this month</span>
    </div>
  `;
  Object.keys(data.byPayer).forEach(payerKey=>{
    const val = data.byPayer[payerKey];
    if(val>0){
      html += `
        <div class="summary-row sum-payer">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // Highlights
  html += `
    <div class="report-block-title">
      <div>Highlights</div>
      <span>this month</span>
    </div>
    <div class="highlight-block">
      <div class="highlight-line">
        <div class="highlight-left">🏪 Top shop</div>
        <div class="highlight-right">${escapeHTML(data.topShop.name || "-")} — ${formatCurrencyR(data.topShop.amount||0)}</div>
      </div>
      <div class="highlight-line">
        <div class="highlight-left">🧾 Top type</div>
        <div class="highlight-right">${escapeHTML(data.topType.name || "-")} — ${formatCurrencyR(data.topType.amount||0)}</div>
      </div>
    </div>
  `;

  gridEl.innerHTML = html;
}

/* ========== 6. RENDER ALL ========== */
function renderAll(){
  renderHeader();
  renderDayCard();
  renderViewingCard();
  renderSummaryCard();
  renderWeekReportCard();
  renderMonthReportCard();
}

/* ========== 7. EVENT BINDINGS ========== */
function bindUI(){
  document.getElementById("addSpendBtn").onclick = addSpend;
  document.getElementById("clearDayBtn").onclick = clearDay;
  document.getElementById("prevDayBtn").onclick = goPrevDay;
  document.getElementById("nextDayBtn").onclick = goNextDay;

  document.getElementById("weekPicker").onchange = renderWeekReportCard;
  document.getElementById("monthPicker").onchange = renderMonthReportCard;
}

/* ========== 8. INIT ========== */
function init(){
  bindUI();
  renderAll();
}
init();
</script>

</body>
 </html>

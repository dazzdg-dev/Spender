<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Pulse Smart V8.5</title>

<link rel="preload" as="image" href="taskpulse-splash-hex.jpeg" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon-192.png" sizes="192x192" />
<meta name="theme-color" content="#0f111a" />

<style>
  :root{
    --bg:#050611;
    --card:#141725;
    --ink:#e9ecf5;
    --muted:#a7b0cf;
    --line:#262a3c;
    --pill:#1b2440;
    --pad:14px;
    --radius:16px;
    --tap:50px;
    --fs:16px;
    --warn:#ffcc66;
    --good:#76e0a6;
    --bad:#ff8ea1;
    --accent:#27b7ff;
    --accent-soft:#193b66;
  }
  @media (max-width:480px){
    :root{ --pad:12px; --radius:14px; --tap:56px; --fs:17px }
  }
  *{
    box-sizing:border-box;
    -webkit-tap-highlight-color:transparent;
    margin:0;
    padding:0;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);
    font-size:var(--fs);
    background:radial-gradient(circle at top,#1d2440 0,#050611 55%);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:12px;
  }

  /* Shell */
  .shell{
    max-width:900px;
    width:100%;
    background:#050814;
    border-radius:18px;
    box-shadow:0 18px 60px rgba(0,0,0,.7);
    padding:16px 18px 14px;
    border:1px solid #20263c;
  }
  .wrap{
    max-width:820px;
    margin:0 auto;
    padding:4px var(--pad) calc(40px + env(safe-area-inset-bottom));
  }

  /* Header / brand */
  .hero-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo-pill{
    width:42px;
    height:42px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 20%,#5fffd0 0,#0fd0ff 40%,#0b1428 80%);
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 0 18px rgba(0,255,213,.5);
    font-weight:800;
    letter-spacing:.03em;
    color:white;
  }
  .brand-title{ font-size:18px;font-weight:700; }
  .brand-sub{ font-size:11px;color:var(--muted); }
  .top-right{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:4px;
    font-size:11px;
    color:var(--muted);
  }
  .badge{
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #3b425d;
    font-size:11px;
    background:var(--pill);
  }
  .badge.good{border-color:#3bd47a;color:#7fffb3;}
  .badge.warn{border-color:#e7a74c;color:#ffd78a;}

  /* KPI pill */
  .kpi-pill{
    margin:6px 0 10px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    color:var(--muted);
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:rgba(10,15,30,.9);
  }

  /* Tabs */
  .tabs{
    position:sticky;
    top:0;
    z-index:50;
    padding:4px 0 4px;
    background:linear-gradient(180deg, rgba(5,8,20,.98) 0%, rgba(5,8,20,.88) 70%, rgba(5,8,20,0) 100%);
    backdrop-filter:saturate(130%) blur(4px);
    margin-bottom:6px;
  }
  .tabbar{
    display:flex;
    gap:6px;
    overflow:auto;
    padding-bottom:4px;
  }
  .tabbar button{
    flex:1;
    min-width:110px;
    padding:7px 10px;
    font-size:13px;
    border-radius:999px;
    border:1px solid transparent;
    background:var(--pill);
    color:var(--muted);
    cursor:pointer;
    font-weight:500;
    white-space:nowrap;
  }
  .tabbar button.active{
    background:linear-gradient(135deg,#27b7ff,#4df2ff);
    color:#04101b;
    font-weight:600;
    box-shadow:0 0 18px rgba(39,183,255,.6);
  }
  .tabpage{display:none;}
  .tabpage.active{display:block;}

  /* Cards & layout */
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:10px 10px 8px;
    margin:8px 0;
    box-shadow:0 6px 30px rgba(0,0,0,.25);
  }
  .row{
    display:flex;
    gap:6px;
    align-items:center;
    flex-wrap:wrap;
  }
  input,select,button{
    border-radius:999px;
    border:1px solid var(--line);
    background:#050814;
    color:var(--ink);
    padding:7px 11px;
    min-height:var(--tap);
    font-size:13px;
  }
  input[type=text]{flex:1 1 200px; min-width:0;}
  button.primary{
    background:linear-gradient(135deg,#27b7ff,#4df2ff);
    color:#04101b;
    border:none;
    font-weight:600;
    cursor:pointer;
    white-space:nowrap;
  }
  button{cursor:pointer;}
  .btn-ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted);
  }
  .btn-danger{
    background:rgba(224,82,100,.12);
    border:1px solid #e05264;
    color:#ff9da8;
  }
  .muted{color:var(--muted);}
  .list{list-style:none;margin:0;padding:0;}

  /* Task rows */
  .task{
    display:grid;
    grid-template-columns:auto 1fr auto auto;
    gap:8px;
    align-items:center;
    padding:7px 8px;
    margin-bottom:4px;
    border-radius:10px;
    background:#101528;
    border:1px solid #1e2234;
  }
  .task input[type="checkbox"]{width:15px;height:15px;}
  .task div:first-of-type{
    min-height:40px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .priority{
    display:inline-block;
    border-radius:999px;
    padding:1px 6px;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.04em;
    margin-top:4px;
  }
  .p-low{background:#16352b;color:#7af3b1;}
  .p-med{background:#3a321b;color:#ffe08a;}
  .p-high{background:#3d1b25;color:#ff9ab2;}
  .stars button{
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:14px;
    opacity:.4;
  }
  .stars button.on{
    opacity:1;
    text-shadow:0 0 8px rgba(255,215,120,.7);
  }
  .actions{display:flex;gap:4px;}
  .actions button{
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:15px;
    padding:0 2px;
    color:#99a4d2;
  }
  .actions .del{color:#ff9ba9;}
  .task .meta{margin-top:4px;font-size:12px;color:#9fb0d0;opacity:.9;}

  .sum{
    display:flex;
    justify-content:space-between;
    padding:7px 10px;
    background:#0e1324;
    border:1px solid var(--line);
    border-radius:12px;
    font-size:12px;
    margin-top:6px;
  }
  .nav{display:flex;gap:4px;justify-content:flex-end;}

  /* Focus lane */
  .focus-lane{
    margin-top:8px;
    padding:6px 8px;
    border-radius:12px;
    background:#0b1022;
    border:1px dashed #2c3a68;
    font-size:12px;
  }
  .focus-chips{
    margin-top:4px;
    display:flex;
    flex-wrap:wrap;
    gap:4px;
  }
  .focus-chip{
    padding:2px 8px;
    border-radius:999px;
    background:#182447;
    font-size:11px;
    max-width:160px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .focus-toggle.on{color:#7fffb3;text-shadow:0 0 6px rgba(127,255,179,.7);}

  /* History list */
  .hist-row{
    border-radius:12px;
    border:1px solid var(--line);
    padding:10px 12px;
    margin:6px 0;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#101528;
  }
  .hist-row .meta{color:#9fb0d0;font-size:12px;margin-top:4px;}
  .hist-row button{
    border-radius:999px;
    padding:6px 10px;
  }

  .tag-chips{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin:4px 0 8px;
    font-size:11px;
  }
  .tag-chip{
    padding:2px 8px;
    border-radius:999px;
    background:#101528;
    border:1px solid #27324b;
    cursor:pointer;
  }

  /* Banners */
  #carryWarn{
    display:none;
    margin:6px 0 0 0;
    padding:6px 9px;
    border-radius:9px;
    background:#221525;
    border:1px solid #b26ad5;
    font-size:11px;
    color:#f0d5ff;
  }
  #medsReminder{
    display:none;
    margin:8px 0 0 0;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #3e4a13;
    background:#161d07;
    color:#d8ee8a;
    font-weight:600;
  }
  #medsReminder small{
    display:block;
    color:#b9c66a;
    font-weight:400;
    margin-top:4px;
  }
  #medsReminder button{
    margin-left:6px;
    border-radius:9px;
    border:1px solid #ff9d3b;
    background:#2a1b0d;
    color:#ffd8a2;
    padding:6px 14px;
    font-size:0.86rem;
    box-shadow:0 0 10px rgba(255,140,40,0.35);
  }

  /* Meds card */
  .meds-card{padding:10px 10px 10px;}
  .meds-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
  }
  .meds-head-title{font-size:14px;font-weight:600;}
  .meds-head-tag{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    background:#101828;
    color:#9fd2ff;
    border:1px solid #294064;
  }
  .meds-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:6px;
  }
  .meds-btn{
    flex:1 1 150px;
    min-width:0;
    border-radius:14px;
    padding:10px 14px;
    background:#060817;
    border:1px solid #2b3653;
    text-align:left;
    display:flex;
    flex-direction:column;
    gap:2px;
    color:#e9f2ff;
  }
  .meds-btn-title{
    font-size:13px;
    font-weight:600;
    color:#f5f8ff;
  }
  .meds-btn-sub{
    font-size:11px;
    color:#a7b8d9;
  }
  .meds-btn-note{
    font-size:11px;
    color:#d0fff1;
    margin-top:2px;
  }
  .meds-btn-taken{
    background:linear-gradient(90deg,#09d9a3 0%, #027b60 45%, #021621 100%);
    border-color:#35f3b4;
    box-shadow:0 0 16px rgba(53,243,180,0.45);
    color:#f6fffe;
  }
  .meds-btn-taken .meds-btn-title{color:#ffffff;}

  .meds-streak{
    margin-top:4px;
    font-size:11px;
    color:#a7b0cf;
  }
  .meds-week{
    margin-top:6px;
    display:flex;
    gap:4px;
  }
  .meds-week-day{
    flex:1;
    padding:4px 0;
    border-radius:8px;
    text-align:center;
    font-size:10px;
    background:#060817;
    border:1px solid #27324b;
    color:#8fa3d7;
  }
  .meds-week-day.full{
    background:linear-gradient(135deg,#09d9a3,#027b60);
    color:#ffffff;
    border-color:#35f3b4;
  }
  .meds-week-day.partial{
    border-color:#e7a74c;
    color:#ffe08a;
  }
  .meds-week-day.missed{
    opacity:.35;
  }
  .meds-week-day span{display:block;}
  .mw-label{font-size:9px;}
  .mw-dot{font-size:12px;}

  .meds-refill{
    margin-top:6px;
    font-size:11px;
    color:#a7b0cf;
  }
  .meds-refill-warn{
    color:#ffd78a;
  }

  /* Splash */
  #splash{
    position:fixed;
    inset:0;
    z-index:9999;
    background:radial-gradient(circle at top,#2b2220 0,#050611 60%);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  #splash::before{
    content:"";
    position:absolute;
    inset:0;
    background:url('taskpulse-splash-hex.jpeg') center/cover no-repeat;
    filter:contrast(105%) saturate(110%);
    transform:scale(1.05);
    animation:zoomfade 2.0s ease forwards;
    opacity:.95;
  }
  #splash .label{
    position:relative;
    text-align:center;
    color:#fff;
    text-shadow:0 6px 26px rgba(0,0,0,.55);
    animation:textin .6s ease both .15s;
  }
  #splash h2{margin:0;font-size:32px;letter-spacing:.5px;}
  #splash .sub{opacity:.85;margin-top:8px;font-size:13px;}
  #splash .foot{
    position:absolute;
    bottom:18px;
    width:100%;
    text-align:center;
    font-size:13px;
    opacity:.85;
  }
  @keyframes zoomfade{
    0%{opacity:0;transform:scale(1.08)}
    15%{opacity:1}
    100%{opacity:0;transform:scale(1)}
  }
  @keyframes textin{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:1;transform:translateY(0)}
  }
  .hide-splash #splash{display:none;}

  @media (max-width:600px){
    .shell{padding:14px 10px 12px;}
    .hero-header{flex-direction:column;align-items:flex-start;gap:8px;}
    .top-right{align-items:flex-start;}
    .task{grid-template-columns:auto 1fr auto;}
    .task .actions{grid-column:1 / -1;justify-content:flex-end;}
  }
</style>
</head>
<body>

<!-- Splash -->
<div id="splash"><div class="label">
  <h2>Task Pulse Smart</h2>
  <div class="sub">Focus ¬∑ Sync ¬∑ Achieve (V8.5)</div>
  <div class="foot">Powered by Daryl G</div>
</div></div>

<div class="shell">
  <div class="wrap">
    <header class="hero-header">
      <div class="brand">
        <div class="logo-pill">TP</div>
        <div>
          <div class="brand-title">Task Pulse Smart</div>
          <div class="brand-sub">Daily focus advisor ¬∑ V8.5 Insight</div>
        </div>
      </div>
      <div class="top-right">
        <div id="syncState" class="badge">Local-only</div>
        <div id="tpLastBackup">Last backup: none</div>
      </div>
    </header>

    <div class="kpi-pill" id="kpiRow">
      <span>0 / 0 done (0%) ¬∑ Quality 0%</span>
      <span id="todayLabel" class="muted">‚Äî</span>
    </div>

    <div id="carryWarn"></div>
    <div id="medsReminder"></div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tabbar">
        <button id="btnTabTasks" class="active" onclick="showTab('tasks')">Tasks</button>
        <button id="btnTabHistory" onclick="showTab('history')">History</button>
        <button id="btnTabSettings" onclick="showTab('settings')">Settings</button>
      </div>
    </div>

    <!-- TAB: TASKS -->
    <div id="tab-tasks" class="tabpage active">
      <section class="card meds-card" id="medsCard">
        <div class="meds-head">
          <div class="meds-head-title">Medication ‚Äî Today</div>
          <div class="meds-head-tag">TLE routine</div>
        </div>
        <div class="meds-row">
          <button id="btnMedsDay" class="meds-btn" onclick="toggleMeds('day')" title="Log/undo Day dose"></button>
          <button id="btnMedsNight" class="meds-btn" onclick="toggleMeds('night')" title="Log/undo Night dose"></button>
        </div>
        <div class="muted" id="medsMeta"></div>
        <div id="medsStreak" class="meds-streak"></div>
        <div id="medsWeek" class="meds-week"></div>
        <div id="medsRefill" class="meds-refill"></div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px">Today's Tasks</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="taskInput" type="text" placeholder="Add task‚Ä¶ (use #tag)" list="taskSuggestions" autocomplete="off" />
          <datalist id="taskSuggestions"></datalist>
          <select id="prioSelect">
            <option value="low">low</option>
            <option value="med" selected>med</option>
            <option value="high">high</option>
          </select>
          <button class="primary" onclick="addTask()">Add</button>
        </div>
        <div class="row">
          <button class="btn-ghost" onclick="clearCompleted()">Clear completed</button>
          <button class="btn-ghost" onclick="manualCarryOver()" title="Move all incomplete tasks to tomorrow">Carry incomplete ‚Üí tomorrow</button>
        </div>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Viewing</div>
            <div id="viewingLabel" style="font-weight:600">‚Äî</div>
          </div>
          <div class="nav">
            <button class="btn-ghost" onclick="shiftDay(-1)">‚óÄ</button>
            <button class="btn-ghost" onclick="shiftDay(+1)">‚ñ∂</button>
          </div>
        </div>

        <div id="focusLane" class="focus-lane" style="display:none;"></div>

        <ul id="taskList" class="list" style="margin-top:8px"></ul>
        <div class="sum">
          <div id="doneSummary">0 / 0 tasks done (0%)</div>
          <div id="qualitySummary">Quality 0%</div>
        </div>
      </section>
    </div>

    <!-- TAB: HISTORY -->
    <div id="tab-history" class="tabpage">
      <section class="card" id="weeklyReviewCard">
        <h3 style="margin:0 0 6px">Weekly Review</h3>
        <div id="weeklyReviewBody" class="muted" style="font-size:13px;">
          Not enough data yet.
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 4px">History</h3>
        <div id="tagChips" class="tag-chips"></div>
        <div class="row" style="gap:6px;margin-bottom:6px">
          <input id="histSearch" type="text" placeholder="Search text, #tag or YYYY-MM-DD‚Ä¶" oninput="renderHistory()" />
          <select id="histSpan" onchange="renderHistory()">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="all">All</option>
          </select>
        </div>
        <div id="histList"></div>
      </section>
    </div>

    <!-- TAB: SETTINGS -->
    <div id="tab-settings" class="tabpage">
      <section class="card">
        <h3 style="margin:0 0 8px">Sync</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="syncCode" placeholder="Sync code" style="flex:1 1 260px" />
          <button class="btn-ghost" onclick="copySyncCode()">Copy</button>
          <button class="btn-ghost" onclick="newSyncCode()">New code</button>
          <button class="primary" onclick="saveSyncCode()">Save</button>
        </div>
        <div class="muted" id="syncHint" style="font-size:12px;">
          Open this site on your second device and use the same code. Sync uses Firebase Realtime Database.
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px">Meds Settings</h3>
        <div class="row" style="margin-bottom:6px">
          <input id="medsStockInput" type="number" min="0" placeholder="Tablets on hand" style="flex:1 1 140px" />
          <input id="medsDailyInput" type="number" min="1" placeholder="Doses per day" style="flex:1 1 120px" />
          <button class="primary" onclick="saveMedsSettings()">Save</button>
        </div>
        <div id="medsSettingsHint" class="muted" style="font-size:12px;">
          Used to estimate refill timing based on your Day/Night schedule.
        </div>
      </section>

      <section class="card" id="backupCard">
        <h3 style="margin:0 0 8px">Backup &amp; Restore</h3>
        <div class="row" style="align-items:center">
          <button id="btnBackup" class="primary" onclick="tpDownloadBackup()">‚≠≥ Download Backup</button>
          <input id="tpRestoreFile" type="file" accept="application/json" style="display:none" />
          <button id="btnRestore" class="btn-ghost" onclick="document.getElementById('tpRestoreFile').click()">‚≠± Import Backup</button>
        </div>
        <div id="tpBackupStatus" class="muted" style="margin-top:6px;font-size:12px;"></div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px">Safe Reset</h3>
        <p class="muted" style="font-size:12px;margin-bottom:6px;">
          Clear all tasks, meds and settings on this device. Backups you downloaded stay safe.
        </p>
        <button class="btn-danger" onclick="tpSafeReset()">Reset app (keep backups)</button>
      </section>
    </div>
  </div>

  <footer style="margin-top:4px;text-align:center;font-size:11px;color:var(--muted);">
    Task Pulse Smart V8.5 ¬∑ Powered by D Gounder
  </footer>
</div>

<!-- Firebase (optional ‚Äì same as before) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
/* Paste your firebaseConfig + initializeApp if using sync */
</script>

<script>
/* ========= Core state & schema ========= */
const LS_KEY='tp_days_v1', LS_SYNC='tp_sync_code', LS_TAB='tp_last_tab';
const LS_LAST_OPEN='tp_last_open', LS_LAST_CARRY_COUNT='tp_last_carry_count';
const LS_MEDS='tp_meds_v1';
const LS_MEDS_STOCK='tp_meds_stock', LS_MEDS_DAILY='tp_meds_daily';
const SCHEMA_KEY='tp_schema_version', SCHEMA_VERSION=2;

/* simple schema bump hook (no migration needed yet) */
(function(){
  const current=parseInt(localStorage.getItem(SCHEMA_KEY)||'1',10);
  if(current < SCHEMA_VERSION){
    // placeholder for future migrations
  }
  localStorage.setItem(SCHEMA_KEY,String(SCHEMA_VERSION));
})();

const TODAY=isoToday();
let days=load(LS_KEY,{});
let meds=load(LS_MEDS,{});
let viewing=TODAY;

/* Auto-save safety net */
let tpDirty=false;
function baseSave(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
let save=function(k,v){
  try{ baseSave(k,v); tpDirty=false; }catch(e){ console.warn('save failed, will retry', e); tpDirty=true; }
};
setInterval(()=>{ if(!tpDirty) return; try{ baseSave(LS_KEY, days); tpDirty=false; }catch(e){} },4000);
window.addEventListener('beforeunload',()=>{ try{ baseSave(LS_KEY,days); baseSave(LS_MEDS,meds);}catch{} });

window.addEventListener('load',()=>{ setTimeout(()=>document.body.classList.add('hide-splash'),1800); });

document.addEventListener('DOMContentLoaded',()=>{
  const last=localStorage.getItem(LS_TAB)||'tasks'; showTab(last);
  ensureSyncCode();
  tpUpdateLastBackupLabel(); tpRenderDatalist('');
  renderHistory();
  renderWeeklyReview();
  showCarryBannerIfAny();
  renderMeds();
  updateMedsReminder();
  scheduleMedsReminders();

  const stockInp=document.getElementById('medsStockInput');
  const dailyInp=document.getElementById('medsDailyInput');
  if(stockInp) stockInp.value = localStorage.getItem(LS_MEDS_STOCK) || '';
  if(dailyInp) dailyInp.value = localStorage.getItem(LS_MEDS_DAILY) || '';
});

autoCarryForwardIfNewDay();
renderAll();

/* Tabs */
function showTab(id){
  document.querySelectorAll('.tabpage').forEach(el=>el.classList.remove('active'));
  const page=document.getElementById('tab-'+id);
  if(page) page.classList.add('active');

  document.querySelectorAll('.tabbar button').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('btnTab'+cap(id));
  if(btn) btn.classList.add('active');

  localStorage.setItem(LS_TAB,id);
  if(id==='history'){ renderHistory(); renderWeeklyReview(); }
}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

/* ===== Medication ===== */
function medsFor(iso){
  if(!meds[iso]) meds[iso]={day:'',night:'',dayNote:'',nightNote:''};
  meds[iso].dayNote  = meds[iso].dayNote  || '';
  meds[iso].nightNote= meds[iso].nightNote|| '';
  return meds[iso];
}
function toggleMeds(which){
  const m=medsFor(TODAY);
  const noteKey = which==='day' ? 'dayNote' : 'nightNote';

  if(m[which]){
    if(!confirm('Unmark this dose as taken?')) return;
    m[which]='';
    m[noteKey]='';
  }else{
    m[which]=new Date().toISOString();
    const existing=m[noteKey] || '';
    const msg = existing ? 'Edit note for this dose (optional):' : 'Add note for this dose (optional):';
    const note=prompt(msg, existing);
    if(note!==null) m[noteKey]=note.trim();
  }
  baseSave(LS_MEDS, meds);
  renderMeds();
  updateMedsReminder();
  scheduleMedsReminders();
  notifyLocalChanged();
}
function renderMeds(){
  const m = medsFor(TODAY);
  const btnDay   = document.getElementById('btnMedsDay');
  const btnNight = document.getElementById('btnMedsNight');
  const meta     = document.getElementById('medsMeta');

  if(btnDay){
    const isTaken = !!m.day;
    const timeTxt = isTaken ? `üåÖ Day ¬∑ ${fmtDateTime(m.day)}` : 'Tap to log your Day dose';
    const note    = m.dayNote;
    const noteLine = note ? `<span class="meds-btn-note">üìù ${escapeHtml(note.slice(0,50))}${note.length>50?'‚Ä¶':''}</span>` : '';
    btnDay.className = 'meds-btn' + (isTaken ? ' meds-btn-taken' : '');
    btnDay.innerHTML = `
      <span class="meds-btn-title">üåÖ Day dose</span>
      <span class="meds-btn-sub">${timeTxt}</span>
      ${noteLine}
    `;
  }

  if(btnNight){
    const isTaken = !!m.night;
    const timeTxt = isTaken ? `üåô Night ¬∑ ${fmtDateTime(m.night)}` : 'Tap to log your Night dose';
    const note    = m.nightNote;
    const noteLine = note ? `<span class="meds-btn-note">üìù ${escapeHtml(note.slice(0,50))}${note.length>50?'‚Ä¶':''}</span>` : '';
    btnNight.className = 'meds-btn' + (isTaken ? ' meds-btn-taken' : '');
    btnNight.innerHTML = `
      <span class="meds-btn-title">üåô Night dose</span>
      <span class="meds-btn-sub">${timeTxt}</span>
      ${noteLine}
    `;
  }

  if(meta){
    const a = m.day   ? `Day: ${fmtDateTime(m.day)}`   : 'Day: ‚Äî';
    const b = m.night ? `Night: ${fmtDateTime(m.night)}` : 'Night: ‚Äî';
    meta.textContent = `${a}   ‚Ä¢   ${b}`;
  }

  renderMedsExtras();
}

/* streak + chart + refill */
function computeMedsStreaks(){
  const keys = Object.keys(meds||{}).sort();
  let best=0, current=0;
  let prevIso=null;
  keys.forEach(k=>{
    const m=medsFor(k);
    const full = !!(m.day && m.night);
    if(!full){ current=0; prevIso=null; return; }
    if(prevIso){
      const expected = isoOffset(prevIso,1);
      if(k===expected) current++; else current=1;
    }else current=1;
    prevIso=k;
    if(current>best) best=current;
  });
  return {current,best};
}
function renderMedsExtras(){
  const streakEl=document.getElementById('medsStreak');
  const weekEl=document.getElementById('medsWeek');
  const refillEl=document.getElementById('medsRefill');

  if(streakEl){
    const {current,best}=computeMedsStreaks();
    streakEl.textContent = `Adherence streak: ${current||0} day(s) ‚Ä¢ Best: ${best||0}`;
  }

  if(weekEl){
    const blocks=[];
    for(let i=6;i>=0;i--){
      const iso=isoOffset(TODAY,-i);
      const m=medsFor(iso);
      let state='missed';
      if(m.day || m.night) state='partial';
      if(m.day && m.night) state='full';
      const label=new Date(iso).toLocaleDateString(undefined,{weekday:'short'});
      const symbol = state==='full'?'‚óè‚óè':state==='partial'?'‚óè':'‚Äì';
      blocks.push(`<div class="meds-week-day ${state}">
        <span class="mw-label">${label}</span>
        <span class="mw-dot">${symbol}</span>
      </div>`);
    }
    weekEl.innerHTML=blocks.join('');
  }

  if(refillEl){
    const stock = parseInt(localStorage.getItem(LS_MEDS_STOCK)||'0',10);
    const daily = parseInt(localStorage.getItem(LS_MEDS_DAILY)||'0',10);
    if(stock>0 && daily>0){
      const daysLeft = Math.floor(stock/daily);
      refillEl.textContent = `Approx. ${daysLeft} day(s) of meds remaining.`;
      refillEl.className = 'meds-refill' + (daysLeft<=7?' meds-refill-warn':'');
    }else{
      refillEl.textContent = 'Refill: set tablets on hand & doses/day in Settings to get refill nudges.';
      refillEl.className='meds-refill';
    }
  }

  updateMedsReminder();
  scheduleMedsReminders();
}

var medsTimers=[];
function clearMedsTimers(){
  if(!Array.isArray(medsTimers)) medsTimers=[];
  medsTimers.forEach(id=>clearTimeout(id));
  medsTimers=[];
}
function computeMedsSchedule(){
  const mToday = medsFor(TODAY);
  if (!mToday.day) return { nightDueAt: null, nextDayPreAt: null };
  const dayLoggedAt = new Date(mToday.day);
  const nightDueAt = new Date(dayLoggedAt.getTime() + 12*60*60*1000);
  const nextDaySameTime = new Date(dayLoggedAt.getTime() + 24*60*60*1000);
  const nextDayPreAt = new Date(nextDaySameTime.getTime() - 5*60*1000);
  return { nightDueAt, nextDayPreAt };
}
function scheduleMedsReminders(){
  clearMedsTimers();
  const bar = document.getElementById('medsReminder'); if (!bar) return;

  function show(msg, sub){
    bar.innerHTML = `${msg}${sub ? `<small>${sub}</small>` : ''} <button onclick="scrollToMeds()">Go to Meds</button>`;
    bar.style.display = 'block';
  }

  const { nightDueAt, nextDayPreAt } = computeMedsSchedule();
  const now = new Date();
  const mNow = medsFor(TODAY);

  if (nightDueAt && !mNow.night) {
    if (now >= nightDueAt) {
      show('Reminder: Night dose due', 'It‚Äôs been ~12 hours since your Day dose.');
    } else {
      medsTimers.push(setTimeout(()=>{
        const m = medsFor(isoToday());
        if (!m.night) show('Reminder: Night dose due', 'It‚Äôs been ~12 hours since your Day dose.');
      }, nightDueAt - now));
    }
  }

  if (nextDayPreAt) {
    if (now >= nextDayPreAt && !mNow.day) {
      show('Reminder: Day dose in ~5 min', 'This is your usual time based on yesterday.');
    } else {
      medsTimers.push(setTimeout(()=>{
        const m = medsFor(isoToday());
        if (!m.day) show('Reminder: Day dose in ~5 min', 'This is your usual time based on yesterday.');
      }, Math.max(0, nextDayPreAt - now)));
    }
  }
}
function updateMedsReminder(){
  const bar = document.getElementById('medsReminder'); if(!bar) return;
  const m = medsFor(TODAY);
  const missing = []; if(!m.day) missing.push('Day dose'); if(!m.night) missing.push('Night dose');
  const hasTimedMsg = bar.style.display === 'block' && bar.querySelector('button');
  if (missing.length === 0){ bar.style.display='none'; bar.innerHTML=''; return; }
  if (!hasTimedMsg){
    const msg = `Reminder: ${missing.join(' & ')} not logged`;
    bar.innerHTML = `${msg}<small></small> <button onclick="scrollToMeds()">Go to Meds</button>`;
    bar.style.display='block';
  }
}
function scrollToMeds(){ const el=document.getElementById('medsCard'); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); }

/* ===== Tasks & Focus ===== */
function parseTags(name){
  const tags=[];
  name.split(/\s+/).forEach(w=>{
    if(w.startsWith('#') && w.length>1){
      tags.push(w.slice(1).toLowerCase());
    }
  });
  return tags;
}
function addTask(){
  const input=document.getElementById('taskInput');
  const name=(input.value||'').trim();
  const prio=document.getElementById('prioSelect').value;
  if(!name) return;
  const t={
    id:'t_'+Math.random().toString(36).slice(2,8),
    name,
    prio,
    done:false,
    stars:0,
    createdAt:new Date().toISOString(),
    focus:false,
    tags:parseTags(name)
  };
  ensureDay(viewing).unshift(t);
  save(LS_KEY,days);
  input.value='';
  renderAll(); tpRenderDatalist('');
}
function toggleDone(dayKey,id,el){
  const t=ensureDay(dayKey).find(x=>x.id===id); if(!t) return;
  t.done=el.checked;
  t.timeCompleted=t.done?new Date().toISOString():'';
  save(LS_KEY,days); renderAll();
}
function setStars(dayKey,id,s){
  const t=ensureDay(dayKey).find(x=>x.id===id); if(!t) return;
  t.stars=s;
  save(LS_KEY,days); renderAll();
}
function toggleFocus(dayKey,id){
  const t=ensureDay(dayKey).find(x=>x.id===id); if(!t) return;
  t.focus=!t.focus;
  save(LS_KEY,days); renderAll();
}
function editTask(dayKey,id){
  const t=ensureDay(dayKey).find(x=>x.id===id); if(!t) return;
  const name=prompt('Edit task',t.name);
  if(name===null) return;
  const prio=prompt('Priority (low/med/high)', t.prio)||t.prio;
  t.name=name.trim();
  t.prio=['low','med','high'].includes(prio)?prio:t.prio;
  t.tags=parseTags(t.name);
  save(LS_KEY,days); renderAll();
}
function delTask(dayKey,id){
  if(!confirm('Delete task?')) return;
  days[dayKey]=ensureDay(dayKey).filter(x=>x.id!==id);
  save(LS_KEY,days); renderAll();
}
function clearCompleted(){ days[viewing]=ensureDay(viewing).filter(x=>!x.done); save(LS_KEY,days); renderAll(); }
function shiftDay(d){ const dt=new Date(viewing); dt.setDate(dt.getDate()+d); viewing=dt.toISOString().slice(0,10); renderAll(); }

/* Manual + auto carry */
function manualCarryOver(){
  const list=ensureDay(viewing); const incomplete=list.filter(t=>!t.done);
  if(!incomplete.length){ alert('No incomplete tasks to carry.'); return; }
  const tomorrowIso = isoOffset(viewing, +1);
  ensureDay(tomorrowIso).unshift(...incomplete.map(t=>({
    ...t, id:'t_'+Math.random().toString(36).slice(2,8), createdAt:new Date().toISOString()
  })));
  days[viewing] = list.filter(t=>t.done);
  save(LS_KEY,days); renderAll();
  alert(`Carried ${incomplete.length} task(s) to ${fmtHumanDate(tomorrowIso)}.`);
}
function autoCarryForwardIfNewDay(){
  const lastOpen = load(LS_LAST_OPEN,'');
  const today = isoToday();
  let carried = 0;
  if(lastOpen && lastOpen !== today){
    const prev = ensureDay(lastOpen).filter(t=>!t.done);
    if(prev.length){
      const dest = ensureDay(today);
      dest.unshift(...prev.map(t=>({...t, id:'t_'+Math.random().toString(36).slice(2,8), createdAt:new Date().toISOString()})));
      days[lastOpen] = ensureDay(lastOpen).filter(t=>t.done);
      carried = prev.length; save(LS_KEY, days);
    }
  }
  save(LS_LAST_OPEN, today);
  localStorage.setItem(LS_LAST_CARRY_COUNT, String(carried));
}
function showCarryBannerIfAny(){
  const cnt = parseInt(localStorage.getItem(LS_LAST_CARRY_COUNT)||'0',10);
  const bar = document.getElementById('carryWarn');
  if(!bar) return;
  if(cnt>0){ bar.style.display='block'; bar.textContent = `‚ö†Ô∏è ${cnt} incomplete task(s) were automatically carried over to today.`; }
  else { bar.style.display='none'; }
}

/* Render Tasks + Focus lane */
function renderAll(){
  const todayLabel=document.getElementById('todayLabel');
  if(todayLabel) todayLabel.textContent=fmtHumanDate(TODAY);
  const viewingLabel=document.getElementById('viewingLabel');
  if(viewingLabel) viewingLabel.textContent=fmtHumanDate(viewing);

  const list=ensureDay(viewing);
  const ul=document.getElementById('taskList');
  if(ul){
    ul.innerHTML='';
    list.forEach(t=>{
      const li=document.createElement('li'); li.className='task';

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=t.done;
      cb.onchange=e=>toggleDone(viewing,t.id,e.target);

      const center=document.createElement('div');
      const prioc=t.prio==='low'?'p-low':t.prio==='med'?'p-med':'p-high';
      const completedMeta=(t.done&&t.timeCompleted)?`<div class="meta">‚úî completed ${fmtDateTime(t.timeCompleted)}</div>`:'';
      const tagText = (t.tags && t.tags.length)
        ? `<span style="font-size:11px;color:#9fb0d0;">${t.tags.map(x=>'#'+escapeHtml(x)).join(' ')}</span>`
        : '';
      center.innerHTML=
        `<div style="font-weight:600;${t.done?'text-decoration:line-through;opacity:.7':''}">
           ${escapeHtml(t.name)}
         </div>
         <div>
           <span class="priority ${prioc}">${t.prio}</span>
           ${tagText}
         </div>
         ${completedMeta}`;

      const stars=document.createElement('div'); stars.className='stars';
      for(let s=1;s<=3;s++){
        const b=document.createElement('button');
        b.textContent='‚òÖ';
        if(t.stars>=s) b.classList.add('on');
        b.onclick=()=>setStars(viewing,t.id,s===t.stars?0:s);
        stars.appendChild(b);
      }

      const act=document.createElement('div'); act.className='actions';
      const f=document.createElement('button');
      f.textContent='üéØ';
      f.title=t.focus?'Remove from Focus lane':'Add to Focus lane';
      if(t.focus) f.classList.add('focus-toggle','on'); else f.classList.add('focus-toggle');
      f.onclick=()=>toggleFocus(viewing,t.id);
      const e=document.createElement('button'); e.textContent='‚úé'; e.onclick=()=>editTask(viewing,t.id);
      const d=document.createElement('button'); d.textContent='√ó'; d.className='del'; d.onclick=()=>delTask(viewing,t.id);
      act.appendChild(f); act.appendChild(e); act.appendChild(d);

      li.appendChild(cb); li.appendChild(center); li.appendChild(stars); li.appendChild(act);
      ul.appendChild(li);
    });
  }

  const total=list.length, done=list.filter(x=>x.done).length;
  const pct=total?Math.round(done/total*100):0;
  const q=list.filter(x=>x.done).reduce((a,b)=>a+(b.stars||0),0);
  const qPct=done?Math.round((q/(done*3))*100):0;
  const doneSummary=document.getElementById('doneSummary'); if(doneSummary) doneSummary.textContent=`${done} / ${total} tasks done (${pct}%)`;
  const qualitySummary=document.getElementById('qualitySummary'); if(qualitySummary) qualitySummary.textContent=`Quality ${qPct}%`;
  const kpiRow=document.getElementById('kpiRow'); if(kpiRow&&kpiRow.firstElementChild) kpiRow.firstElementChild.textContent=`${done} / ${total} done (${pct}%) ¬∑ Quality ${qPct}%`;

  // Focus lane
  const focusLane=document.getElementById('focusLane');
  if(focusLane){
    const focus=list.filter(t=>t.focus);
    if(!focus.length){
      focusLane.style.display='none';
    }else{
      focusLane.style.display='block';
      const doneF=focus.filter(t=>t.done).length;
      const pctF=Math.round(doneF/focus.length*100);
      const chips=focus.slice(0,6).map(t=>`<span class="focus-chip">${escapeHtml(t.name)}</span>`).join('');
      focusLane.innerHTML=
        `<div>üéØ Focus lane: ${doneF}/${focus.length} done (${pctF}%)</div>
         <div class="focus-chips">${chips}</div>`;
    }
  }

  renderMeds();
}

/* ===== History, tags, weekly review ===== */
function renderHistory(){
  const wrap=document.getElementById('histList'); if(!wrap) return;
  const q=(document.getElementById('histSearch').value||'').trim().toLowerCase();
  const spanSel=document.getElementById('histSpan').value;
  let keys=Object.keys(days||{});
  if(spanSel!=='all'){
    const span=parseInt(spanSel,10);
    const min=new Date(); min.setDate(min.getDate()-span);
    keys=keys.filter(k=>new Date(k)>=min);
  }
  keys.sort((a,b)=>new Date(b)-new Date(a));
  if(q){
    keys=keys.filter(k=>{
      if(k.toLowerCase().includes(q)) return true;
      const arr=days[k]||[];
      return arr.some(t=>{
        const nm=(t.name||'').toLowerCase();
        const tags=(t.tags||[]).join(' ').toLowerCase();
        return nm.includes(q) || tags.includes(q);
      });
    });
  }
  wrap.innerHTML='';
  if(!keys.length){ wrap.innerHTML='<div class="muted">No history found.</div>'; renderTagChips(); return; }
  keys.forEach(k=>{
    const arr=days[k]||[];
    const total=arr.length, done=arr.filter(t=>t.done).length;
    const pct=total?Math.round(done/total*100):0;
    const qsum=arr.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
    const qPct=done?Math.round((qsum/(done*3))*100):0;
    const row=document.createElement('div'); row.className='hist-row';
    const left=document.createElement('div');
    left.innerHTML=`<div style="font-weight:700">${fmtHumanDate(k)}</div>
                    <div class="meta">${done}/${total} done ‚Ä¢ ${pct}% ¬∑ Quality ${qPct}%</div>`;
    const right=document.createElement('div');
    const btn=document.createElement('button'); btn.textContent='Open'; btn.onclick=()=>{ viewing=k; showTab('tasks'); renderAll(); };
    right.appendChild(btn);
    row.appendChild(left); row.appendChild(right);
    wrap.appendChild(row);
  });

  renderTagChips();
}
function renderTagChips(){
  const host=document.getElementById('tagChips'); if(!host) return;
  const stats=new Map();
  Object.keys(days||{}).forEach(d=>{
    (days[d]||[]).forEach(t=>{
      (t.tags||[]).forEach(tag=>{
        const key=tag.toLowerCase();
        stats.set(key,(stats.get(key)||0)+1);
      });
    });
  });
  const entries=Array.from(stats.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(!entries.length){ host.innerHTML=''; return; }
  host.innerHTML=entries.map(([tag,count])=>
    `<button class="tag-chip" onclick="setHistoryTag('${tag}')">#${escapeHtml(tag)} (${count})</button>`
  ).join('');
}
function setHistoryTag(tag){
  const input=document.getElementById('histSearch');
  input.value='#'+tag;
  renderHistory();
}
function renderWeeklyReview(){
  const body=document.getElementById('weeklyReviewBody'); if(!body) return;
  let totalTasks=0, doneTasks=0, focusTasks=0;
  let daysFullMeds=0, daysAnyMeds=0;
  for(let i=0;i<7;i++){
    const iso=isoOffset(TODAY,-i);
    const list=ensureDay(iso);
    totalTasks += list.length;
    doneTasks  += list.filter(t=>t.done).length;
    focusTasks += list.filter(t=>t.focus).length;
    const m=medsFor(iso);
    const any = !!(m.day || m.night);
    const full= !!(m.day && m.night);
    if(any) daysAnyMeds++;
    if(full) daysFullMeds++;
  }
  if(totalTasks===0 && daysAnyMeds===0){
    body.textContent='Not enough data for this week yet. Start logging tasks and meds to see your review.';
    return;
  }
  const pctTasks = totalTasks ? Math.round(doneTasks/totalTasks*100) : 0;
  body.innerHTML=
    `Tasks (7 days): <strong>${doneTasks}/${totalTasks}</strong> completed (${pctTasks}%).
     <br/>Focus tasks marked: <strong>${focusTasks}</strong>.
     <br/>Meds: <strong>${daysFullMeds}/7</strong> days with both doses logged
     (${daysAnyMeds} day(s) with at least one dose).`;
}

/* ===== Backup & Reset ===== */
(function () {
  function buildBackupPayload() {
    const dump = {};
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (/^tp_/.test(k)) dump[k] = localStorage.getItem(k);
    }
    dump[LS_KEY]  = JSON.stringify(days || {});
    dump[LS_MEDS] = JSON.stringify(meds || {});
    dump[LS_SYNC] = localStorage.getItem(LS_SYNC) || '';
    dump[LS_TAB]  = localStorage.getItem(LS_TAB)  || 'tasks';
    dump[LS_LAST_OPEN]        = localStorage.getItem(LS_LAST_OPEN) || isoToday();
    dump[LS_LAST_CARRY_COUNT] = localStorage.getItem(LS_LAST_CARRY_COUNT) || '0';

    return { app:'taskpulse', flavor:'v8.5', exportedAt:new Date().toISOString(), dump };
  }
  window.tpDownloadBackup=function(){
    try{
      const payload=buildBackupPayload();
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='taskpulse_backup.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      localStorage.setItem('tp_last_backup', new Date().toLocaleString());
      tpUpdateLastBackupLabel();
      setStatus('Backup downloaded.');
    }catch(e){
      console.error('[TaskPulse] Backup failed:',e);
      setStatus('Backup failed: '+e.message);
      alert('Backup failed: '+e.message);
    }
  };
  const fi=document.getElementById('tpRestoreFile');
  if(fi){
    fi.addEventListener('change',async e=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const text=await f.text();
        const data=JSON.parse(text);
        if(data && data.dump){
          Object.entries(data.dump).forEach(([k,v])=>{ if(/^tp_/.test(k)) localStorage.setItem(k,v); });
        }
        setStatus('Restore complete. Reloading‚Ä¶');
        setTimeout(()=>location.reload(),600);
      }catch(err){
        console.error('[TaskPulse] Restore failed:',err);
        setStatus('Restore failed: '+err.message);
        alert('Restore failed: '+err.message);
      }finally{ e.target.value=''; }
    });
  }
  function setStatus(msg){
    const el=document.getElementById('tpBackupStatus');
    if(el) el.textContent=msg;
  }
})();

function tpUpdateLastBackupLabel(){
  const el=document.getElementById('tpLastBackup');
  if(!el) return;
  el.textContent=`Last backup: ${localStorage.getItem('tp_last_backup')||'none'}`;
}

function tpSafeReset(){
  if(!confirm('This will clear all Task Pulse data on this device (backups you downloaded stay safe). Continue?')) return;
  const keep=['tp_last_backup'];
  const toDelete=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(/^tp_/.test(k) && !keep.includes(k)) toDelete.push(k);
  }
  toDelete.forEach(k=>localStorage.removeItem(k));
  location.reload();
}

/* Meds settings */
function saveMedsSettings(){
  const stockInp=document.getElementById('medsStockInput');
  const dailyInp=document.getElementById('medsDailyInput');
  const stock=parseInt(stockInp.value||'0',10);
  const daily=parseInt(dailyInp.value||'0',10);
  if(isFinite(stock)) localStorage.setItem(LS_MEDS_STOCK,String(stock));
  if(isFinite(daily) && daily>0) localStorage.setItem(LS_MEDS_DAILY,String(daily));
  renderMedsExtras();
}

/* Predictive text + utils */
var SUGGEST_MAX=10;
function tpCollectTaskStats(){
  const stats=new Map();
  for(const dk of Object.keys(days||{})){
    for(const t of (days[dk]||[])){
      const nm=(t.name||'').trim(); if(!nm) continue;
      const key=nm.toLowerCase();
      const last=new Date(t.createdAt||t.timeCompleted||t.updatedAt||t.date||new Date()).getTime();
      if(!stats.has(key)) stats.set(key,{name:nm,count:0,last:0});
      const s=stats.get(key); s.count++; s.last=Math.max(s.last,last);
    }
  }
  return stats;
}
function tpRankedNames(stats){
  return Array.from(stats.values()).sort((a,b)=>(b.count-a.count)||(b.last-a.last)).map(v=>v.name);
}
function tpGetSuggestions(prefix){
  const ranked=tpRankedNames(tpCollectTaskStats());
  const p=(prefix||'').trim().toLowerCase();
  if(!p) return ranked.slice(0,SUGGEST_MAX);
  const pref=ranked.filter(n=>n.toLowerCase().startsWith(p));
  if(pref.length>=SUGGEST_MAX) return pref.slice(0,SUGGEST_MAX);
  const rest=ranked.filter(n=>!n.toLowerCase().startsWith(p)&&n.toLowerCase().includes(p));
  return [...pref,...rest].slice(0,SUGGEST_MAX);
}
function tpRenderDatalist(prefix){
  const dl=document.getElementById('taskSuggestions'); if(!dl) return;
  const opts=tpGetSuggestions(prefix);
  dl.innerHTML=opts.map(n=>`<option value="${escapeHtml(n)}"></option>`).join('');
}

/* Utils */
function isoToday(){ return new Date().toISOString().slice(0,10); }
function isoOffset(iso, days){
  const d=new Date(iso); d.setHours(12,0,0,0);
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}
function ensureDay(iso){ if(!days[iso]) days[iso]=[]; return days[iso]; }
function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch(e){return def;} }
function fmtHumanDate(iso){ const d=new Date(iso); return d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'}); }
function fmtDateTime(iso){
  try{
    const d=new Date(iso);
    const date=d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
    const time=d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
    return `${date} ¬∑ ${time}`;
  }catch{ return ''; }
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>(
    { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m]
  ));
}

/* ===== Sync ===== */
const TP_UID=(localStorage.getItem('tp_uid')||(()=>{const v='u_'+Math.random().toString(36).slice(2,10);localStorage.setItem('tp_uid',v);return v;})());
let syncRef=null,syncOff=null,writeTimer=null;
function setSyncBadge(text,kind=''){ const el=document.getElementById('syncState'); if(!el) return; el.textContent=text; el.className='badge '+(kind||''); }
const SYNC_PREFIX='grp-';
function randomCode(len=6){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let out=''; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)]; return out; }
function ensureSyncCode(){
  let code=localStorage.getItem(LS_SYNC);
  if(!code || !code.trim()){ code=SYNC_PREFIX+randomCode(6); localStorage.setItem(LS_SYNC,code); }
  const inp=document.getElementById('syncCode'); if(inp) inp.value=code;
  if(isFirebaseReady()){ attachSync(code); }
}
function copySyncCode(){ const i=document.getElementById('syncCode'); if(!i||!i.value) return; navigator.clipboard.writeText(i.value).then(()=>alert('Sync code copied')); }
function newSyncCode(){
  if(!confirm('Generate a new sync code? Devices must use this new code.')) return;
  const code=SYNC_PREFIX+randomCode(6); localStorage.setItem(LS_SYNC,code);
  const inp=document.getElementById('syncCode'); if(inp) inp.value=code;
  if(typeof syncOff==='function' && syncOff) syncOff();
  if(isFirebaseReady()) attachSync(code);
  alert('New code generated.');
}
function saveSyncCode(){ const i=document.getElementById('syncCode'); if(!i) return; const v=(i.value||'').trim(); if(!v) return; localStorage.setItem(LS_SYNC,v); alert('Sync code saved.'); if(typeof syncOff==='function' && syncOff) syncOff(); if(isFirebaseReady()) attachSync(v); }
function isFirebaseReady(){ return (window.firebase && firebase.apps && firebase.apps.length); }
function notifyLocalChanged(){ debouncedPush(); }
function debouncedPush(){
  if(!syncRef) return;
  clearTimeout(writeTimer);
  writeTimer=setTimeout(()=>{ syncRef.set({days,meds,_meta:{by:TP_UID,at:Date.now()}}).catch(console.warn); },250);
}
function attachSync(code){
  if(!isFirebaseReady()){ setSyncBadge('Local-only'); return; }
  if(!code) return;
  if(syncOff){ syncOff(); syncOff=null; }
  syncRef=firebase.database().ref(`taskpulse/${code}`);
  setSyncBadge(`Sync: ${code}`,'good');
  syncRef.get().then(snap=>{
    const val=snap.val();
    if(val && (val.days||val.meds)){
      days=mergeDays(days,val.days||{}); meds=mergeMeds(meds,val.meds||{});
      baseSave(LS_KEY,days); baseSave(LS_MEDS,meds);
      renderAll();
    }else{
      debouncedPush();
    }
  }).catch(e=>{ console.warn(e); setSyncBadge('Sync error','warn'); });
  const handler=syncRef.on('value',snap=>{
    const val=snap.val(); if(!val) return;
    if(val._meta && val._meta.by===TP_UID) return;
    if(val.days){ days=mergeDays(days,val.days); baseSave(LS_KEY,days); }
    if(val.meds){ meds=mergeMeds(meds,val.meds); baseSave(LS_MEDS,meds); }
    renderAll();
  });
  syncOff=()=>syncRef.off('value',handler);
}
function mergeDays(localDays,remoteDays){
  const out={...(localDays||{})};
  for(const d of Object.keys(remoteDays||{})){
    if(!out[d]){ out[d]=remoteDays[d]; continue; }
    const L=out[d]||[], R=remoteDays[d]||[];
    const stamp=arr=>arr.reduce((m,t)=>Math.max(m,new Date(t.timeCompleted||t.createdAt||0).getTime()),0);
    out[d]=(stamp(R)>stamp(L))?R:L;
  }
  return out;
}
function mergeMeds(localM,remoteM){
  const out={...(localM||{})};
  for(const day of Object.keys(remoteM||{})){
    const r=remoteM[day]||{}, l=out[day]||{day:'',night:'',dayNote:'',nightNote:''};
    const pick=(a,b)=>{ const ta=a?Date.parse(a):0, tb=b?Date.parse(b):0; return (tb>ta)?b:a; };
    out[day]={day:pick(l.day,r.day), night:pick(l.night,r.night), dayNote:l.dayNote||r.dayNote||'', nightNote:l.nightNote||r.nightNote||''};
  }
  return out;
}
const prevSave=save;
save=function(k,v){ prevSave(k,v); if(k===LS_KEY) notifyLocalChanged(); };

/* Service worker */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
</script>
</body>
</html>

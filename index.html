<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Task Pulse Smart V8.8</title>

<link rel="preload" as="image" href="taskpulse-splash-hex.jpeg" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="icon-192.png" sizes="192x192" />
<meta name="theme-color" content="#0f111a" />

<style>
/* ============================================================
   ROOT PALETTE ‚Äî V8.8 (Hybrid H1 Base + Subtle Meds Palette)
   ============================================================ */
:root{
  --bg:#050611;
  --bg2:#080b14;
  --card:#141725;
  --ink:#e9ecf5;
  --muted:#9fa8c7;
  --line:#262a3c;
  --pill:#1b2440;
  --pad:14px;
  --radius:16px;
  --tap:50px;
  --fs:16px;
  --accent:#27b7ff;
  --accent-soft:#193b66;

  /* Med system soft-greens (not neon) */
  --med-bg:#07121a;
  --med-border:#144c3b;
  --med-taken-bg:#0b2620;
  --med-taken-glow:#25b78a;

  /* Weekly chart colours */
  --chart-bar:#38d9ff;
  --chart-bar-low:#1d2a39;

  /* Focus lane highlight */
  --focus-tint:#1a202f;
}
@media(max-width:480px){
  :root{ --pad:12px; --radius:14px; --tap:56px; --fs:17px; }
}

*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; margin:0; padding:0; }
html,body{ height:100%; }

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);
  font-size:var(--fs);
  background:radial-gradient(circle at top,#1d2440 0,#050611 55%);
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:12px;
}

/* ============================================================
   APP SHELL ‚Äî HYBRID H1
   ============================================================ */
.shell{
  max-width:900px;
  width:100%;
  background:#050814;
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.7);
  padding:16px 18px 14px;
  border:1px solid #20263c;
}

.wrap{
  max-width:820px;
  margin:0 auto;
  padding:4px var(--pad) calc(40px + env(safe-area-inset-bottom));
}

/* ============================================================
   HEADER
   ============================================================ */
.hero-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:14px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
}

.logo-pill{
  width:42px;
  height:42px;
  border-radius:999px;
  background:radial-gradient(circle at 30% 20%,#5fffd0 0,#0fd0ff 40%,#0b1428 80%);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 0 18px rgba(0,255,213,.35);
  font-weight:800;
  letter-spacing:.03em;
  color:white;
}

.brand-title{ font-size:19px; font-weight:700; }
.brand-sub{ font-size:11px; color:var(--muted); }

.top-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:4px;
  font-size:11px;
  color:var(--muted);
}

.badge{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid #3b425d;
  font-size:11px;
  background:var(--pill);
}
.badge.good{ border-color:#3bd47a; color:#7fffb3; }
.badge.warn{ border-color:#e7a74c; color:#ffd78a; }

/* ============================================================
   KPI ROW
   ============================================================ */
.kpi-pill{
  margin:6px 0 12px;
  padding:9px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  font-size:13px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(10,15,30,.9);
}

/* ============================================================
   TABS ‚Äî HYBRID H1
   ============================================================ */
.tabs{
  position:sticky;
  top:0;
  z-index:50;
  padding:4px 0 4px;
  background:linear-gradient(180deg,rgba(5,8,20,.98) 0%,rgba(5,8,20,.88) 70%,rgba(5,8,20,0) 100%);
  backdrop-filter:saturate(130%) blur(4px);
  margin-bottom:10px;
}

.tabbar{
  display:flex;
  gap:6px;
  overflow:auto;
  padding-bottom:4px;
}

.tabbar button{
  flex:1;
  min-width:110px;
  padding:8px 12px;
  font-size:13px;
  border-radius:999px;
  border:1px solid transparent;
  background:var(--pill);
  color:var(--muted);
  cursor:pointer;
  font-weight:500;
  white-space:nowrap;
}

.tabbar button.active{
  background:linear-gradient(135deg,#27b7ff,#4df2ff);
  color:#04101b;
  font-weight:600;
  box-shadow:0 0 18px rgba(39,183,255,.6);
}

.tabpage{ display:none; }
.tabpage.active{ display:block; }

/* ============================================================
   CARDS
   ============================================================ */
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:12px 12px 10px;
  margin:10px 0;
  box-shadow:0 6px 30px rgba(0,0,0,.25);
}

.row{
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:wrap;
}

input,select,button{
  border-radius:999px;
  border:1px solid var(--line);
  background:#050814;
  color:var(--ink);
  padding:8px 12px;
  min-height:var(--tap);
  font-size:13px;
}
input[type=text]{ flex:1 1 200px; min-width:0; }

button.primary{
  background:linear-gradient(135deg,#27b7ff,#4df2ff);
  color:#04101b;
  border:none;
  font-weight:600;
  cursor:pointer;
  white-space:nowrap;
}

.btn-ghost{
  background:transparent;
  border:1px solid var(--line);
  color:var(--muted);
}

.btn-danger{
  background:rgba(224,82,100,.12);
  border:1px solid #e05264;
  color:#ff9da8;
}

.muted{ color:var(--muted); }
.list{ list-style:none; margin:0; padding:0; }

/* ============================================================
   TASK ROWS
   ============================================================ */
.task{
  display:grid;
  grid-template-columns:auto 1fr auto auto;
  gap:8px;
  align-items:center;
  padding:8px 10px;
  margin-bottom:5px;
  border-radius:12px;
  background:#101528;
  border:1px solid #1e2234;
  transition:background .2s;
}

.task input[type="checkbox"]{
  width:16px; height:16px;
}

.task div:first-of-type{
  min-height:40px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}

.priority{
  display:inline-block;
  border-radius:999px;
  padding:1px 6px;
  font-size:10px;
  margin-top:4px;
  text-transform:uppercase;
  letter-spacing:.04em;
}
.p-low{ background:#16352b; color:#7af3b1; }
.p-med{ background:#3a321b; color:#ffe08a; }
.p-high{ background:#3d1b25; color:#ff9ab2; }

.stars button{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:14px;
  opacity:.4;
  transition:opacity .2s;
}
.stars button.on{
  opacity:1;
  text-shadow:0 0 8px rgba(255,215,120,.7);
}

.actions{ display:flex; gap:4px; }
.actions button{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:15px;
  padding:0 2px;
  color:#99a4d2;
}
.actions .del{ color:#ff9ba9; }

.task .meta{
  margin-top:4px;
  font-size:12px;
  color:#9fb0d0;
  opacity:.85;
}

/* ============================================================
   FOCUS LANE (NEW V8.8)
   ============================================================ */
#focusLaneToggle{
  margin-top:6px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  border-radius:999px;
  background:#0e1324;
  border:1px solid var(--line);
  cursor:pointer;
  font-size:13px;
  color:var(--muted);
}

.focus-active .task{
  background:var(--focus-tint);
  border-color:#31405c;
}

/* ============================================================
   HISTORY
   ============================================================ */
.hist-row{
  border-radius:12px;
  border:1px solid var(--line);
  padding:10px 12px;
  margin:6px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#101528;
}

.hist-row .meta{
  color:#9fb0d0;
  font-size:12px;
  margin-top:4px;
}

.hist-row button{
  border-radius:999px;
  padding:6px 10px;
}

/* ============================================================
   WEEKLY REVIEW (NEW)
   ============================================================ */
.weekly-card{
  margin-top:12px;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid var(--line);
  background:#0d1323;
}

.weekly-title{
  font-weight:700;
  font-size:15px;
  margin-bottom:6px;
}

.weekly-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}

.weekly-bar{
  height:38px;
  border-radius:8px;
  background:var(--chart-bar-low);
  overflow:hidden;
  position:relative;
}

.weekly-bar-fill{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  background:var(--chart-bar);
}

/* ============================================================
   MEDS CARD (NEW V8.8 SOFTENED)
   ============================================================ */
.meds-card{
  padding:12px 12px;
}

.meds-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.meds-head-title{
  font-size:14px;
  font-weight:600;
}

.meds-head-tag{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  background:#101828;
  color:#9fd2ff;
  border:1px solid #294064;
}

.meds-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:6px;
}

.meds-btn{
  flex:1 1 150px;
  min-width:0;
  border-radius:14px;
  padding:12px 14px;
  background:var(--med-bg);
  border:1px solid var(--med-border);
  text-align:left;
  display:flex;
  flex-direction:column;
  gap:2px;
  transition:all .25s;
}

.meds-btn-title{
  font-size:13px;
  font-weight:600;
  color:#cfeaff;
}

.meds-btn-sub{
  font-size:11px;
  color:#8fafc9;
}

.meds-btn-taken{
  background:var(--med-taken-bg);
  border-color:var(--med-taken-glow);
  box-shadow:0 0 12px rgba(37,183,138,0.25);
}

/* COUNTDOWN */
#medsCountdown{
  margin-top:6px;
  font-size:12px;
  color:#b7d9c7;
  font-weight:500;
}

/* Reminder banner */
#medsReminder{
  display:none;
  margin:8px 0 0 0;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #3e4a13;
  background:#161d07;
  color:#d8ee8a;
  font-weight:600;
}

/* ============================================================
   SPLASH
   ============================================================ */
#splash{
  position:fixed;
  inset:0;
  z-index:9999;
  background:radial-gradient(circle at top,#2b2220 0,#050611 60%);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

#splash::before{
  content:"";
  position:absolute;
  inset:0;
  background:url('taskpulse-splash-hex.jpeg') center/cover no-repeat;
  filter:contrast(105%) saturate(110%);
  transform:scale(1.05);
  animation:zoomfade 2s ease forwards;
  opacity:.95;
}

#splash .label{
  position:relative;
  text-align:center;
  color:#fff;
  text-shadow:0 6px 26px rgba(0,0,0,.55);
  animation:textin .6s ease both .2s;
}

#splash h2{
  margin:0;
  font-size:32px;
  letter-spacing:.5px;
}

#splash .sub{
  opacity:.85;
  margin-top:8px;
  font-size:13px;
}

#splash .foot{
  position:absolute;
  bottom:18px;
  width:100%;
  text-align:center;
  font-size:13px;
  opacity:.85;
}

@keyframes zoomfade{
  0%{ opacity:0; transform:scale(1.08); }
  15%{ opacity:1; }
  100%{ opacity:0; transform:scale(1); }
}
@keyframes textin{
  from{ opacity:0; transform:translateY(6px); }
  to{ opacity:1; transform:translateY(0); }
}

.hide-splash #splash{ display:none; }

/* ============================================================
   MOBILE TWEAKS
   ============================================================ */
@media(max-width:600px){
  .shell{ padding:14px 10px 12px; }
  .hero-header{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  .top-right{
    align-items:flex-start;
  }
  .task{
    grid-template-columns:auto 1fr auto;
  }
  .task .actions{
    grid-column:1 / -1;
    justify-content:flex-end;
  }
}
</style>
</head>

  <body>

<!-- ===========================
     SPLASH
=========================== -->
<div id="splash">
  <div class="label">
    <h2>Task Pulse Smart</h2>
    <div class="sub">Focus ¬∑ Sync ¬∑ Achieve (V8.8)</div>
    <div class="foot">Powered by D Gounder</div>
  </div>
</div>

<!-- ===========================
     APP SHELL
=========================== -->
<div class="shell">
  <div class="wrap">

    <!-- ===========================
         HEADER
    =========================== -->
    <header class="hero-header">
      <div class="brand">
        <div class="logo-pill">TP</div>
        <div>
          <div class="brand-title">Task Pulse Smart</div>
          <div class="brand-sub">Daily focus advisor ¬∑ V8.8</div>
        </div>
      </div>

      <div class="top-right">
        <div id="syncState" class="badge">Local-only</div>
        <div id="tpLastBackup">Last backup: none</div>
      </div>
    </header>

    <!-- KPI -->
    <div class="kpi-pill" id="kpiRow">
      <span>0 / 0 done (0%) ¬∑ Quality 0%</span>
      <span id="todayLabel" class="muted">‚Äî</span>
    </div>

    <!-- Carry-over banner -->
    <div id="carryWarn"></div>

    <!-- Meds reminder banner -->
    <div id="medsReminder"></div>

    <!-- ===========================
         TABS
    =========================== -->
    <div class="tabs">
      <div class="tabbar">
        <button id="btnTabTasks" class="active" onclick="showTab('tasks')">Tasks</button>
        <button id="btnTabHistory" onclick="showTab('history')">History</button>
        <button id="btnTabSettings" onclick="showTab('settings')">Settings</button>
      </div>
    </div>

    <!-- ===========================
         TAB: TASKS
    =========================== -->
    <div id="tab-tasks" class="tabpage active">
      
      <!-- ===== Medication Card ===== -->
     <section class="card meds-card" id="medsCard">
  <div class="meds-head">
    <div class="meds-head-title">Medication ‚Äî Today</div>
    <div class="meds-head-tag">TLE routine</div>
  </div>

  <div class="meds-row">
    <button id="btnMedsDay" class="meds-btn" onclick="toggleMeds('day')" title="Log/undo Morning dose">
      <span class="meds-btn-title">üåÖ Morning Dose</span>
      <span class="meds-btn-sub">Tap to log</span>
    </button>

    <button id="btnMedsNight" class="meds-btn" onclick="toggleMeds('night')" title="Log/undo Night dose">
      <span class="meds-btn-title">üåô Night Dose</span>
      <span class="meds-btn-sub">Tap to log</span>
    </button>
  </div>

  <!-- Small helper text (no timestamps here anymore) -->
  <div class="muted" id="medsMeta">
    Log both doses to keep your streak going.
  </div>

  <!-- BIG countdown bar -->
  <div id="medsCountdown" class="meds-countdown">
    Next dose in ‚Äî
  </div>
</section>

          .meds-countdown{
  margin-top:10px;
  padding:10px 14px;
  border-radius:16px;
  background:linear-gradient(135deg,#3c4bff,#7a4dff);
  border:1px solid rgba(255,255,255,0.12);
  color:#fdfdff;
  font-size:16px;
  font-weight:600;
  text-align:center;
  box-shadow:0 8px 26px rgba(0,0,0,0.45);
  letter-spacing:0.02em;
  line-height:1.4;
}
@media (max-width:600px){
  .meds-countdown{
    font-size:17px;
    padding:12px 16px;
  }
}
          

      <!-- ===== Today's Tasks ===== -->
      <section class="card">
        <h3 style="margin:0 0 8px">Today's Tasks</h3>

        <div class="row" style="margin-bottom:8px;">
          <input id="taskInput"
                 type="text"
                 placeholder="Add task‚Ä¶"
                 list="taskSuggestions"
                 autocomplete="off" />
          <datalist id="taskSuggestions"></datalist>

          <select id="prioSelect">
            <option value="low">low</option>
            <option value="med">med</option>
            <option value="high">high</option>
          </select>

          <button class="primary" onclick="addTask()">Add</button>
        </div>

        <div class="row">
          <button class="btn-ghost" onclick="clearCompleted()">Clear completed</button>
          <button class="btn-ghost"
                  onclick="manualCarryOver()"
                  title="Move incomplete tasks to tomorrow">
            Carry incomplete ‚Üí tomorrow
          </button>
        </div>

        <!-- Focus Lane Toggle -->
        <div id="focusLaneToggle"
             onclick="toggleFocusLane()">
          <input type="checkbox" id="focusLaneCheckbox" style="width:16px;height:16px;">
          Focus Lane (show only important tasks)
        </div>

      </section>

      <!-- ===== Task List ===== -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Viewing</div>
            <div id="viewingLabel" style="font-weight:600">‚Äî</div>
          </div>

          <div class="nav">
            <button class="btn-ghost" onclick="shiftDay(-1)">‚óÄ</button>
            <button class="btn-ghost" onclick="shiftDay(+1)">‚ñ∂</button>
          </div>
        </div>

        <ul id="taskList" class="list" style="margin-top:8px;"></ul>

        <div class="sum">
          <div id="doneSummary">0 / 0 tasks done (0%)</div>
          <div id="qualitySummary">Quality 0%</div>
        </div>
      </section>

    </div> <!-- END Tasks Tab -->

    <!-- ===========================
         TAB: HISTORY
    =========================== -->
    <div id="tab-history" class="tabpage">

      <section class="card">
        <h3 style="margin:0 0 8px">History</h3>

        <div class="row" style="gap:6px;margin-bottom:6px;">
          <input id="histSearch"
                 type="text"
                 placeholder="Search text or YYYY-MM-DD‚Ä¶"
                 oninput="renderHistory()" />

          <select id="histSpan" onchange="renderHistory()">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="all">All</option>
          </select>
        </div>

        <div id="histList"></div>

        <!-- Weekly Review Card -->
        <section class="weekly-card" id="weeklyReviewCard" style="display:none;">
          <div class="weekly-title">Weekly Review</div>
          <div id="weeklyGrid" class="weekly-grid"></div>
        </section>

      </section>

    </div> <!-- END History Tab -->

    <!-- ===========================
         TAB: SETTINGS
    =========================== -->
    <div id="tab-settings" class="tabpage">

      <section class="card">
        <h3 style="margin:0 0 8px">Sync</h3>

        <div class="row" style="margin-bottom:8px;">
          <input id="syncCode" placeholder="Sync code" style="flex:1 1 260px" />
          <button class="btn-ghost" onclick="copySyncCode()">Copy</button>
          <button class="btn-ghost" onclick="newSyncCode()">New code</button>
          <button class="primary" onclick="saveSyncCode()">Save</button>
        </div>

        <div class="muted" id="syncHint" style="font-size:12px;">
          Open this site on your second device and use the same code. Sync uses Firebase Realtime Database.
        </div>
      </section>

      <section class="card" id="backupCard">
        <h3 style="margin:0 0 8px;">Backup & Restore</h3>

        <div class="row" style="align-items:center;">
          <button id="btnBackup" class="primary" onclick="tpDownloadBackup()">‚≠≥ Download Backup</button>
          <input id="tpRestoreFile" type="file" accept="application/json" style="display:none" />
          <button id="btnRestore" class="btn-ghost"
                  onclick="document.getElementById('tpRestoreFile').click()">
            ‚≠± Import Backup
          </button>
        </div>

        <div id="tpBackupStatus"
             class="muted"
             style="margin-top:6px;font-size:12px;"></div>
      </section>

    </div> <!-- END Settings Tab -->

  </div> <!-- wrap -->

  <footer style="margin-top:4px;text-align:center;font-size:11px;color:var(--muted);">
    Task Pulse Smart V8.8 ¬∑ Powered by D Gounder
  </footer>

</div> <!-- shell -->

    <!-- ===========================
     FIREBASE (optional)
=========================== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
// Insert your Firebase config here if needed
</script>

<!-- ===========================
     CORE ENGINE ‚Äî V8.8
=========================== -->
<script>
/* ============================================================
   CONSTANTS & STORAGE KEYS
============================================================ */
const LS_KEY          = 'tp_days_v1';
const LS_SYNC         = 'tp_sync_code';
const LS_TAB          = 'tp_last_tab';
const LS_LAST_OPEN    = 'tp_last_open';
const LS_MEDS         = 'tp_meds_v1';
const LS_CARRY_COUNT  = 'tp_last_carry_count';
const LS_FOCUS_MODE   = 'tp_focus_lane';
const TODAY           = isoToday();

let days = load(LS_KEY, {});
let meds = load(LS_MEDS, {});
let viewing = TODAY;

/* Dirty-write system */
let tpDirty = false;
function baseSave(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
function save(k, v){
  try { baseSave(k, v); tpDirty = false; }
  catch(e){ tpDirty = true; }
}
setInterval(()=>{ if(tpDirty) baseSave(LS_KEY, days); }, 3000);

window.addEventListener("beforeunload",()=>{
  baseSave(LS_KEY, days);
  baseSave(LS_MEDS, meds);
});

/* ============================================================
   INITIAL LOAD
============================================================ */
window.addEventListener("load",()=>{
  setTimeout(()=>document.body.classList.add("hide-splash"), 1800);
});

document.addEventListener("DOMContentLoaded",()=>{
  const last = localStorage.getItem(LS_TAB) || 'tasks';
  showTab(last);

  ensureSyncCode();
  tpUpdateLastBackupLabel();

  tpRenderDatalist('');
  renderHistory();

  showCarryBannerIfAny();
  renderMeds();
  updateMedsReminder();
  updateCountdownLoop();

  autoCarryForwardIfNewDay();
  renderAll();

  restoreFocusMode();
});

/* ============================================================
   UTILS
============================================================ */
function isoToday(){ return new Date().toISOString().slice(0,10); }
function isoOffset(iso, d){ const x=new Date(iso); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10); }
function load(k, def){ try { return JSON.parse(localStorage.getItem(k) || 'null') ?? def; } catch(e){ return def; } }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m])); }

function fmtHumanDate(iso){
  const d = new Date(iso);
  return d.toLocaleDateString(undefined,{day:'2-digit', month:'2-digit', year:'numeric'});
}
function fmtDateTime(iso){
  try {
    const d = new Date(iso);
    return `${d.toLocaleDateString(undefined,{day:'2-digit', month:'2-digit', year:'numeric'})}
            ¬∑ ${d.toLocaleTimeString(undefined,{hour:'2-digit', minute:'2-digit'})}`.replace(/\s+/g,' ');
  } catch { return ''; }
}

function ensureDay(iso){
  if(!days[iso]) days[iso] = [];
  return days[iso];
}
function medsFor(iso){
  if(!meds[iso]) meds[iso] = { day:'', night:'' };
  return meds[iso];
}

/* ============================================================
   TAB SWITCHING
============================================================ */
function showTab(id){
  document.querySelectorAll(".tabpage").forEach(el=>el.classList.remove("active"));
  document.getElementById("tab-"+id)?.classList.add("active");

  document.querySelectorAll(".tabbar button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btnTab"+cap(id))?.classList.add("active");

  localStorage.setItem(LS_TAB,id);
  if(id==='history') renderHistory();
}
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* ============================================================
   FOCUS LANE (NEW V8.8)
============================================================ */
function toggleFocusLane(){
  const chk = document.getElementById("focusLaneCheckbox");
  chk.checked = !chk.checked;

  localStorage.setItem(LS_FOCUS_MODE, chk.checked ? '1' : '0');
  document.body.classList.toggle("focus-active", chk.checked);

  renderAll();
}

function restoreFocusMode(){
  const isOn = localStorage.getItem(LS_FOCUS_MODE) === '1';
  const chk = document.getElementById("focusLaneCheckbox");

  chk.checked = isOn;
  document.body.classList.toggle("focus-active", isOn);
}

/* ============================================================
   MEDICATION ‚Äî V8.8 (Streak, Countdown, Icons, etc)
============================================================ */
function toggleMeds(which){
  const m = medsFor(TODAY);
  if(m[which]){
    if(!confirm("Unmark this dose as taken?")) return;
    m[which] = '';
  } else {
    m[which] = new Date().toISOString();
  }
  baseSave(LS_MEDS, meds);

  renderMeds();
  updateMedsReminder();
  updateCountdownLoop();
  notifyLocalChanged();
}
// --- Make every tasks/meds save also push to Firebase ---
const originalSave = save;
save = function(k, v){
  originalSave(k, v);
  if (k === LS_KEY || k === LS_MEDS){
    notifyLocalChanged();
  }
};




      
/* Render meds state */
function renderMeds(){
  const m = medsFor(TODAY);
  const btnDay   = document.getElementById("btnMedsDay");
  const btnNight = document.getElementById("btnMedsNight");
  const meta     = document.getElementById("medsMeta");

  // Morning
  if(btnDay){
    const taken = !!m.day;
    const text  = taken ? `Logged ¬∑ ${fmtDateTime(m.day)}` : "Tap to log";
    btnDay.className = "meds-btn" + (taken ? " meds-btn-taken" : "");
    btnDay.querySelector(".meds-btn-sub").textContent = text;
  }

  // Night
  if(btnNight){
    const taken = !!m.night;
    const text  = taken ? `Logged ¬∑ ${fmtDateTime(m.night)}` : "Tap to log";
    btnNight.className = "meds-btn" + (taken ? " meds-btn-taken" : "");
    btnNight.querySelector(".meds-btn-sub").textContent = text;
  }

  // Meta row
if (meta){
  const hasDay   = !!m.day;
  const hasNight = !!m.night;

  if (!hasDay && !hasNight){
    meta.textContent = "Both doses still open for today.";
  } else if (hasDay && !hasNight){
    meta.textContent = "Morning logged ¬∑ Night still open.";
  } else if (!hasDay && hasNight){
    meta.textContent = "Night logged ¬∑ Morning missing (check).";
  } else {
    meta.textContent = "Great work ‚Äî both doses logged.";
  }
}


/* SIMPLE MED REMINDER (‚ÄúMorning not taken‚Äù) */
function updateMedsReminder(){
  const bar = document.getElementById("medsReminder");
  const m = medsFor(TODAY);

  let msg = "";
  if(!m.day && !m.night) msg = "Morning & Night Meds not taken";
  else if(!m.day) msg = "Morning Meds not taken";
  else if(!m.night) msg = "Night Meds not taken";

  if(msg){
    bar.textContent = msg;
    bar.style.display = "block";
  } else {
    bar.style.display = "none";
  }
}

/* ============================================================
   COUNTDOWN TIMER (NEW V8.8)
============================================================ */
let countdownTimer = null;

function updateCountdownLoop(){
  clearInterval(countdownTimer);

  countdownTimer = setInterval(updateCountdown, 1000);
  updateCountdown();
}

      
function updateCountdown(){
  const out = document.getElementById("medsCountdown");
  if (!out) return;

  // Always base this on *today* right now
  const todayIso = isoToday();
  const m = medsFor(todayIso);

  // Nothing logged yet ‚Üí encourage morning dose
  if (!m.day && !m.night){
    out.textContent = "Next dose in ‚Äî  Morning dose not logged yet";
    return;
  }

  // Only night missing ‚Üí night due, but still countdown
  if (m.day && m.night){
    // Both doses done for today ‚Üí celebrate
    out.textContent = "‚úÖ All doses logged for today";
    return;
  }

  if (!m.day){
    out.textContent = "Next dose in ‚Äî  Morning dose not logged yet";
    return;
  }

  // Morning logged, night still pending ‚Üí 12h timer
  const dayLogged = new Date(m.day);
  const nightDue  = new Date(dayLogged.getTime() + 12 * 3600 * 1000);
  const now       = new Date();

  let diff = nightDue - now;

  if (diff <= 0){
    out.textContent = "üåô Night dose is due now";
    return;
  }

  const h  = Math.floor(diff / 3600000);
  diff    %= 3600000;
  const m2 = Math.floor(diff / 60000);
  const s  = Math.floor((diff % 60000) / 1000);

  out.textContent = `Next dose in ${h}h ${m2}m ${s}s`;
}



      
/* ============================================================
   TASK ENGINE
============================================================ */
function addTask(){
  const name = document.getElementById("taskInput").value.trim();
  const prio = document.getElementById("prioSelect").value;

  if(!name) return;

  const t = {
    id:'t_'+Math.random().toString(36).slice(2,8),
    name, prio,
    done:false,
    stars:0,
    createdAt:new Date().toISOString()
  };

  ensureDay(viewing).unshift(t);
  save(LS_KEY, days);

  document.getElementById("taskInput").value='';
  renderAll();
  tpRenderDatalist('');
}

function toggleDone(dayKey,id,el){
  const t = ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.done = el.checked;
  t.timeCompleted = t.done ? new Date().toISOString() : '';
  save(LS_KEY, days);
  renderAll();
}

function setStars(dayKey,id,s){
  const t = ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;
  t.stars = s===t.stars ? 0 : s;
  save(LS_KEY, days);
  renderAll();
}

function editTask(dayKey,id){
  const t = ensureDay(dayKey).find(x=>x.id===id);
  if(!t) return;

  const name = prompt("Edit task:", t.name);
  if(name === null) return;

  let prio = prompt("Priority (low/med/high):", t.prio);
  if(!['low','med','high'].includes(prio)) prio = t.prio;

  t.name = name.trim();
  t.prio = prio;

  save(LS_KEY, days);
  renderAll();
}

function delTask(dayKey,id){
  if(!confirm("Delete task?")) return;
  days[dayKey] = ensureDay(dayKey).filter(x=>x.id!==id);
  save(LS_KEY, days);
  renderAll();
}

function clearCompleted(){
  days[viewing] = ensureDay(viewing).filter(x=>!x.done);
  save(LS_KEY, days);
  renderAll();
}

function shiftDay(d){
  const dt=new Date(viewing);
  dt.setDate(dt.getDate()+d);
  viewing=dt.toISOString().slice(0,10);
  renderAll();
}

/* ============================================================
   AUTO-CARRY + MANUAL CARRY
============================================================ */
function manualCarryOver(){
  const list = ensureDay(viewing);
  const incom = list.filter(t=>!t.done);

  if(!incom.length){
    alert("No incomplete tasks to carry.");
    return;
  }

  const tomorrow = isoOffset(viewing, +1);
  ensureDay(tomorrow).unshift(...incom.map(t=>({
    ...t,
    id:'t_'+Math.random().toString(36).slice(2,8),
    createdAt:new Date().toISOString()
  })));

  days[viewing] = list.filter(t=>t.done);

  save(LS_KEY, days);
  renderAll();

  alert(`Carried ${incom.length} task(s) to ${fmtHumanDate(tomorrow)}.`);
}

function autoCarryForwardIfNewDay(){
  const last = load(LS_LAST_OPEN, '');
  const today = isoToday();

  let carried = 0;

  if(last && last !== today){
    const prev = ensureDay(last).filter(t=>!t.done);
    if(prev.length){
      const dest = ensureDay(today);
      dest.unshift(...prev.map(t=>({
        ...t,
        id:'t_'+Math.random().toString(36).slice(2,8),
        createdAt:new Date().toISOString()
      })));

      days[last] = ensureDay(last).filter(t=>t.done);
      carried = prev.length;
      save(LS_KEY, days);
    }
  }

  save(LS_LAST_OPEN, today);
  localStorage.setItem(LS_CARRY_COUNT, carried+'');
}

function showCarryBannerIfAny(){
  const cnt = parseInt(localStorage.getItem(LS_CARRY_COUNT)||'0',10);
  const bar = document.getElementById("carryWarn");

  if(cnt>0){
    bar.style.display='block';
    bar.textContent = `‚ö†Ô∏è ${cnt} incomplete task(s) were automatically carried to today.`;
  } else {
    bar.style.display='none';
  }
}

/* ============================================================
   RENDER ALL TASKS
============================================================ */
function renderAll(){
  const todayLabel = document.getElementById("todayLabel");
  if(todayLabel) todayLabel.textContent = fmtHumanDate(TODAY);

  const viewingLabel = document.getElementById("viewingLabel");
  if(viewingLabel) viewingLabel.textContent = fmtHumanDate(viewing);

  const list = ensureDay(viewing);
  const ul = document.getElementById("taskList");
  if(ul){
    ul.innerHTML='';

    const focus = localStorage.getItem(LS_FOCUS_MODE)==='1';

    list.forEach(t=>{
      if(focus){
        const high = t.prio==='high';
        const starred = t.stars>0;
        const overdue = (!t.done && viewing !== TODAY);
        if(!(high || starred || overdue)) return;
      }

      const li = document.createElement("li");
      li.className = "task";

      /* checkbox */
      const cb = document.createElement("input");
      cb.type="checkbox";
      cb.checked = t.done;
      cb.onchange = e=>toggleDone(viewing,t.id,e.target);

      /* center */
      const center = document.createElement("div");
      const prioc  = t.prio==='low' ? 'p-low' :
                     t.prio==='med' ? 'p-med' : 'p-high';

      const doneMeta = (t.done && t.timeCompleted)
            ? `<div class="meta">‚úî ${fmtDateTime(t.timeCompleted)}</div>`
            : '';

      center.innerHTML = `
        <div style="font-weight:600;${t.done?'text-decoration:line-through;opacity:.7':''}">
          ${escapeHtml(t.name)}
        </div>
        <div><span class="priority ${prioc}">${t.prio}</span></div>
        ${doneMeta}
      `;

      /* stars */
      const stars = document.createElement("div");
      stars.className="stars";
      for(let s=1;s<=3;s++){
        const b=document.createElement("button");
        b.textContent='‚òÖ';
        if(t.stars>=s) b.classList.add('on');
        b.onclick=()=>setStars(viewing,t.id,s);
        stars.appendChild(b);
      }

      /* actions */
      const act = document.createElement("div");
      act.className="actions";

      const eBtn = document.createElement("button");
      eBtn.textContent='‚úé';
      eBtn.onclick=()=>editTask(viewing,t.id);

      const dBtn = document.createElement("button");
      dBtn.textContent='√ó';
      dBtn.className='del';
      dBtn.onclick=()=>delTask(viewing,t.id);

      act.appendChild(eBtn);
      act.appendChild(dBtn);

      li.appendChild(cb);
      li.appendChild(center);
      li.appendChild(stars);
      li.appendChild(act);

      ul.appendChild(li);
    });
  }

  /* summary */
  const total = list.length;
  const done  = list.filter(t=>t.done).length;
  const pct   = total?Math.round((done/total)*100):0;

  const quality = list.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
  const qPct = done?Math.round((quality/(done*3))*100):0;

  document.getElementById("doneSummary").textContent =
      `${done} / ${total} tasks done (${pct}%)`;

  document.getElementById("qualitySummary").textContent =
      `Quality ${qPct}%`;

  const kpiRow = document.getElementById("kpiRow");
  if(kpiRow && kpiRow.firstElementChild){
    kpiRow.firstElementChild.textContent =
      `${done} / ${total} done (${pct}%) ¬∑ Quality ${qPct}%`;
  }

  renderMeds();
}

/* ============================================================
   HISTORY + WEEKLY REVIEW
============================================================ */
function renderHistory(){
  const wrap = document.getElementById("histList");
  if(!wrap) return;

  const q = document.getElementById("histSearch").value.trim().toLowerCase();
  const spanSel = document.getElementById("histSpan").value;

  let keys = Object.keys(days||{});
  if(spanSel!=='all'){
    const span = parseInt(spanSel,10);
    const min=new Date();
    min.setDate(min.getDate()-span);
    keys = keys.filter(k=>new Date(k)>=min);
  }

  if(q){
    keys = keys.filter(k=>{
      if(k.includes(q)) return true;
      return (days[k]||[]).some(t=>(t.name||'').toLowerCase().includes(q));
    });
  }

  keys.sort((a,b)=>new Date(b)-new Date(a));
  wrap.innerHTML='';

  if(!keys.length){
    wrap.innerHTML='<div class="muted">No history found.</div>';
    return;
  }

  keys.forEach(k=>{
    const arr=days[k]||[];
    const total=arr.length;
    const done =arr.filter(t=>t.done).length;
    const pct  = total?Math.round(done/total*100):0;

    const qsum=arr.filter(t=>t.done).reduce((a,b)=>a+(b.stars||0),0);
    const qPct = done?Math.round((qsum/(done*3))*100):0;

    const row=document.createElement("div");
    row.className="hist-row";

    const left=document.createElement("div");
    left.innerHTML=`
      <div style="font-weight:700">${fmtHumanDate(k)}</div>
      <div class="meta">${done}/${total} done ‚Ä¢ ${pct}% ¬∑ Quality ${qPct}%</div>
    `;

    const right=document.createElement("div");
    const btn=document.createElement("button");
    btn.textContent='Open';
    btn.onclick=()=>{ viewing=k; showTab('tasks'); renderAll(); };

    right.appendChild(btn);
    row.appendChild(left);
    row.appendChild(right);
    wrap.appendChild(row);
  });

  renderWeeklyReview(keys);
}

/* Weekly Review Grid */
function renderWeeklyReview(dateKeys){
  const card = document.getElementById("weeklyReviewCard");
  const grid = document.getElementById("weeklyGrid");

  if(!dateKeys.length){
    card.style.display="none";
    return;
  }

  // show last 7 days
  const last7 = dateKeys.slice(0,7).reverse();
  grid.innerHTML = '';

  last7.forEach(k=>{
    const arr = days[k]||[];
    const done= arr.filter(t=>t.done).length;
    const total=arr.length;

    const pct = total?Math.round((done/total)*100):0;

    const bar=document.createElement("div");
    bar.className='weekly-bar';

    const fill=document.createElement("div");
    fill.className='weekly-bar-fill';
    fill.style.height = pct+'%';

    bar.appendChild(fill);
    grid.appendChild(bar);
  });

  card.style.display="block";
}

/* ============================================================
   BACKUP / RESTORE
============================================================ */
function tpUpdateLastBackupLabel(){
  const el=document.getElementById("tpLastBackup");
  if(!el) return;
  el.textContent = "Last backup: " + (localStorage.getItem("tp_last_backup")||"none");
}

(function(){
  function buildBackup(){
    const dump={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(/^tp_/.test(k)) dump[k] = localStorage.getItem(k);
    }
    // include latest state
    dump[LS_KEY]  = JSON.stringify(days);
    dump[LS_MEDS] = JSON.stringify(meds);

    return {
      app:'taskpulse',
      flavor:'v8.8',
      exportedAt:new Date().toISOString(),
      dump
    };
  }

  window.tpDownloadBackup = function(){
    try{
      const payload = buildBackup();
      const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url  = URL.createObjectURL(blob);

      const a=document.createElement("a");
      a.href=url;
      a.download='taskpulse_backup.json';
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);

      localStorage.setItem("tp_last_backup", new Date().toLocaleString());
      tpUpdateLastBackupLabel();
    }
    catch(e){
      console.error("Backup failed:", e);
      alert("Backup failed.");
    }
  };

  const fi=document.getElementById("tpRestoreFile");
  if(fi){
    fi.addEventListener("change", async e=>{
      const f=e.target.files[0];
      if(!f) return;

      try{
        const text=await f.text();
        const data=JSON.parse(text);
        if(data && data.dump){
          Object.entries(data.dump).forEach(([k,v])=>{
            if(/^tp_/.test(k)) localStorage.setItem(k,v);
          });
        }
        alert("Restore complete. Reloading‚Ä¶");
        setTimeout(()=>location.reload(),600);
      } catch(err){
        console.error("Restore failed:", err);
        alert("Restore failed.");
      } finally {
        e.target.value='';
      }
    });
  }
})();

/* ============================================================
   SYNC ENGINE 2.0 ‚Äî AUTO CODE GEN
============================================================ */
const TP_UID = (localStorage.getItem("tp_uid") || (()=> {
  const v = "u_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem("tp_uid", v);
  return v;
})());

let syncRef=null, syncOff=null, writeTimer=null;

function setSyncBadge(t,kind=''){
  const el=document.getElementById("syncState");
  if(!el) return;
  el.textContent=t;
  el.className='badge '+kind;
}

const PREFIX='grp-';
function randomCode(len=6){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out=''; for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}

function ensureSyncCode(){
  let code = localStorage.getItem(LS_SYNC);
  if(!code){
    code = PREFIX+randomCode(6);
    localStorage.setItem(LS_SYNC, code);
  }
  document.getElementById("syncCode").value = code;

  if(isFirebaseReady()) attachSync(code);
}

function isFirebaseReady(){
  return (window.firebase && firebase.apps && firebase.apps.length);
}

function copySyncCode(){
  const i=document.getElementById("syncCode");
  if(!i.value) return;
  navigator.clipboard.writeText(i.value).then(()=>alert("Sync code copied"));
}

function newSyncCode(){
  if(!confirm("Generate new sync code?")) return;

  const code = PREFIX+randomCode(6);
  localStorage.setItem(LS_SYNC,code);
  document.getElementById("syncCode").value = code;

  if(syncOff) syncOff();
  if(isFirebaseReady()) attachSync(code);

  alert("New sync code generated.");
}

function saveSyncCode(){
  const i=document.getElementById("syncCode");
  if(!i.value) return;

  localStorage.setItem(LS_SYNC, i.value.trim());

  if(syncOff) syncOff();
  if(isFirebaseReady()) attachSync(i.value.trim());

  alert("Sync code saved.");
}

function notifyLocalChanged(){ debouncedPush(); }

function debouncedPush(){
  if(!syncRef) return;

  clearTimeout(writeTimer);
  writeTimer = setTimeout(()=>{
    syncRef.set({
      days,
      meds,
      _meta:{by:TP_UID, at:Date.now()}
    }).catch(console.warn);
  }, 250);
}

function attachSync(code){
  if(!isFirebaseReady()){
    setSyncBadge("Local-only");
    return;
  }

  if(syncOff) syncOff();

  syncRef = firebase.database().ref("taskpulse/"+code);
  setSyncBadge("Sync: "+code, "good");

  syncRef.get().then(snap=>{
    const val=snap.val();

    if(val && (val.days || val.meds)){
      days = mergeDays(days, val.days||{});
      meds = mergeMeds(meds, val.meds||{});

      baseSave(LS_KEY, days);
      baseSave(LS_MEDS, meds);

      renderAll();
      renderMeds();
    } else {
      debouncedPush();
    }
  });

  const handler = syncRef.on("value", snap=>{
    const val=snap.val();
    if(!val) return;

    if(val._meta && val._meta.by===TP_UID) return;

    if(val.days){
      days = mergeDays(days, val.days);
      baseSave(LS_KEY,days);
    }
    if(val.meds){
      meds = mergeMeds(meds, val.meds);
      baseSave(LS_MEDS, meds);
    }

    renderAll();
    renderMeds();
  });

  syncOff = ()=>syncRef.off("value", handler);
}

/* Merge logic */
function mergeDays(local, remote){
  const out = {...local};
  for(const d of Object.keys(remote)){
    if(!out[d]) { out[d] = remote[d]; continue; }

    const L=out[d], R=remote[d];
    const stamp = arr => arr.reduce((m,t)=>Math.max(m,new Date(t.timeCompleted||t.createdAt||0).getTime()), 0);

    out[d] = stamp(R)>stamp(L) ? R : L;
  }
  return out;
}

function mergeMeds(local, remote){
  const out = {...local};
  for(const day of Object.keys(remote)){
    const r = remote[day] || {};
    const l = out[day] || {day:'', night:''};

    const pick = (a,b)=>{
      const ta=a?Date.parse(a):0;
      const tb=b?Date.parse(b):0;
      return (tb>ta) ? b : a;
    };

    out[day] = { day:pick(l.day,r.day), night:pick(l.night,r.night) };
  }
  return out;
}

/* ============================================================
   PREDICTIVE TASK SUGGESTIONS
============================================================ */
function tpCollectTaskStats(){
  const stats=new Map();
  for(const dk of Object.keys(days)){
    for(const t of (days[dk]||[])){
      const nm=(t.name||'').trim();
      if(!nm) continue;

      const key=nm.toLowerCase();
      const last=new Date(t.createdAt||t.timeCompleted||t.updatedAt||t.date||new Date()).getTime();

      if(!stats.has(key)) stats.set(key,{name:nm,count:0,last:0});
      const s=stats.get(key);
      s.count++;
      s.last=Math.max(s.last,last);
    }
  }
  return stats;
}

function tpRankedNames(stats){
  return Array.from(stats.values())
    .sort((a,b)=> (b.count - a.count) || (b.last - a.last))
    .map(v=>v.name);
}

function tpGetSuggestions(prefix){
  const ranked=tpRankedNames(tpCollectTaskStats());
  const p=(prefix||'').trim().toLowerCase();

  if(!p) return ranked.slice(0,10);

  const pref = ranked.filter(n=>n.toLowerCase().startsWith(p));
  if(pref.length>=10) return pref.slice(0,10);

  const rest = ranked.filter(n=>!n.toLowerCase().startsWith(p)
                                && n.toLowerCase().includes(p));

  return [...pref, ...rest].slice(0,10);
}

function tpRenderDatalist(prefix){
  const dl=document.getElementById("taskSuggestions");
  if(!dl) return;

  const opts = tpGetSuggestions(prefix);
  dl.innerHTML = opts.map(n=>`<option value="${escapeHtml(n)}"></option>`).join('');
}

/* ============================================================
   SERVICE WORKER
============================================================ */
if('serviceWorker' in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>

</body>
</html>

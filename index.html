<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Task Pulse Money</title>

<link rel="icon" href="icon-192.png" sizes="192x192" type="image/png" />
<link rel="apple-touch-icon" href="icon-192.png" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0f111a" />

<style>
/* ======= base ======= */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  -webkit-font-smoothing:antialiased;
}
body{
  background:#0f111a;
  background-image:
    radial-gradient(circle at 20% 20%,rgba(80,90,255,.16)0%,rgba(15,17,26,0)60%),
    radial-gradient(circle at 80% 30%,rgba(255,0,128,.12)0%,rgba(15,17,26,0)60%);
  color:#e9e9ef;
  max-width:480px;
  margin:0 auto;
  position:relative;
}
main{
  padding:16px 16px 200px;
}

/* ======= splash screen ======= */
#splashOverlay{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at 50% 30%,rgba(89,102,255,.3)0%,rgba(0,0,0,0)70%),linear-gradient(180deg,#0f111a 0%,#000 100%);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:24px;
  z-index:9999;
  transition:opacity .6s ease, visibility .6s ease;
}
#splashLogo{
  width:88px;
  height:88px;
  border-radius:20px;
  background:radial-gradient(circle at 30% 30%,#ffffff 0%,#9ea6ff 20%,#2b2e65 60%,#0f111a 100%);
  box-shadow:
    0 30px 120px rgba(89,102,255,.6),
    0 0 80px rgba(255,0,128,.4),
    0 0 12px rgba(255,255,255,.8) inset;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#0f111a;
  font-weight:700;
  font-size:0.8rem;
  line-height:1.2;
  text-shadow:0 0 8px rgba(0,0,0,.6);
  text-align:center;
}
#splashLogo span{
  display:block;
}
#splashTitle{
  margin-top:16px;
  font-size:1.2rem;
  font-weight:600;
  color:#fff;
  text-shadow:0 0 12px rgba(89,102,255,.9);
  letter-spacing:.03em;
}
#splashTag{
  margin-top:8px;
  font-size:.8rem;
  color:#a8a8ff;
  text-shadow:0 0 8px rgba(89,102,255,.6);
}
#splashHint{
  margin-top:24px;
  font-size:.7rem;
  color:#666af9;
  opacity:.8;
}
#splashOverlay.hidden{
  opacity:0;
  visibility:hidden;
}

/* ======= header ======= */
header{
  text-align:center;
  padding:20px 12px 16px;
  background:linear-gradient(180deg,#1b1d2e 0%,#0f111a 100%);
  border-radius:0 0 20px 20px;
  box-shadow:0 10px 40px rgba(0,0,0,.6);
}
header .title{
  font-size:1.4rem;
  font-weight:700;
  color:#fff;
  letter-spacing:.5px;
  text-shadow:0 0 8px rgba(89,102,255,.7);
}
header .date{
  font-size:.9rem;
  color:#bdbdfd;
  margin-top:6px;
}

/* ======= tab bar ======= */
.tab-bar{
  display:flex;
  justify-content:center;
  gap:8px;
  padding:16px;
  flex-wrap:wrap;
}
.tab-btn{
  flex:1;
  text-align:center;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.15);
  color:#c7c7ff;
  padding:12px 14px 8px;
  border-radius:12px;
  font-size:.9rem;
  font-weight:500;
  transition:all .25s ease;
  backdrop-filter:blur(6px);
  box-shadow:0 6px 18px rgba(0,0,0,.3);
  line-height:1.2;
  min-width:140px;
  position:relative;
}
.tab-btn:hover{
  transform:translateY(-1px);
  cursor:pointer;
}
.tab-btn.tab-active{
  background:#ffffff;
  color:#1a1a1a;
  border:1px solid #ffffff;
  box-shadow:0 0 16px rgba(89,102,255,.7);
}
.tab-label-main{
  font-size:.9rem;
  font-weight:600;
}
.tab-label-sub{
  font-size:.7rem;
  opacity:.8;
  margin-top:2px;
  font-weight:400;
}

/* ======= cards ======= */
.card{
  background:#ffffff;
  border:1px solid rgba(255,255,255,0.6);
  border-radius:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.5);
  padding:16px;
  margin-bottom:20px;
  color:#1a1a1a;
}
.section-headline{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  row-gap:8px;
  margin-bottom:12px;
}
.section-title{
  font-size:1rem;
  font-weight:600;
  color:#111;
  display:flex;
  align-items:center;
  gap:6px;
}
.section-sub{
  font-size:.8rem;
  color:#444;
  text-align:right;
  min-width:max-content;
  padding-left:8px;
  line-height:1.3;
}
.small{
  font-size:.8rem;
  color:#666;
}

/* ======= spend rows ======= */
.spend-row,
.spend-total-row{
  display:grid;
  grid-template-columns:1fr auto auto;
  align-items:flex-start;
  column-gap:8px;
  font-size:.8rem;
  line-height:1.4;
  word-break:break-word;
  position:relative;
}
.spend-row{
  padding:8px 0;
  border-bottom:1px solid #e4e4e7;
}
.spend-total-row{
  font-weight:600;
  color:#c00000;
  padding-top:12px;
}
.spend-left{}
.spend-middle{text-align:right;}
.spend-right{text-align:right;min-width:70px;}
.spend-total-row .spend-right{
  color:#c00000;
  font-size:1rem;
}
.spend-amount{
  font-size:.9rem;
  font-weight:600;
  color:#1a1a1a;
}

/* action buttons on each spend row */
.row-actions{
  display:flex;
  gap:6px;
  position:absolute;
  right:0;
  top:0;
  transform:translateY(-50%);
}
.row-action-btn{
  background:#fff;
  border:1px solid #cfcfd3;
  border-radius:8px;
  font-size:.7rem;
  line-height:1;
  min-width:30px;
  min-height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#1a1a1a;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
}
.row-action-edit{
  color:#0050c9;
  border-color:#a9c8ff;
}
.row-action-del{
  color:#c00000;
  border-color:#ffbfc1;
}

/* chips */
.inline-chips{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:4px;
  border-radius:6px;
  padding:2px 6px;
  font-size:.7rem;
  font-weight:600;
  line-height:1.2;
  box-shadow:0 3px 6px rgba(0,0,0,.08);
  max-width:100%;
  white-space:nowrap;
}
.chip-icon{
  font-size:.8rem;
  line-height:1;
}

/* per-type background colors (emoji style) */
.type-food        { background:#e8f8d8; color:#1a1a1a; }
.type-fuel        { background:#fff8d6; color:#4a3b00; }
.type-clothing    { background:#f2d9f6; color:#4a125c; }
.type-Medicine    { background:#eae4ff; color:#2c1160; }
.type-electricity { background:#d5efff; color:#003049; }

/* per-payer colors */
.payer-presh      { background:#ffe5ef; color:#5a0021; }
.payer-daryl      { background:#e2f2ff; color:#002a4f; }

/* shop chip base */
.shop-chip        { background:#fff0dc; color:#3a2600; }

/* subtext */
.spend-meta{
  font-size:.7rem;
  color:#444;
  line-height:1.3;
  margin-top:4px;
}

/* search bar */
.search-row{
  width:100%;
  margin-bottom:12px;
}
.search-input{
  width:100%;
  border:1px solid #cfcfd3;
  border-radius:10px;
  padding:8px 10px;
  font-size:.8rem;
  background:#fff;
  color:#1a1a1a;
}
.search-hint{
  font-size:.7rem;
  color:#666;
  margin-top:4px;
}

/* over-limit warning */
.limit-warning{
  font-size:.75rem;
  color:#c00000;
  font-weight:600;
  margin-top:8px;
  line-height:1.3;
  display:none;
}

/* ======= input rows (add spend) ======= */
.input-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:8px;
}
.input-field,
.input-select{
  flex:1;
  min-width:120px;
  border:1px solid #cfcfd3;
  border-radius:10px;
  padding:10px 12px;
  font-size:.9rem;
  background:#fff;
  color:#1a1a1a;
}
.input-small{
  width:90px;
  flex:0 0 auto;
}
.add-btn{
  border-radius:10px;
  background:#1d1d1f;
  color:#fff;
  border:1px solid #1d1d1f;
  font-size:.85rem;
  font-weight:500;
  padding:10px 14px;
  min-width:70px;
  line-height:1.2;
}
.clear-btn{
  border-radius:10px;
  background:#fff;
  color:#1d1d1f;
  border:1px solid #cfcfd3;
  font-size:.8rem;
  font-weight:500;
  padding:8px 12px;
  min-width:110px;
  line-height:1.2;
}

/* ======= day nav ======= */
.history-headline{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  row-gap:8px;
  margin-bottom:12px;
  align-items:flex-start;
}
.history-left .small-top{
  font-size:.8rem;
  color:#444;
  line-height:1.2;
}
.history-left .hist-date{
  font-size:.9rem;
  font-weight:600;
  color:#111;
  line-height:1.3;
}
.history-nav{
  display:flex;
  gap:8px;
}
.history-nav button{
  background:#fff;
  border:1px solid #cfcfd3;
  color:#1d1d1f;
  padding:8px 10px;
  border-radius:10px;
  font-weight:500;
  min-width:44px;
  min-height:36px;
  line-height:1;
  font-size:1rem;
}

/* ======= summary / reports ======= */
.summary-grid{
  width:100%;
  font-size:.8rem;
  line-height:1.4;
  border-top:1px solid #e4e4e7;
  margin-top:8px;
  padding-top:8px;
}
.summary-row{
  display:flex;
  justify-content:space-between;
  border-radius:8px;
  align-items:flex-start;
  padding:4px 8px;
  margin-bottom:4px;
  font-weight:500;
}
.sum-left{}
.sum-right{
  min-width:90px;
  text-align:right;
  font-weight:600;
}
.summary-total{
  color:#c00000;
  font-weight:600;
  padding:6px 0 0;
  margin-top:8px;
  display:flex;
  justify-content:space-between;
}
.summary-total .sum-right{
  color:#c00000;
}

/* summary color reuse */
.summary-row.type-food        { background:#e8f8d8; color:#1a1a1a; }
.summary-row.type-fuel        { background:#fff8d6; color:#4a3b00; }
.summary-row.type-clothing    { background:#f2d9f6; color:#4a125c; }
.summary-row.type-Medicine    { background:#eae4ff; color:#2c1160; }
.summary-row.type-electricity { background:#d5efff; color:#003049; }

.summary-row.payer-presh      { background:#ffe5ef; color:#5a0021; }
.summary-row.payer-daryl      { background:#e2f2ff; color:#002a4f; }

/* highlights / trends */
.report-block-title{
  font-size:.75rem;
  font-weight:600;
  color:#111;
  margin:16px 0 4px;
  line-height:1.2;
  display:flex;
  justify-content:space-between;
}
.report-block-title:first-child{
  margin-top:0;
}
.report-block-title span{
  font-weight:400;
  font-size:.7rem;
  color:#666;
}
.highlight-block{
  background:#f5f5f7;
  border:1px solid #d9d9de;
  border-radius:10px;
  padding:8px 12px;
  font-size:.75rem;
  line-height:1.4;
  color:#1a1a1a;
  margin-top:8px;
}
.highlight-line{
  display:flex;
  justify-content:space-between;
  margin-bottom:4px;
}
.highlight-left{
  font-weight:500;
  color:#111;
}
.highlight-right{
  font-weight:500;
  text-align:right;
  min-width:90px;
  color:#111;
}

/* weekly trend mini card */
.trend-block{
  background:#f5f5f7;
  border:1px solid #d9d9de;
  border-radius:10px;
  padding:8px 12px;
  font-size:.75rem;
  line-height:1.4;
  color:#1a1a1a;
  margin-top:12px;
}
.trend-row{
  margin-bottom:4px;
}
.trend-label{
  font-weight:500;
  color:#111;
}
.trend-value{
  font-weight:500;
  color:#111;
  text-align:right;
}

/* ======= groceries ======= */
.grocery-list-area{
  border-top:1px solid #e4e4e7;
  margin-top:8px;
  padding-top:8px;
}
.grocery-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid #e4e4e7;
  padding:8px 0;
  font-size:.85rem;
  line-height:1.4;
  flex-wrap:wrap;
  row-gap:6px;
}
.grocery-left{
  display:flex;
  align-items:center;
  gap:8px;
  color:#111;
  flex:1;
  min-width:0;
}
.grocery-left-mainline{
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:8px;
  min-width:0;
  font-size:.8rem;
  line-height:1.3;
  color:#111;
  font-weight:500;
  white-space:nowrap;
}
.grocery-name-inline{
  font-weight:500;
  color:#111;
  max-width:120px;
  text-overflow:ellipsis;
  overflow:hidden;
  white-space:nowrap;
}
.grocery-name-inline.grocery-done{
  color:#888;
  text-decoration:line-through;
}
.grocery-timestamp{
  font-size:.7rem;
  color:#666;
  white-space:nowrap;
}
.grocery-actions{
  display:flex;
  gap:6px;
  flex-shrink:0;
}
.grocery-edit,
.grocery-del,
.grocery-move{
  background:#fff;
  border-radius:8px;
  font-size:.8rem;
  font-weight:600;
  line-height:1;
  min-width:32px;
  min-height:32px;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  border:1px solid #cfcfd3;
  color:#1a1a1a;
}
.grocery-edit{
  border-color:#a9c8ff;
  color:#0050c9;
}
.grocery-del{
  border-color:#ffbfc1;
  color:#c00000;
}
.grocery-move{
  border-color:#cfcfd3;
  color:#111;
}
.grocery-row.done{
  background:#f2f2f5;
}

/* ======= export card / settings ======= */
.export-note{
  font-size:.7rem;
  color:#555;
  line-height:1.4;
  margin-top:8px;
}
.export-buttons{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}
.export-btn{
  flex:1;
  min-width:140px;
  text-align:center;
  background:#1d1d1f;
  color:#fff;
  border:1px solid #1d1d1f;
  border-radius:10px;
  font-size:.8rem;
  font-weight:500;
  padding:10px 12px;
  line-height:1.3;
  box-shadow:0 12px 30px rgba(0,0,0,.4);
}
.export-btn.light{
  background:#fff;
  color:#1d1d1f;
  border:1px solid #cfcfd3;
  box-shadow:0 12px 30px rgba(0,0,0,.15);
}

.settings-line{
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:8px;
  font-size:.8rem;
  line-height:1.3;
  margin-bottom:8px;
  color:#1a1a1a;
}
.settings-line label{
  display:flex;
  align-items:center;
  gap:4px;
  flex-wrap:wrap;
  justify-content:center;
}
.settings-input{
  width:90px;
  border-radius:6px;
  border:1px solid #cfcfd3;
  padding:4px 6px;
  font-size:.8rem;
  line-height:1.2;
  background:#fff;
  color:#1a1a1a;
  text-align:center;
}
.settings-footnote{
  font-size:.7rem;
  color:#777;
  text-align:center;
  line-height:1.4;
}
.power-line{
  font-size:.7rem;
  color:#444;
  text-align:center;
  font-weight:500;
  margin-top:8px;
}
</style>
</head>

<body>

<!-- Splash overlay -->
<div id="splashOverlay">
  <div id="splashLogo">
    <span>TASK<br/>PULSE</span>
  </div>
  <div id="splashTitle">Task Pulse Money</div>
  <div id="splashTag">Powered by Daryl G</div>
  <div id="splashHint">loading offline dashboard…</div>
</div>

<header>
  <div class="title">Task Pulse</div>
  <div class="date" id="headerToday">--</div>
</header>

<nav class="tab-bar">
  <button id="tabSpend" class="tab-btn tab-active">
    <div class="tab-label-main">Spend</div>
    <div class="tab-label-sub" id="tabSpendSub">R 0.00 today</div>
  </button>
  <button id="tabGroceries" class="tab-btn">
    <div class="tab-label-main">Groceries</div>
    <div class="tab-label-sub" id="tabGroSub">0 items</div>
  </button>
</nav>

<main>

  <!-- SCREEN: SPEND -->
  <div id="spendScreen">

    <!-- CARD: Day Spending with search + warning -->
    <section class="card" id="dayCard">
      <div class="section-headline">
        <div class="section-title">
          <span>Spending (this day)</span>
          <span id="overLimitIcon" style="display:none;color:#c00000;font-size:.8rem;">⚠</span>
        </div>
        <div class="section-sub" id="dayTotalLine">R 0.00</div>
      </div>

      <!-- search/filter -->
      <div class="search-row">
        <input id="searchInput" class="search-input" placeholder="filter by item / shop / payer / type…" />
        <div class="search-hint" id="searchHint">0 matches · R 0.00</div>
      </div>

      <div id="spendList"></div>

      <div class="spend-total-row">
        <div class="spend-left"></div>
        <div class="spend-middle"></div>
        <div class="spend-right spend-amount" id="spendTotalRed">R 0.00</div>
      </div>

      <div class="limit-warning" id="limitWarning">Over daily limit</div>
    </section>

    <!-- CARD: Add purchase -->
    <section class="card">
      <div class="section-headline" style="margin-bottom:8px;">
        <div class="section-title">Add new purchase</div>
        <div class="section-sub" style="font-size:.7rem;line-height:1.3;">
          date/time auto<br/>saved
        </div>
      </div>

      <div class="input-row">
        <select id="newItem" class="input-select"></select>
        <select id="newShop" class="input-select"></select>
      </div>

      <div class="input-row">
        <select id="newType" class="input-select"></select>

        <select id="newPayer" class="input-select">
          <option value="presh">presh</option>
          <option value="daryl">daryl</option>
        </select>

        <input id="newAmount" class="input-field input-small"
               type="number" min="0" step="0.01" placeholder="R" />
      </div>

      <div class="input-row" style="align-items:flex-start;">
        <button id="addSpendBtn" class="add-btn">Add</button>
        <button id="clearDayBtn" class="clear-btn">Clear this day</button>
      </div>

      <div class="small" style="color:#666;">
        • Payer = who paid.<br/>
        • Shop & Type are tracked so reports match.<br/>
        • Saved offline + synced to your account.
      </div>
    </section>

    <!-- CARD: Day navigation -->
    <section class="card">
      <div class="history-headline">
        <div class="history-left">
          <div class="small-top small">Viewing</div>
          <div class="hist-date" id="viewingDateLabel">--</div>
        </div>
        <div class="history-nav">
          <button id="prevDayBtn">◀</button>
          <button id="nextDayBtn">▶</button>
        </div>
      </div>

      <div class="small" id="viewingDayStats" style="color:#444;margin-bottom:8px;">
        0 entries · R 0.00
      </div>
      <div class="small" style="color:#444;">
        Use ◀ ▶ to move through dates. Totals + summary update.
      </div>
    </section>

    <!-- CARD: 7-day summary from viewing date -->
    <section class="card">
      <div class="section-headline">
        <div class="section-title">Summary</div>
        <div class="section-sub" style="line-height:1.3;text-align:right;">
          <div id="summaryRangeDate">--</div>
          <div style="font-size:.7rem;color:#666;">7 days from view</div>
        </div>
      </div>

      <div class="summary-grid" id="summaryGrid"></div>

      <!-- Weekly trend card -->
      <div class="trend-block" id="trendBlock">
        <div class="trend-row">
          <span class="trend-label">Highest spend day:</span><br/>
          <span class="trend-value" id="trendHighDay">--</span>
        </div>
        <div class="trend-row">
          <span class="trend-label">Top payer:</span><br/>
          <span class="trend-value" id="trendTopPayer">--</span>
        </div>
        <div class="trend-row">
          <span class="trend-label">Top shop:</span><br/>
          <span class="trend-value" id="trendTopShop">--</span>
        </div>
      </div>
    </section>

    <!-- CARD: Custom 7-day report -->
    <section class="card">
      <div class="section-headline">
        <div class="section-title">7 Day Report</div>
        <div class="section-sub" style="line-height:1.3;text-align:right;">
          <input id="weekPicker" class="input-field"
                 type="date" style="padding:6px 8px;font-size:.8rem;min-width:120px;" />
        </div>
      </div>

      <div class="summary-grid" id="weekReportGrid"></div>
    </section>

    <!-- CARD: Monthly report -->
    <section class="card">
      <div class="section-headline">
        <div class="section-title">Monthly Report</div>
        <div class="section-sub" style="line-height:1.3;text-align:right;">
          <input id="monthPicker" class="input-field"
                 type="month" style="padding:6px 8px;font-size:.8rem;min-width:120px;" />
        </div>
      </div>

      <div class="summary-grid" id="monthReportGrid"></div>
    </section>

    <!-- CARD: Export + Settings -->
    <section class="card" style="text-align:center;">
      <div class="section-headline" style="margin-bottom:4px;">
        <div class="section-title" style="justify-content:center;width:100%;">
          Backup / Settings
        </div>
      </div>

      <div class="export-buttons">
        <button class="export-btn" id="exportSpendsBtn">Export Spending CSV</button>
        <button class="export-btn light" id="exportGroceriesBtn">Export Groceries CSV</button>
      </div>

      <div class="export-note">
        Tip: Save CSV to Drive or mail it to yourself.
      </div>

      <div style="border-top:1px solid #d9d9de; margin-top:16px; padding-top:16px;">
        <div class="settings-line">
          <label>
            Daily Limit (R):
            <input id="limitInput" class="settings-input" type="number" min="0" step="50" />
          </label>
        </div>
        <div class="settings-footnote">
          We'll warn you if daily spend > this limit.<br/>
          Limit syncs across your signed-in devices.
        </div>

        <div class="power-line">
          Task Pulse Money • build v1.5<br/>
          Powered by Daryl G
        </div>
      </div>
    </section>

  </div><!-- /spendScreen -->


  <!-- SCREEN: GROCERIES -->
  <div id="groceryScreen" style="display:none;">
    <section class="card">
      <div class="section-headline" style="margin-bottom:8px;">
        <div class="section-title">Groceries</div>
        <div class="section-sub" style="font-size:.7rem;line-height:1.3;">
          Offline list<br/>syncs when online
        </div>
      </div>

      <div class="input-row">
        <select id="newGroceryItem" class="input-select"></select>
        <button id="addGroceryBtn" class="add-btn" style="min-width:60px;">Add</button>
      </div>

      <div id="groceryList" class="grocery-list-area"></div>

      <div class="small" style="color:#666;margin-top:8px;">
        • ✓ marks bought.<br/>
        • ✎ rename.<br/>
        • × delete.<br/>
        • ➕ move to Spend.
      </div>
    </section>
  </div><!-- /groceryScreen -->

</main>

<script>
/* ===== Date/time helpers ===== */
function pad2(n){return String(n).padStart(2,"0");}
function todayISO(){
  const d=new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function formatISOasDMY(iso){
  const [y,m,d]=iso.split("-");
  return d+"-"+m+"-"+y;
}
function nowTime12h(){
  const d=new Date();
  let h=d.getHours(), m=d.getMinutes();
  const ampm = h>=12 ? "PM":"AM";
  h = (h%12)||12;
  return h+":"+pad2(m)+" "+ampm;
}
function shiftISO(iso, delta){
  const [Y,M,D]=iso.split("-");
  const base=new Date(Number(Y),Number(M)-1,Number(D));
  base.setDate(base.getDate()+delta);
  return base.getFullYear()+"-"+pad2(base.getMonth()+1)+"-"+pad2(base.getDate());
}
function getISODateNDaysBefore(iso, n){
  return shiftISO(iso, -n);
}

/* ===== String helpers ===== */
function escapeHTML(str){
  return String(str).replace(/[&<>"]/g, c=>{
    const map={"&":"&amp;","<":"&lt;",">":"&gt;"};
    return map[c]||c;
  });
}

/* ===== Storage: spends, groceries ===== */
function loadSpends(){return JSON.parse(localStorage.getItem("tp_spends")||"[]");}
function saveSpends(list){localStorage.setItem("tp_spends",JSON.stringify(list));}

function loadGroceries(){return JSON.parse(localStorage.getItem("tp_groceries")||"[]");}
function saveGroceries(list){localStorage.setItem("tp_groceries",JSON.stringify(list));}

/* ===== Storage: dropdown vocab ===== */
function loadItems(){return JSON.parse(localStorage.getItem("tp_items")||"[]");}
function saveItems(list){localStorage.setItem("tp_items",JSON.stringify(list));}

function loadShops(){return JSON.parse(localStorage.getItem("tp_shops")||"[]");}
function saveShops(list){localStorage.setItem("tp_shops",JSON.stringify(list));}

function loadTypes(){return JSON.parse(localStorage.getItem("tp_types")||"[]");}
function saveTypes(list){localStorage.setItem("tp_types",JSON.stringify(list));}

function loadGroceriesOptions(){return JSON.parse(localStorage.getItem("tp_grocery_names")||"[]");}
function saveGroceriesOptions(list){localStorage.setItem("tp_grocery_names",JSON.stringify(list));}

/* ===== App Settings (daily limit, etc.) ===== */
function loadSettings(){
  return JSON.parse(localStorage.getItem("tp_settings") || "{}");
}
function saveSettings(settings){
  localStorage.setItem("tp_settings", JSON.stringify(settings));
}
function getDailyLimit(){
  const s=loadSettings();
  return s.dailyLimit || 800; // default
}
function setDailyLimit(v){
  const s=loadSettings();
  s.dailyLimit = Number(v)||0;
  saveSettings(s);
  renderAll();
  // also push settings up to sync
  syncPush();
}

/* ===== Last tab memory ===== */
function saveLastTab(tabName){
  localStorage.setItem("tp_lastTab",tabName);
}
function loadLastTab(){
  return localStorage.getItem("tp_lastTab") || "spend";
}

/* ===== Ensure defaults ===== */
function ensureDefaultLists(){
  if(!loadItems().length){
    saveItems(["milk","bread","fuel","coffee"]);
  }
  if(!loadShops().length){
    saveShops(["bp","engen","food lovers","Checkers","Pick n Pay"]);
  }
  if(!loadTypes().length){
    saveTypes(["food","fuel","clothing","Medicine","electricity"]);
  }
  if(!loadGroceriesOptions().length){
    saveGroceriesOptions(["bread","milk","eggs","butter"]);
  }
}

/* ===== Data model creators ===== */
function newSpend({item,shop,type,payer,amount}){
  return {
    id:"s_"+Math.random().toString(36).slice(2,9),
    item,
    shop,
    type,
    payer,
    amount:Number(amount)||0,
    date: todayISO(),
    time: nowTime12h()
  };
}
function newGroceryItem(name){
  return {
    id:"g_"+Math.random().toString(36).slice(2,9),
    name:name,
    done:false,
    date: todayISO(),
    time: nowTime12h()
  };
}

/* ===== State ===== */
let viewingDate = todayISO();
let searchFilter = ""; // live filter text for spend list
let pendingSpendDraft = null; // {item, shop, type, payer} from grocery ➕

/* ===== Chip builders (emoji icons) ===== */
function emojiForType(t){
  switch(t){
    case "fuel": return "⛽";
    case "food": return "🍔";
    case "clothing": return "👕";
    case "Medicine": return "💊";
    case "electricity": return "🔌";
    default: return "🛒";
  }
}
function emojiForShop(shop){
  if(!shop) return "🏬";
  const s=shop.toLowerCase();
  if(s.includes("bp")||s.includes("engen")) return "⛽";
  if(s.includes("checkers")||s.includes("pick")) return "🛒";
  if(s.includes("food")) return "🥕";
  return "🏬";
}

/* ===== Dropdown rendering ===== */
function optionListHTML(arr){
  return arr.map(v=>`<option value="${escapeHTML(v)}">${escapeHTML(v)}</option>`).join("");
}
function renderItemSelect(){
  ensureDefaultLists();
  const el=document.getElementById("newItem");
  const arr=loadItems();
  el.innerHTML=`
    <option value="">(choose item)</option>
    ${optionListHTML(arr)}
    <option value="__add_new__">+ Add new item…</option>
  `;
  if(pendingSpendDraft && pendingSpendDraft.item){
    el.value=pendingSpendDraft.item;
  }
}
function renderShopSelect(){
  ensureDefaultLists();
  const el=document.getElementById("newShop");
  const arr=loadShops();
  el.innerHTML=`
    <option value="">(choose shop)</option>
    ${optionListHTML(arr)}
    <option value="__add_new__">+ Add new shop…</option>
  `;
  if(pendingSpendDraft && pendingSpendDraft.shop){
    el.value=pendingSpendDraft.shop;
  }
}
function renderTypeSelect(){
  ensureDefaultLists();
  const el=document.getElementById("newType");
  const arr=loadTypes();
  el.innerHTML=`
    <option value="">(choose type)</option>
    ${optionListHTML(arr)}
    <option value="__add_new__">+ Add new type…</option>
  `;
  if(pendingSpendDraft && pendingSpendDraft.type){
    el.value=pendingSpendDraft.type;
  }
}
function renderGroceryNameSelect(){
  ensureDefaultLists();
  const el=document.getElementById("newGroceryItem");
  const arr=loadGroceriesOptions();
  el.innerHTML=`
    <option value="">(choose item)</option>
    ${optionListHTML(arr)}
    <option value="__add_new__">+ Add new grocery…</option>
  `;
}

/* ===== onChange handlers for adding new vocab ===== */
function onItemChange(){
  const sel=document.getElementById("newItem");
  if(sel.value==="__add_new__"){
    const fresh=prompt("New item name?");
    if(fresh && fresh.trim()){
      const arr=loadItems();
      const clean=fresh.trim();
      if(!arr.includes(clean)){
        arr.push(clean);
        saveItems(arr);
      }
    }
    renderItemSelect();
  }
}
function onShopChange(){
  const sel=document.getElementById("newShop");
  if(sel.value==="__add_new__"){
    const fresh=prompt("New shop / place name?");
    if(fresh && fresh.trim()){
      const arr=loadShops();
      const clean=fresh.trim();
      if(!arr.includes(clean)){
        arr.push(clean);
        saveShops(arr);
      }
    }
    renderShopSelect();
  }
}
function onTypeChange(){
  const sel=document.getElementById("newType");
  if(sel.value==="__add_new__"){
    const fresh=prompt("New type?");
    if(fresh && fresh.trim()){
      const arr=loadTypes();
      const clean=fresh.trim();
      if(!arr.includes(clean)){
        arr.push(clean);
        saveTypes(arr);
      }
    }
    renderTypeSelect();
  }
}
function onGroceryNameChange(){
  const sel=document.getElementById("newGroceryItem");
  if(sel.value==="__add_new__"){
    const fresh=prompt("New grocery item?");
    if(fresh && fresh.trim()){
      const arr=loadGroceriesOptions();
      const clean=fresh.trim();
      if(!arr.includes(clean)){
        arr.push(clean);
        saveGroceriesOptions(arr);
      }
    }
    renderGroceryNameSelect();
  }
}

/* ===== Spend CRUD ===== */
function addSpend(){
  const itemEl   = document.getElementById("newItem");
  const shopEl   = document.getElementById("newShop");
  const typeEl   = document.getElementById("newType");
  const payerEl  = document.getElementById("newPayer");
  const amtEl    = document.getElementById("newAmount");

  const rawItem  = itemEl.value;
  const rawShop  = shopEl.value;
  const rawType  = typeEl.value;
  const rawPayer = payerEl.value;
  const amtVal   = amtEl.value.trim();

  // convert special __add_new__ (shouldn't really persist)
  const itemVal = (rawItem==="__add_new__")?"":rawItem.trim();
  const shopVal = (rawShop==="__add_new__")?"":rawShop.trim();
  const typeVal = (rawType==="__add_new__")?"":rawType.trim();

  if(!itemVal || !amtVal){return;}

  const all=loadSpends();
  all.push(newSpend({
    item:itemVal,
    shop:shopVal,
    type:typeVal,
    payer:rawPayer,
    amount:amtVal
  }));
  saveSpends(all);

  // clear amount, keep last payer/type/shop as memory,
  // but drop pending draft (we used it)
  amtEl.value="";
  pendingSpendDraft=null;

  // sync push
  syncPush();

  // jump to today's date view
  viewingDate = todayISO();
  renderAll();
}

function clearDay(){
  const all=loadSpends();
  const keep=all.filter(s=>s.date!==viewingDate);
  saveSpends(keep);
  syncPush();
  renderAll();
}

function deleteSpend(id){
  let all=loadSpends();
  all=all.filter(s=>s.id!==id);
  saveSpends(all);
  syncPush();
  renderAll();
}

function editSpend(id){
  const all=loadSpends();
  const item=all.find(s=>s.id===id);
  if(!item){return;}

  const newItem = prompt("Edit item:", item.item);
  if(newItem===null)return;
  const newShop = prompt("Edit shop:", item.shop||"");
  if(newShop===null)return;
  const newType = prompt("Edit type:", item.type||"");
  if(newType===null)return;
  const newPayer= prompt("Edit payer (presh/daryl):", item.payer);
  if(newPayer===null)return;
  const newAmt  = prompt("Edit amount (number):", item.amount);
  if(newAmt===null)return;

  item.item   = newItem.trim()   || item.item;
  item.shop   = newShop.trim();
  item.type   = newType.trim()   || item.type;
  item.payer  = newPayer.trim()  || item.payer;
  item.amount = Number(newAmt)||0;

  saveSpends(all);
  syncPush();
  renderAll();
}

function goPrevDay(){
  viewingDate = shiftISO(viewingDate, -1);
  renderAll();
}
function goNextDay(){
  viewingDate = shiftISO(viewingDate, +1);
  renderAll();
}

/* ===== Groceries CRUD ===== */
function addGrocery(){
  const sel=document.getElementById("newGroceryItem");
  const val=sel.value;
  if(!val || val==="__add_new__")return;

  const list=loadGroceries();
  list.push(newGroceryItem(val));
  saveGroceries(list);

  syncPush();

  renderGroceries();
  updateTabBadges();
}

function toggleGroceryDone(id){
  const list=loadGroceries();
  const it=list.find(g=>g.id===id);
  if(it){
    it.done=!it.done;
    saveGroceries(list);
    syncPush();
    renderGroceries();
    updateTabBadges();
  }
}

function deleteGroceryItem(id){
  let list=loadGroceries();
  list=list.filter(g=>g.id!==id);
  saveGroceries(list);
  syncPush();
  renderGroceries();
  updateTabBadges();
}

function editGroceryItem(id){
  const list=loadGroceries();
  const row=list.find(g=>g.id===id);
  if(!row)return;

  const updated = prompt("Edit grocery item:", row.name);
  if(updated===null)return;
  const clean = updated.trim();
  if(clean){
    row.name=clean;
    saveGroceries(list);
    syncPush();
    renderGroceries();
    updateTabBadges();
  }
}

/* ➕ Move grocery -> Spend draft */
function moveGroceryToSpend(id){
  const list=loadGroceries();
  const row=list.find(g=>g.id===id);
  if(!row)return;

  // mark the grocery as done
  row.done=true;
  saveGroceries(list);

  // create spend draft: guess type=food, payer=daryl by default
  pendingSpendDraft={
    item: row.name,
    shop: "",           // you'll pick
    type: "food",
    payer: "daryl"
  };

  // show spend tab and re-render selects with draft values
  showSpendScreen();
  renderAll();
  focusAmountField();

  syncPush();
}

function focusAmountField(){
  const amt=document.getElementById("newAmount");
  if(amt){ amt.focus(); }
}

/* ===== Filtering / search ===== */
function setSearchFilter(val){
  searchFilter=val.trim().toLowerCase();
  renderDayCard(); // re-render spend list with current filter
}

/* ===== Math / summaries ===== */
function sumAmounts(list){
  return list.reduce((acc,s)=>acc+Number(s.amount||0),0);
}
function getSpendsForDate(dateIso){
  return loadSpends().filter(s=>s.date===dateIso);
}
function inRange(dateIso,startIso,endIso){
  return dateIso>=startIso && dateIso<=endIso;
}
function collectRangeData(startIso,endIso){
  const all=loadSpends();
  const byType={},byPayer={},byShop={},byDay={};
  let totalAll=0;

  for(const s of all){
    if(inRange(s.date,startIso,endIso)){
      const amt=Number(s.amount||0);
      totalAll+=amt;

      // by type
      if(!byType[s.type])byType[s.type]=0;
      byType[s.type]+=amt;

      // by payer
      if(!byPayer[s.payer])byPayer[s.payer]=0;
      byPayer[s.payer]+=amt;

      // by shop
      const shopKey=s.shop && s.shop.trim()?s.shop.trim():"(no shop)";
      if(!byShop[shopKey])byShop[shopKey]=0;
      byShop[shopKey]+=amt;

      // by day
      if(!byDay[s.date])byDay[s.date]=0;
      byDay[s.date]+=amt;
    }
  }

  // top shop
  let topShopName="", topShopAmt=0;
  Object.keys(byShop).forEach(sh=>{
    if(byShop[sh]>topShopAmt){
      topShopAmt=byShop[sh];
      topShopName=sh;
    }
  });

  // top type
  let topTypeName="", topTypeAmt=0;
  Object.keys(byType).forEach(t=>{
    if(byType[t]>topTypeAmt){
      topTypeAmt=byType[t];
      topTypeName=t;
    }
  });

  // top payer
  let topPayerName="", topPayerAmt=0;
  Object.keys(byPayer).forEach(p=>{
    if(byPayer[p]>topPayerAmt){
      topPayerAmt=byPayer[p];
      topPayerName=p;
    }
  });

  // highest-spend day
  let highDayDate="", highDayAmt=0;
  Object.keys(byDay).forEach(d=>{
    if(byDay[d]>highDayAmt){
      highDayAmt=byDay[d];
      highDayDate=d;
    }
  });

  return {
    totalAll,
    byType,
    byPayer,
    byShop,
    byDay,
    topShop:{name:topShopName,amount:topShopAmt},
    topType:{name:topTypeName,amount:topTypeAmt},
    topPayer:{name:topPayerName,amount:topPayerAmt},
    highDay:{date:highDayDate,amount:highDayAmt},
    startIso,
    endIso
  };
}
function get7DaySummaryFromViewing(viewIso){
  const endIso=viewIso;
  const startIso=getISODateNDaysBefore(viewIso,6);
  return collectRangeData(startIso,endIso);
}
function getCustom7DaySummary(endIso){
  const startIso=getISODateNDaysBefore(endIso,6);
  return collectRangeData(startIso,endIso);
}
function getMonthSummary(monthStr){
  if(!monthStr || !monthStr.includes("-")) return null;
  const [Y,M]=monthStr.split("-");
  const startIso=Y+"-"+M+"-01";
  const lastDay=new Date(Number(Y),Number(M),0).getDate();
  const endIso=Y+"-"+M+"-"+pad2(lastDay);

  const data=collectRangeData(startIso,endIso);
  data.monthLabel=monthStr;
  return data;
}

/* ===== Tab badges ===== */
function updateTabBadges(){
  // Spend tab badge
  const tList=getSpendsForDate(todayISO());
  const tTotal=sumAmounts(tList);
  document.getElementById("tabSpendSub").textContent=
    formatCurrencyR(tTotal)+" today";

  // Grocery tab badge
  const gro=loadGroceries();
  const remaining=gro.filter(g=>!g.done).length;
  document.getElementById("tabGroSub").textContent=
    remaining+" item"+(remaining===1?"":"s");
}

/* ===== Render header ===== */
function renderHeader(){
  document.getElementById("headerToday").textContent=formatISOasDMY(todayISO());
}

/* ===== Currency formatting ===== */
function formatCurrencyR(amount){
  const n = Number(amount||0);
  return "R " + n.toLocaleString("en-ZA", {
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}

/* ===== Spend row builders ===== */
function buildSpendRowHTML(s){
  // filter logic
  if(searchFilter){
    const hay = (
      (s.item||"")+" "+
      (s.shop||"")+" "+
      (s.type||"")+" "+
      (s.payer||"")
    ).toLowerCase();
    if(!hay.includes(searchFilter)){
      return ""; // filtered out
    }
  }

  // chips line
  const chips = [];

  if(s.shop){
    chips.push(`
      <span class="chip shop-chip">
        <span class="chip-icon">${emojiForShop(s.shop)}</span>
        <span>${escapeHTML(s.shop)}</span>
      </span>
    `);
  }

  if(s.type){
    chips.push(`
      <span class="chip type-${escapeHTML(s.type)}">
        <span class="chip-icon">${emojiForType(s.type)}</span>
        <span>${escapeHTML(s.type)}</span>
      </span>
    `);
  }

  if(s.payer){
    chips.push(`
      <span class="chip payer-${escapeHTML(s.payer)}">
        <span>${escapeHTML(s.payer)}</span>
      </span>
    `);
  }

  return `
    <div class="spend-row">
      <div class="row-actions">
        <button class="row-action-btn row-action-edit"
          onclick="editSpend('${s.id}')">✎</button>
        <button class="row-action-btn row-action-del"
          onclick="deleteSpend('${s.id}')">×</button>
      </div>

      <div class="spend-left">
        <div class="inline-chips">
          <span class="chip" style="background:#e8f8d8;color:#1a1a1a;">
            <span class="chip-icon">🛒</span>
            <span>${escapeHTML(s.item)}</span>
          </span>
          ${chips.join("")}
        </div>
      </div>

      <div class="spend-middle">
        <div style="font-size:.9rem;font-weight:500;color:#111;">
          ${formatISOasDMY(s.date)}
        </div>
        <div class="spend-meta">${escapeHTML(s.time)}</div>
      </div>

      <div class="spend-right spend-amount">${formatCurrencyR(s.amount)}</div>
    </div>
  `;
}

/* ===== Render DayCard (spend list + totals + warning + search stats) ===== */
function renderDayCard(){
  const listEl=document.getElementById("spendList");
  const totalEl=document.getElementById("spendTotalRed");
  const lineEl=document.getElementById("dayTotalLine");
  const overIcon=document.getElementById("overLimitIcon");
  const warnEl=document.getElementById("limitWarning");
  const searchHint=document.getElementById("searchHint");

  const dayList=getSpendsForDate(viewingDate);

  // Apply search filter
  const visibleList = dayList.filter(s=>{
    if(!searchFilter) return true;
    const hay=( (s.item||"")+" "+(s.shop||"")+" "+(s.type||"")+" "+(s.payer||"") ).toLowerCase();
    return hay.includes(searchFilter);
  });

  const dayTotal=sumAmounts(visibleList);
  const fullDayTotal=sumAmounts(dayList);

  // Build row HTML
  listEl.innerHTML=visibleList.map(buildSpendRowHTML).join("") || `
    <div class="small" style="color:#444;">
      No matches.
    </div>
  `;

  // totals
  totalEl.textContent=formatCurrencyR(dayTotal);
  lineEl.textContent=formatCurrencyR(fullDayTotal);

  // search hint
  searchHint.textContent =
    visibleList.length+" match"+(visibleList.length===1?"":"es")+" · "+formatCurrencyR(dayTotal);

  // over limit?
  const limit=getDailyLimit();
  const isOver = fullDayTotal>limit;
  overIcon.style.display = isOver? "inline-block":"none";
  warnEl.style.display   = isOver? "block":"none";
  warnEl.textContent     = isOver
    ? `Over daily limit (R ${limit})`
    : ``;
}

/* ===== Render viewing card ===== */
function renderViewingCard(){
  const vDateLabel=document.getElementById("viewingDateLabel");
  const statsEl=document.getElementById("viewingDayStats");

  const dayList=getSpendsForDate(viewingDate);
  const dayTotal=sumAmounts(dayList);

  vDateLabel.textContent=formatISOasDMY(viewingDate);
  statsEl.textContent=`${dayList.length} entr${dayList.length===1?"y":"ies"} · ${formatCurrencyR(dayTotal)}`;
}

/* ===== Render summary card + weekly trend ===== */
function renderSummaryCard(){
  const sumData=get7DaySummaryFromViewing(viewingDate);
  const rangeDateEl=document.getElementById("summaryRangeDate");
  const gridEl=document.getElementById("summaryGrid");

  rangeDateEl.textContent=formatISOasDMY(viewingDate);

  let html="";

  // by type
  html+=`
    <div class="report-block-title">
      <div>By type</div>
      <span>last 7 days</span>
    </div>
  `;
  Object.keys(sumData.byType).forEach(typeKey=>{
    const val=sumData.byType[typeKey];
    if(val>0){
      html+=`
        <div class="summary-row type-${escapeHTML(typeKey)}">
          <div class="sum-left">
            ${emojiForType(typeKey)} ${escapeHTML(typeKey)}
          </div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // by payer
  html+=`
    <div class="report-block-title">
      <div>By payer</div>
      <span>last 7 days</span>
    </div>
  `;
  Object.keys(sumData.byPayer).forEach(payerKey=>{
    const val=sumData.byPayer[payerKey];
    if(val>0){
      html+=`
        <div class="summary-row payer-${escapeHTML(payerKey)}">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // total
  html+=`
    <div class="summary-total">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(sumData.totalAll)}</div>
    </div>
  `;
  gridEl.innerHTML=html;

  // weekly trend card
  const highDayText = sumData.highDay.date
    ? `${formatISOasDMY(sumData.highDay.date)} (${formatCurrencyR(sumData.highDay.amount)})`
    : "--";
  const topPayerText = sumData.topPayer.name
    ? `${escapeHTML(sumData.topPayer.name)} (${formatCurrencyR(sumData.topPayer.amount)})`
    : "--";
  const topShopText = sumData.topShop.name
    ? `${escapeHTML(sumData.topShop.name)} (${formatCurrencyR(sumData.topShop.amount)})`
    : "--";

  document.getElementById("trendHighDay").textContent = highDayText;
  document.getElementById("trendTopPayer").textContent = topPayerText;
  document.getElementById("trendTopShop").textContent = topShopText;
}

/* ===== Render week report card ===== */
function renderWeekReportCard(){
  const picker=document.getElementById("weekPicker");
  let endIso=picker.value;
  if(!endIso){
    endIso=todayISO();
    picker.value=endIso;
  }
  const data=getCustom7DaySummary(endIso);
  const gridEl=document.getElementById("weekReportGrid");

  const startDMY=formatISOasDMY(data.startIso);
  const endDMY=formatISOasDMY(data.endIso);

  let html="";
  // totals
  html+=`
    <div class="report-block-title">
      <div>Totals</div>
      <span>${startDMY} → ${endDMY}</span>
    </div>
    <div class="summary-total" style="margin-top:4px;">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(data.totalAll)}</div>
    </div>
  `;

  // by type
  html+=`
    <div class="report-block-title">
      <div>By type</div>
      <span>7 days</span>
    </div>
  `;
  Object.keys(data.byType).forEach(typeKey=>{
    const val=data.byType[typeKey];
    if(val>0){
      html+=`
        <div class="summary-row type-${escapeHTML(typeKey)}">
          <div class="sum-left">
            ${emojiForType(typeKey)} ${escapeHTML(typeKey)}
          </div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // by payer
  html+=`
    <div class="report-block-title">
      <div>By payer</div>
      <span>7 days</span>
    </div>
  `;
  Object.keys(data.byPayer).forEach(payerKey=>{
    const val=data.byPayer[payerKey];
    if(val>0){
      html+=`
        <div class="summary-row payer-${escapeHTML(payerKey)}">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // highlights
  html+=`
    <div class="report-block-title">
      <div>Highlights</div>
      <span>7 days</span>
    </div>
    <div class="highlight-block">
      <div class="highlight-line">
        <div class="highlight-left">🏪 Top shop</div>
        <div class="highlight-right">
          ${escapeHTML(data.topShop.name||"-")} — ${formatCurrencyR(data.topShop.amount||0)}
        </div>
      </div>
      <div class="highlight-line">
        <div class="highlight-left">🧾 Top type</div>
        <div class="highlight-right">
          ${escapeHTML(data.topType.name||"-")} — ${formatCurrencyR(data.topType.amount||0)}
        </div>
      </div>
    </div>
  `;
  gridEl.innerHTML=html;
}

/* ===== Render month report card ===== */
function renderMonthReportCard(){
  const picker=document.getElementById("monthPicker");
  let monthVal=picker.value;
  if(!monthVal){
    const d=new Date();
    const ym=d.getFullYear()+"-"+pad2(d.getMonth()+1);
    monthVal=ym;
    picker.value=ym;
  }
  const data=getMonthSummary(monthVal);
  const gridEl=document.getElementById("monthReportGrid");

  if(!data){
    gridEl.innerHTML="<div class='small' style='color:#444;'>No data</div>";
    return;
  }

  const startDMY=formatISOasDMY(data.startIso);
  const endDMY=formatISOasDMY(data.endIso);

  let html="";
  // totals
  html+=`
    <div class="report-block-title">
      <div>Totals</div>
      <span>${startDMY} → ${endDMY}</span>
    </div>
    <div class="summary-total" style="margin-top:4px;">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(data.totalAll)}</div>
    </div>
  `;

  // by type
  html+=`
    <div class="report-block-title">
      <div>By type</div>
      <span>this month</span>
    </div>
  `;
  Object.keys(data.byType).forEach(typeKey=>{
    const val=data.byType[typeKey];
    if(val>0){
      html+=`
        <div class="summary-row type-${escapeHTML(typeKey)}">
          <div class="sum-left">
            ${emojiForType(typeKey)} ${escapeHTML(typeKey)}
          </div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // by payer
  html+=`
    <div class="report-block-title">
      <div>By payer</div>
      <span>this month</span>
    </div>
  `;
  Object.keys(data.byPayer).forEach(payerKey=>{
    const val=data.byPayer[payerKey];
    if(val>0){
      html+=`
        <div class="summary-row payer-${escapeHTML(payerKey)}">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // highlight
  html+=`
    <div class="report-block-title">
      <div>Highlights</div>
      <span>this month</span>
    </div>
    <div class="highlight-block">
      <div class="highlight-line">
        <div class="highlight-left">🏪 Top shop</div>
        <div class="highlight-right">
          ${escapeHTML(data.topShop.name||"-")} — ${formatCurrencyR(data.topShop.amount||0)}
        </div>
      </div>
      <div class="highlight-line">
        <div class="highlight-left">🧾 Top type</div>
        <div class="highlight-right">
          ${escapeHTML(data.topType.name||"-")} — ${formatCurrencyR(data.topType.amount||0)}
        </div>
      </div>
    </div>
  `;
  gridEl.innerHTML=html;
}

/* ===== Render groceries ===== */
function renderGroceries(){
  const listEl=document.getElementById("groceryList");
  const list=loadGroceries();

  if(!list.length){
    listEl.innerHTML=`
      <div class='small' style='color:#444;'>
        Your grocery list is empty. Add something above.
      </div>`;
  } else {
    listEl.innerHTML=list.map(item=>{
      const prettyDate=item.date ? formatISOasDMY(item.date) : "";
      const prettyTime=item.time ? item.time : "";
      return `
        <div class="grocery-row ${item.done?"done":""}">
          <div class="grocery-left">
            <input type="checkbox"
              ${item.done?"checked":""}
              onclick="toggleGroceryDone('${item.id}')" />

            <div class="grocery-left-mainline">
              <span class="grocery-name-inline ${item.done?"grocery-done":""}">
                ${escapeHTML(item.name)}
              </span>

              <span class="grocery-timestamp">
                ${prettyDate && prettyTime
                  ? `${prettyDate} · ${prettyTime}`
                  : ""}
              </span>
            </div>
          </div>

          <div class="grocery-actions">
            <button class="grocery-move" onclick="moveGroceryToSpend('${item.id}')">➕</button>
            <button class="grocery-edit" onclick="editGroceryItem('${item.id}')">✎</button>
            <button class="grocery-del" onclick="deleteGroceryItem('${item.id}')">×</button>
          </div>
        </div>
      `;
    }).join("");
  }
  updateTabBadges();
}

/* ===== Export ===== */
function arrayToCSV(rows){
  return rows.map(r =>
    r.map(val => {
      const v=(val===undefined||val===null)?"":String(val);
      if(v.includes(",")||v.includes('"')||v.includes("\n")){
        return '"' + v.replace(/"/g,'""') + '"';
      }
      return v;
    }).join(",")
  ).join("\n");
}
function downloadCSV(filename,csvText){
  const blob=new Blob([csvText],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function exportSpendingCSV(){
  const data=loadSpends();
  const rows=[["id","item","shop","type","payer","amount","date","time"]];
  data.forEach(s=>{
    rows.push([s.id,s.item,s.shop,s.type,s.payer,s.amount,s.date,s.time]);
  });
  const csv=arrayToCSV(rows);
  const stamp=todayISO();
  downloadCSV(`taskpulse_spending_${stamp}.csv`,csv);
}
function exportGroceriesCSV(){
  const data=loadGroceries();
  const rows=[["id","name","done","date","time"]];
  data.forEach(g=>{
    rows.push([g.id,g.name,g.done?"yes":"no",g.date,g.time]);
  });
  const csv=arrayToCSV(rows);
  const stamp=todayISO();
  downloadCSV(`taskpulse_groceries_${stamp}.csv`,csv);
}

/* ===== Tab switching / remember last tab ===== */
const tabSpendBtn=document.getElementById("tabSpend");
const tabGroBtn=document.getElementById("tabGroceries");

function showSpendScreen(){
  document.getElementById("spendScreen").style.display="block";
  document.getElementById("groceryScreen").style.display="none";
  tabSpendBtn.classList.add("tab-active");
  tabGroBtn.classList.remove("tab-active");
  saveLastTab("spend");

  // refresh selects if we came here from grocery ➕
  renderItemSelect();
  renderShopSelect();
  renderTypeSelect();
  updateTabBadges();
}
function showGroceryScreen(){
  document.getElementById("spendScreen").style.display="none";
  document.getElementById("groceryScreen").style.display="block";
  tabGroBtn.classList.add("tab-active");
  tabSpendBtn.classList.remove("tab-active");
  saveLastTab("groceries");
  updateTabBadges();
}

/* ===== Splash control ===== */
function hideSplash(){
  const splash=document.getElementById("splashOverlay");
  splash.classList.add("hidden");
}

/* ===== Firebase sync stubs =====
   - You already have firebaseConfig + init elsewhere.
   - Hook your auth/session ID into syncPull()/syncPush().
*/
function syncPull(){
  // pseudocode:
  // 1. fetch user's cloud data blob {spends, groceries, settings, vocab}
  // 2. merge into localStorage and call renderAll()
  //
  // We'll leave implementation to match your existing TaskPulse sync logic.
}
function syncPush(){
  // pseudocode:
  // read all local data and push to cloud for this user
  //
  // const payload = {
  //   spends: loadSpends(),
  //   groceries: loadGroceries(),
  //   settings: loadSettings(),
  //   vocab: {
  //     items: loadItems(),
  //     shops: loadShops(),
  //     types: loadTypes(),
  //     groceryNames: loadGroceriesOptions()
  //   }
  // };
  //
  // push payload to firebase under the same user node you already use
}

/* ===== Master render ===== */
function renderAll(){
  renderHeader();

  // fill limit input from settings
  const limitInput=document.getElementById("limitInput");
  if(limitInput){
    limitInput.value=getDailyLimit();
  }

  renderDayCard();
  renderViewingCard();
  renderSummaryCard();
  renderWeekReportCard();
  renderMonthReportCard();
  renderGroceries(); // also refreshes badges
}

/* ===== Bind / Init ===== */
function bindUI(){
  // add / clear spend
  document.getElementById("addSpendBtn").onclick = addSpend;
  document.getElementById("clearDayBtn").onclick = clearDay;

  // day nav
  document.getElementById("prevDayBtn").onclick = goPrevDay;
  document.getElementById("nextDayBtn").onclick = goNextDay;

  // reports pickers
  document.getElementById("weekPicker").onchange = renderWeekReportCard;
  document.getElementById("monthPicker").onchange = renderMonthReportCard;

  // export
  document.getElementById("exportSpendsBtn").onclick = exportSpendingCSV;
  document.getElementById("exportGroceriesBtn").onclick = exportGroceriesCSV;

  // groceries
  document.getElementById("addGroceryBtn").onclick = addGrocery;

  // dropdown change handlers
  document.getElementById("newItem").onchange = onItemChange;
  document.getElementById("newShop").onchange = onShopChange;
  document.getElementById("newType").onchange = onTypeChange;
  document.getElementById("newGroceryItem").onchange = onGroceryNameChange;

  // payer select doesn't need a handler

  // search
  document.getElementById("searchInput").oninput = (e)=>{
    setSearchFilter(e.target.value);
  };

  // settings daily limit
  document.getElementById("limitInput").onchange = (e)=>{
    setDailyLimit(e.target.value);
  };

  // tabs
  tabSpendBtn.onclick = showSpendScreen;
  tabGroBtn.onclick   = showGroceryScreen;
}

function init(){
  bindUI();

  // ensure default dropdown lists
  ensureDefaultLists();

  // restore pending draft = none at start
  pendingSpendDraft=null;

  // Set last viewed tab
  const lastTab=loadLastTab();
  if(lastTab==="groceries"){
    showGroceryScreen();
  }else{
    showSpendScreen();
  }

  // render selects (after showXScreen so DOM is visible)
  renderItemSelect();
  renderShopSelect();
  renderTypeSelect();
  renderGroceryNameSelect();

  // pull sync (optional, if signed in)
  syncPull();

  // render UI
  renderAll();

  // splash timeout
  setTimeout(hideSplash,1800);
}
init();
</script>

</body>
</html>

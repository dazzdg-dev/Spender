<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Task Pulse Money</title>
<link rel="icon" href="favicon.png" type="image/png" />
<meta name="theme-color" content="#0f111a" />

<style>
/* ======= base ======= */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  -webkit-font-smoothing:antialiased;
}
body{
  background:#0f111a;
  background-image:
    radial-gradient(circle at 20% 20%,rgba(80,90,255,.16)0%,rgba(15,17,26,0)60%),
    radial-gradient(circle at 80% 30%,rgba(255,0,128,.12)0%,rgba(15,17,26,0)60%);
  color:#e9e9ef;
  max-width:480px;
  margin:0 auto;
  position:relative;
}
main{
  padding:16px 16px 180px;
}

/* ======= splash screen ======= */
#splashOverlay{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at 50% 30%,rgba(89,102,255,.3)0%,rgba(0,0,0,0)70%),linear-gradient(180deg,#0f111a 0%,#000 100%);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:24px;
  z-index:9999;
  transition:opacity .6s ease, visibility .6s ease;
}
#splashLogo{
  width:88px;
  height:88px;
  border-radius:20px;
  background:radial-gradient(circle at 30% 30%,#ffffff 0%,#9ea6ff 20%,#2b2e65 60%,#0f111a 100%);
  box-shadow:
    0 30px 120px rgba(89,102,255,.6),
    0 0 80px rgba(255,0,128,.4),
    0 0 12px rgba(255,255,255,.8) inset;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#0f111a;
  font-weight:700;
  font-size:0.8rem;
  line-height:1.2;
  text-shadow:0 0 8px rgba(0,0,0,.6);
  text-align:center;
}
#splashLogo span{
  display:block;
}
#splashTitle{
  margin-top:16px;
  font-size:1.2rem;
  font-weight:600;
  color:#fff;
  text-shadow:0 0 12px rgba(89,102,255,.9);
  letter-spacing:.03em;
}
#splashTag{
  margin-top:8px;
  font-size:.8rem;
  color:#a8a8ff;
  text-shadow:0 0 8px rgba(89,102,255,.6);
}
#splashHint{
  margin-top:24px;
  font-size:.7rem;
  color:#666af9;
  opacity:.8;
}
#splashOverlay.hidden{
  opacity:0;
  visibility:hidden;
}

/* ======= header / brand ======= */
header{
  text-align:center;
  padding:20px 12px;
  background:linear-gradient(180deg,#1b1d2e 0%,#0f111a 100%);
  border-radius:0 0 20px 20px;
  box-shadow:0 10px 40px rgba(0,0,0,.6);
}
header .title{
  font-size:1.4rem;
  font-weight:700;
  color:#fff;
  letter-spacing:.5px;
  text-shadow:0 0 8px rgba(89,102,255,.7);
}
header .date{
  font-size:.9rem;
  color:#bdbdfd;
  margin-top:6px;
}
header .credit{
  font-size:.7rem;
  color:#8a8aff;
  margin-top:8px;
}

/* ======= tab bar ======= */
.tab-bar{
  display:flex;
  justify-content:center;
  gap:8px;
  padding:16px;
  flex-wrap:wrap;
}
.tab-btn{
  flex:1;
  text-align:center;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.15);
  color:#c7c7ff;
  padding:12px 14px 8px;
  border-radius:12px;
  font-size:.9rem;
  font-weight:500;
  transition:all .25s ease;
  backdrop-filter:blur(6px);
  box-shadow:0 6px 18px rgba(0,0,0,.3);
  line-height:1.2;
  min-width:140px;
  position:relative;
}
.tab-btn:hover{
  transform:translateY(-1px);
  cursor:pointer;
}
.tab-btn.tab-active{
  background:#ffffff;
  color:#1a1a1a;
  border:1px solid #ffffff;
  box-shadow:0 0 16px rgba(89,102,255,.7);
}
.tab-label-main{
  font-size:.9rem;
  font-weight:600;
}
.tab-label-sub{
  font-size:.7rem;
  opacity:.8;
  margin-top:2px;
  font-weight:400;
}

/* ======= cards ======= */
.card{
  background:#ffffff;
  border:1px solid rgba(255,255,255,0.6);
  border-radius:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.5);
  padding:16px;
  margin-bottom:20px;
  color:#1a1a1a;
}
.section-headline{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  row-gap:8px;
  margin-bottom:12px;
}
.section-title{
  font-size:1rem;
  font-weight:600;
  color:#111;
}
.section-sub{
  font-size:.8rem;
  color:#444;
  text-align:right;
  min-width:max-content;
  padding-left:8px;
  line-height:1.3;
}
.small{
  font-size:.8rem;
  color:#666;
}

/* ======= spend rows ======= */
.spend-row,
.spend-total-row{
  display:grid;
  grid-template-columns:1fr auto auto;
  align-items:flex-start;
  column-gap:8px;
  font-size:.8rem;
  line-height:1.4;
  word-break:break-word;
}
.spend-row{
  padding:8px 0;
  border-bottom:1px solid #e4e4e7;
}
.spend-total-row{
  font-weight:600;
  color:#c00000;
  padding-top:12px;
}
.spend-left{}
.spend-middle{text-align:right;}
.spend-right{text-align:right;min-width:70px;}
.spend-total-row .spend-right{
  color:#c00000;
  font-size:1rem;
}
.spend-amount{
  font-size:.9rem;
  font-weight:600;
  color:#1a1a1a;
}

/* chips in the daily list */
.chip-item{
  background:#e8f8d8;
  border-radius:4px;
  padding:2px 4px;
  font-weight:600;
  color:#1a1a1a;
  display:inline-block;
}
.chip-shop{
  background:#fff8d6;
  border-radius:4px;
  padding:2px 4px;
  color:#4a3b00;
  display:inline-block;
  margin-top:4px;
}
.chip-type{
  background:#d5efff;
  border-radius:4px;
  padding:2px 4px;
  color:#003049;
  display:inline-block;
  margin-top:4px;
}
.chip-payer{
  background:#f2d9f6;
  border-radius:4px;
  padding:2px 4px;
  color:#4a125c;
  display:inline-block;
  margin-top:4px;
}
.spend-meta{
  font-size:.7rem;
  color:#444;
  line-height:1.3;
  margin-top:4px;
}

/* ======= input rows (add spend) ======= */
.input-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:8px;
}
.input-field,
.input-select{
  flex:1;
  min-width:120px;
  border:1px solid #cfcfd3;
  border-radius:10px;
  padding:10px 12px;
  font-size:.9rem;
  background:#fff;
  color:#1a1a1a;
}
.input-small{
  width:90px;
  flex:0 0 auto;
}
.add-btn{
  border-radius:10px;
  background:#1d1d1f;
  color:#fff;
  border:1px solid #1d1d1f;
  font-size:.85rem;
  font-weight:500;
  padding:10px 14px;
  min-width:70px;
  line-height:1.2;
}
.clear-btn{
  border-radius:10px;
  background:#fff;
  color:#1d1d1f;
  border:1px solid #cfcfd3;
  font-size:.8rem;
  font-weight:500;
  padding:8px 12px;
  min-width:110px;
  line-height:1.2;
}

/* ======= day nav ======= */
.history-headline{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  row-gap:8px;
  margin-bottom:12px;
  align-items:flex-start;
}
.history-left .small-top{
  font-size:.8rem;
  color:#444;
  line-height:1.2;
}
.history-left .hist-date{
  font-size:.9rem;
  font-weight:600;
  color:#111;
  line-height:1.3;
}
.history-nav{
  display:flex;
  gap:8px;
}
.history-nav button{
  background:#fff;
  border:1px solid #cfcfd3;
  color:#1d1d1f;
  padding:8px 10px;
  border-radius:10px;
  font-weight:500;
  min-width:44px;
  min-height:36px;
  line-height:1;
  font-size:1rem;
}

/* ======= summary / reports ======= */
.summary-grid{
  width:100%;
  font-size:.8rem;
  line-height:1.4;
  border-top:1px solid #e4e4e7;
  margin-top:8px;
  padding-top:8px;
}

/* color-coded summary rows */
.summary-row{
  display:flex;
  justify-content:space-between;
  border-radius:8px;
  align-items:flex-start;
  padding:4px 8px;
  margin-bottom:4px;
  font-weight:500;
}
.sum-type{ /* fallback generic */
  background:#d5efff;
  color:#003049;
}
.sum-payer{ /* fallback generic */
  background:#f2d9f6;
  color:#4a125c;
}

/* type-based colors */
.type-food    { background:#e8f8d8; color:#1a1a1a; }
.type-fuel    { background:#fff8d6; color:#4a3b00; }
.type-clothing{ background:#f2d9f6; color:#4a125c; }
.type-Medicine{ background:#eae4ff; color:#2c1160; }
.type-electricity { background:#d5efff; color:#003049; }

/* payer-based colors */
.payer-presh{ background:#ffe5ef; color:#5a0021; }
.payer-daryl{ background:#e2f2ff; color:#002a4f; }

.sum-left{}
.sum-right{
  min-width:90px;
  text-align:right;
  font-weight:600;
}
.summary-total{
  color:#c00000;
  font-weight:600;
  padding:6px 0 0;
  margin-top:8px;
  display:flex;
  justify-content:space-between;
}
.summary-total .sum-right{
  color:#c00000;
}

/* report headers */
.report-header{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  row-gap:8px;
  margin-bottom:12px;
  align-items:flex-start;
}
.report-left{
  display:flex;
  flex-direction:column;
  line-height:1.3;
}
.report-title{
  color:#111;
  font-size:1rem;
  font-weight:600;
}
.report-range{
  color:#666;
  font-size:.75rem;
}
.report-right{
  text-align:right;
  min-width:max-content;
  color:#111;
  font-size:.8rem;
}
.report-input{
  border:1px solid #cfcfd3;
  border-radius:8px;
  padding:6px 8px;
  font-size:.8rem;
  background:#fff;
  color:#1a1a1a;
}

/* sub-block titles */
.summary-block-title,
.report-block-title{
  font-size:.75rem;
  font-weight:600;
  color:#111;
  margin:16px 0 4px;
  line-height:1.2;
  display:flex;
  justify-content:space-between;
}
.summary-block-title:first-child,
.report-block-title:first-child{
  margin-top:0;
}
.summary-block-title span,
.report-block-title span{
  font-weight:400;
  font-size:.7rem;
  color:#666;
}

/* highlights */
.highlight-block{
  background:#f5f5f7;
  border:1px solid #d9d9de;
  border-radius:10px;
  padding:8px 12px;
  font-size:.75rem;
  line-height:1.4;
  color:#1a1a1a;
  margin-top:8px;
}
.highlight-line{
  display:flex;
  justify-content:space-between;
  margin-bottom:4px;
}
.highlight-left{
  font-weight:500;
  color:#111;
}
.highlight-right{
  font-weight:500;
  text-align:right;
  min-width:90px;
  color:#111;
}

/* ======= groceries ======= */
.grocery-list-area{
  border-top:1px solid #e4e4e7;
  margin-top:8px;
  padding-top:8px;
}
.grocery-row{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  border-bottom:1px solid #e4e4e7;
  padding:8px 0;
  font-size:.9rem;
  line-height:1.4;
}
.grocery-left{
  display:flex;
  align-items:flex-start;
  gap:8px;
  color:#111;
  max-width:80%;
}
.grocery-left input[type="checkbox"]{
  flex-shrink:0;
  margin-top:3px;
}
.grocery-name{
  font-weight:500;
  color:#111;
  word-break:break-word;
}
.grocery-name.grocery-done{
  color:#888;
  text-decoration:line-through;
}
.grocery-del{
  background:#fff;
  border:1px solid #cfcfd3;
  border-radius:8px;
  color:#c00000;
  font-size:.8rem;
  font-weight:600;
  line-height:1;
  min-width:32px;
  min-height:32px;
}
.grocery-hint{
  font-size:.7rem;
  color:#666;
  margin-top:8px;
}

/* ======= export card ======= */
.export-note{
  font-size:.7rem;
  color:#555;
  line-height:1.4;
  margin-top:8px;
}
.export-buttons{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}
.export-btn{
  flex:1;
  min-width:140px;
  text-align:center;
  background:#1d1d1f;
  color:#fff;
  border:1px solid #1d1d1f;
  border-radius:10px;
  font-size:.8rem;
  font-weight:500;
  padding:10px 12px;
  line-height:1.3;
  box-shadow:0 12px 30px rgba(0,0,0,.4);
}
.export-btn.light{
  background:#fff;
  color:#1d1d1f;
  border:1px solid #cfcfd3;
  box-shadow:0 12px 30px rgba(0,0,0,.15);
}
</style>
</head>

<body>

<!-- Splash overlay -->
<div id="splashOverlay">
  <div id="splashLogo">
    <span>TASK<br/>PULSE</span>
  </div>
  <div id="splashTitle">Task Pulse Money</div>
  <div id="splashTag">Powered by Daryl G</div>
  <div id="splashHint">loading offline dashboard…</div>
</div>

<header>
  <div class="title">Task Pulse</div>
  <div class="date" id="headerToday">--</div>
  <div class="credit">Powered by Daryl G</div>
</header>

<nav class="tab-bar">
  <button id="tabSpend" class="tab-btn tab-active">
    <div class="tab-label-main">Spend</div>
    <div class="tab-label-sub" id="tabSpendSub">R 0.00 today</div>
  </button>
  <button id="tabGroceries" class="tab-btn">
    <div class="tab-label-main">Groceries</div>
    <div class="tab-label-sub" id="tabGroSub">0 items</div>
  </button>
</nav>

<main>

  <!-- ===========================================================
       SCREEN: SPEND
       =========================================================== -->
  <div id="spendScreen">

    <!-- CARD 1: Day's spending list -->
    <section class="card" id="dayCard">
      <div class="section-headline">
        <div class="section-title">Spending (this day)</div>
        <div class="section-sub" id="dayTotalLine">R 0.00</div>
      </div>

      <div id="spendList"></div>

      <div class="spend-total-row">
        <div class="spend-left"></div>
        <div class="spend-middle"></div>
        <div class="spend-right" id="spendTotalRed">R 0.00</div>
      </div>
    </section>

    <!-- CARD 2: Add new purchase -->
    <section class="card">
      <div class="section-headline" style="margin-bottom:8px;">
        <div class="section-title">Add new purchase</div>
        <div class="section-sub" style="font-size:.7rem;line-height:1.3;">
          date/time auto<br/>saved
        </div>
      </div>

      <div class="input-row">
        <input id="newItem"  class="input-field" placeholder="item (what was bought?)" />
        <input id="newShop"  class="input-field" placeholder="shop (bp / food lovers…)" />
      </div>

      <div class="input-row">
        <select id="newType" class="input-select">
          <option value="food">food</option>
          <option value="fuel">fuel</option>
          <option value="clothing">clothing</option>
          <option value="Medicine">Medicine</option>
          <option value="electricity">electricity</option>
        </select>

        <select id="newPayer" class="input-select">
          <option value="presh">presh</option>
          <option value="daryl">daryl</option>
        </select>

        <input id="newAmount" class="input-field input-small" type="number" min="0" step="0.01" placeholder="R" />
      </div>

      <div class="input-row" style="align-items:flex-start;">
        <button id="addSpendBtn" class="add-btn">Add</button>
        <button id="clearDayBtn" class="clear-btn">Clear this day</button>
      </div>

      <div class="small" style="color:#666;">
        • Amount is in Rand (R).<br/>
        • Payer = who paid.<br/>
        • Type = fuel / food / etc.<br/>
        • Shop = where you swiped / bought.<br/>
        • After Add: entry is saved on this device.
      </div>
    </section>

    <!-- CARD 3: Day navigation -->
    <section class="card">
      <div class="history-headline">
        <div class="history-left">
          <div class="small-top small">Viewing</div>
          <div class="hist-date" id="viewingDateLabel">--</div>
        </div>
        <div class="history-nav">
          <button id="prevDayBtn">◀</button>
          <button id="nextDayBtn">▶</button>
        </div>
      </div>

      <div class="small" id="viewingDayStats" style="color:#444;margin-bottom:8px;">
        0 entries · R 0.00
      </div>
      <div class="small" style="color:#444;">
        Use ◀ ▶ to move through dates. Totals + summary update.
      </div>
    </section>

    <!-- CARD 4: Auto 7-day summary (from viewing date) -->
    <section class="card">
      <div class="section-headline">
        <div class="section-title">Summary</div>
        <div class="section-sub" style="line-height:1.3;text-align:right;">
          <div id="summaryRangeDate">--</div>
          <div style="font-size:.7rem;color:#666;">7 days from view</div>
        </div>
      </div>

      <div class="summary-grid" id="summaryGrid">
        <!-- dynamic -->
      </div>
    </section>

    <!-- CARD 5: 7 Day Report (custom end date) -->
    <section class="card">
      <div class="report-header">
        <div class="report-left">
          <div class="report-title">7 Day Report</div>
          <div class="report-range">Custom 7-day window</div>
        </div>
        <div class="report-right">
          <input id="weekPicker" class="report-input" type="date" />
        </div>
      </div>

      <div class="summary-grid" id="weekReportGrid">
        <!-- dynamic -->
      </div>
    </section>

    <!-- CARD 6: Monthly Report (custom month) -->
    <section class="card">
      <div class="report-header">
        <div class="report-left">
          <div class="report-title">Monthly Report</div>
          <div class="report-range">Full month totals</div>
        </div>
        <div class="report-right">
          <input id="monthPicker" class="report-input" type="month" />
        </div>
      </div>

      <div class="summary-grid" id="monthReportGrid">
        <!-- dynamic -->
      </div>
    </section>

    <!-- CARD 7: Backup & Export -->
    <section class="card">
      <div class="section-headline" style="margin-bottom:4px;">
        <div class="section-title">Backup & Export</div>
        <div class="section-sub" style="font-size:.7rem;line-height:1.3;color:#666;">
          Offline export
        </div>
      </div>

      <div class="small" style="color:#444;">
        Download your data as CSV for backup, sharing, or monthly review.
      </div>

      <div class="export-buttons">
        <button class="export-btn" id="exportSpendsBtn">Export Spending CSV</button>
        <button class="export-btn light" id="exportGroceriesBtn">Export Groceries CSV</button>
      </div>

      <div class="export-note">
        Tip: Keep these files somewhere safe (Drive, email, etc.).
      </div>
    </section>

  </div><!-- /#spendScreen -->


  <!-- ===========================================================
       SCREEN: GROCERIES
       =========================================================== -->
  <div id="groceryScreen" style="display:none;">
    <section class="card">
      <div class="section-headline" style="margin-bottom:8px;">
        <div class="section-title">Groceries</div>
        <div class="section-sub" style="font-size:.7rem;line-height:1.3;">
          Offline list
        </div>
      </div>

      <div class="input-row">
        <input id="newGroceryItem" class="input-field" placeholder="Add grocery item..." />
        <button id="addGroceryBtn" class="add-btn" style="min-width:60px;">Add</button>
      </div>

      <div id="groceryList" class="grocery-list-area">
        <!-- grocery rows here -->
      </div>

      <div class="grocery-hint">
        • Tap the checkbox when you've bought it.<br/>
        • "×" removes it from the list.<br/>
        • List is saved on this device.
      </div>
    </section>
  </div><!-- /#groceryScreen -->

</main>

<script>
/* ===== 0. HELPERS ===== */
function pad2(n){return String(n).padStart(2,"0");}
function todayISO(){
  const d=new Date();
  return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
}
function formatISOasDMY(iso){
  const [y,m,d]=iso.split("-");
  return d+"-"+m+"-"+y;
}
function formatCurrencyR(amount){
  const n = Number(amount||0);
  return "R " + n.toLocaleString("en-ZA", {
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}
function nowTime12h(){
  const d=new Date();
  let h=d.getHours(), m=d.getMinutes();
  const ampm = h>=12 ? "PM":"AM";
  h = (h%12)||12;
  return h+":"+pad2(m)+" "+ampm;
}
function shiftISO(iso, delta){
  const [Y,M,D]=iso.split("-");
  const base=new Date(Number(Y),Number(M)-1,Number(D));
  base.setDate(base.getDate()+delta);
  return base.getFullYear()+"-"+pad2(base.getMonth()+1)+"-"+pad2(base.getDate());
}
function getISODateNDaysBefore(iso, n){
  return shiftISO(iso, -n);
}
function escapeHTML(str){
  return String(str).replace(/[&<>"]/g, c=>{
    const map={"&":"&amp;","<":"&lt;",">":"&gt;"};
    return map[c]||c;
  });
}

/* ===== 1. STORAGE ===== */
function loadSpends(){return JSON.parse(localStorage.getItem("tp_spends")||"[]");}
function saveSpends(list){localStorage.setItem("tp_spends",JSON.stringify(list));}

function loadGroceries(){return JSON.parse(localStorage.getItem("tp_groceries")||"[]");}
function saveGroceries(list){localStorage.setItem("tp_groceries",JSON.stringify(list));}

function newSpend({item,shop,type,payer,amount}){
  return {
    id:"s_"+Math.random().toString(36).slice(2,9),
    item,
    shop,
    type,
    payer,
    amount:Number(amount)||0,
    date: todayISO(),
    time: nowTime12h()
  };
}
function newGroceryItem(name){
  return {
    id:"g_"+Math.random().toString(36).slice(2,9),
    name:name,
    done:false
  };
}

/* ===== 2. APP STATE ===== */
let viewingDate = todayISO();

/* ===== 3. SPENDING ACTIONS ===== */
function addSpend(){
  const itemEl   = document.getElementById("newItem");
  const shopEl   = document.getElementById("newShop");
  const typeEl   = document.getElementById("newType");
  const payerEl  = document.getElementById("newPayer");
  const amtEl    = document.getElementById("newAmount");

  const itemVal  = itemEl.value.trim();
  const shopVal  = shopEl.value.trim();
  const typeVal  = typeEl.value;
  const payerVal = payerEl.value;
  const amtVal   = amtEl.value.trim();

  if(!itemVal || !amtVal){return;}

  const all=loadSpends();
  all.push(newSpend({
    item:itemVal,
    shop:shopVal,
    type:typeVal,
    payer:payerVal,
    amount:amtVal
  }));
  saveSpends(all);

  itemEl.value="";
  shopEl.value="";
  amtEl.value="";

  viewingDate = todayISO();
  renderAll();
}
function clearDay(){
  const all=loadSpends();
  const keep=all.filter(s=>s.date!==viewingDate);
  saveSpends(keep);
  renderAll();
}
function goPrevDay(){
  viewingDate = shiftISO(viewingDate, -1);
  renderAll();
}
function goNextDay(){
  viewingDate = shiftISO(viewingDate, +1);
  renderAll();
}

/* ===== 4. GROCERIES ACTIONS ===== */
function addGrocery(){
  const input=document.getElementById("newGroceryItem");
  const name=input.value.trim();
  if(!name)return;
  const list=loadGroceries();
  list.push(newGroceryItem(name));
  saveGroceries(list);
  input.value="";
  renderGroceries();
}
function toggleGroceryDone(id){
  const list=loadGroceries();
  const item=list.find(g=>g.id===id);
  if(item){
    item.done=!item.done;
    saveGroceries(list);
    renderGroceries();
    updateTabBadges(); // keep badge count fresh
  }
}
function deleteGroceryItem(id){
  let list=loadGroceries();
  list=list.filter(g=>g.id!==id);
  saveGroceries(list);
  renderGroceries();
  updateTabBadges();
}

/* ===== 5. ANALYSIS HELPERS ===== */
function sumAmounts(list){
  return list.reduce((acc,s)=>acc+Number(s.amount||0),0);
}
function getSpendsForDate(dateIso){
  return loadSpends().filter(s=>s.date===dateIso);
}
function inRange(dateIso,startIso,endIso){
  return dateIso>=startIso && dateIso<=endIso;
}
function collectRangeData(startIso,endIso){
  const all=loadSpends();
  const byType={},byPayer={},byShop={};
  let totalAll=0;

  for(const s of all){
    if(inRange(s.date,startIso,endIso)){
      const amt=Number(s.amount||0);
      totalAll+=amt;

      if(!byType[s.type]) byType[s.type]=0;
      byType[s.type]+=amt;

      if(!byPayer[s.payer]) byPayer[s.payer]=0;
      byPayer[s.payer]+=amt;

      const shopKey = s.shop && s.shop.trim() ? s.shop.trim() : "(no shop)";
      if(!byShop[shopKey]) byShop[shopKey]=0;
      byShop[shopKey]+=amt;
    }
  }

  let topShopName="", topShopAmt=0;
  Object.keys(byShop).forEach(sh=>{
    if(byShop[sh]>topShopAmt){
      topShopAmt=byShop[sh];
      topShopName=sh;
    }
  });
  let topTypeName="", topTypeAmt=0;
  Object.keys(byType).forEach(t=>{
    if(byType[t]>topTypeAmt){
      topTypeAmt=byType[t];
      topTypeName=t;
    }
  });

  return {
    totalAll,
    byType,
    byPayer,
    byShop,
    topShop:{name:topShopName,amount:topShopAmt},
    topType:{name:topTypeName,amount:topTypeAmt},
    startIso,
    endIso
  };
}
function get7DaySummaryFromViewing(viewIso){
  const endIso=viewIso;
  const startIso=getISODateNDaysBefore(viewIso,6);
  return collectRangeData(startIso,endIso);
}
function getCustom7DaySummary(endIso){
  const startIso=getISODateNDaysBefore(endIso,6);
  return collectRangeData(startIso,endIso);
}
function getMonthSummary(monthStr){
  if(!monthStr || !monthStr.includes("-")) return null;
  const [Y,M]=monthStr.split("-");
  const startIso=Y+"-"+M+"-01";
  const lastDay=new Date(Number(Y),Number(M),0).getDate();
  const endIso=Y+"-"+M+"-"+pad2(lastDay);

  const data=collectRangeData(startIso,endIso);
  data.monthLabel=monthStr;
  return data;
}

/* ===== 6. BADGE HELPERS (tab bar live stats) ===== */
function updateTabBadges(){
  // Spend badge: today's total
  const todayList = getSpendsForDate(todayISO());
  const todayTotal = sumAmounts(todayList);
  const spendSubEl = document.getElementById("tabSpendSub");
  spendSubEl.textContent = formatCurrencyR(todayTotal) + " today";

  // Groceries badge: number of unchecked items
  const groc = loadGroceries();
  const remaining = groc.filter(g=>!g.done).length;
  const groSubEl = document.getElementById("tabGroSub");
  groSubEl.textContent = remaining + " item" + (remaining===1?"":"s");
}

/* ===== 7. COLOR HELPERS FOR SUMMARY ROWS ===== */
function classForType(t){
  // map spending "type" -> CSS class for background/text color
  // We defined classes like .type-food, .type-fuel, etc.
  if(!t) return "";
  return "type-"+t; // e.g. "food" -> "type-food"
}
function classForPayer(p){
  if(!p) return "";
  return "payer-"+p; // "daryl" -> "payer-daryl"
}

/* ===== 8. RENDER PIECES ===== */
function renderHeader(){
  document.getElementById("headerToday").textContent=formatISOasDMY(todayISO());
}

function renderDayCard(){
  const listEl=document.getElementById("spendList");
  const totalEl=document.getElementById("spendTotalRed");
  const lineEl=document.getElementById("dayTotalLine");

  const dayList=getSpendsForDate(viewingDate);
  const dayTotal=sumAmounts(dayList);

  listEl.innerHTML=dayList.map(s=>{
    return `
      <div class="spend-row">
        <div class="spend-left">
          <div class="chip-item">${escapeHTML(s.item)}</div>
          ${s.shop?`<div class="chip-shop">${escapeHTML(s.shop)}</div>`:""}
          <div class="chip-type">${escapeHTML(s.type)}</div>
          <div class="chip-payer">${escapeHTML(s.payer)}</div>
        </div>
        <div class="spend-middle">
          <div style="font-size:.9rem;font-weight:500;color:#111;">${formatISOasDMY(s.date)}</div>
          <div class="spend-meta">${escapeHTML(s.time)}</div>
        </div>
        <div class="spend-right spend-amount">${formatCurrencyR(s.amount)}</div>
      </div>
    `;
  }).join("");

  totalEl.textContent=formatCurrencyR(dayTotal);
  lineEl.textContent=formatCurrencyR(dayTotal);
}

function renderViewingCard(){
  const vDateLabel=document.getElementById("viewingDateLabel");
  const statsEl=document.getElementById("viewingDayStats");

  const dayList=getSpendsForDate(viewingDate);
  const dayTotal=sumAmounts(dayList);

  vDateLabel.textContent=formatISOasDMY(viewingDate);
  statsEl.textContent=`${dayList.length} entr${dayList.length===1?"y":"ies"} · ${formatCurrencyR(dayTotal)}`;
}

function renderSummaryCard(){
  const sumData=get7DaySummaryFromViewing(viewingDate);
  const rangeDateEl=document.getElementById("summaryRangeDate");
  const gridEl=document.getElementById("summaryGrid");

  rangeDateEl.textContent=formatISOasDMY(viewingDate);

  let html="";
  // By type
  html+=`
    <div class="summary-block-title">
      <div>By type</div>
      <span>last 7 days</span>
    </div>
  `;
  Object.keys(sumData.byType).forEach(typeKey=>{
    const val=sumData.byType[typeKey];
    if(val>0){
      html+=`
        <div class="summary-row ${classForType(typeKey)}">
          <div class="sum-left">${escapeHTML(typeKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // By payer
  html+=`
    <div class="summary-block-title" style="margin-top:16px;">
      <div>By payer</div>
      <span>last 7 days</span>
    </div>
  `;
  Object.keys(sumData.byPayer).forEach(payerKey=>{
    const val=sumData.byPayer[payerKey];
    if(val>0){
      html+=`
        <div class="summary-row ${classForPayer(payerKey)}">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // Total
  html+=`
    <div class="summary-total">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(sumData.totalAll)}</div>
    </div>
  `;

  gridEl.innerHTML=html;
}

function renderWeekReportCard(){
  const picker=document.getElementById("weekPicker");
  let endIso=picker.value;
  if(!endIso){
    endIso=todayISO();
    picker.value=endIso;
  }
  const data=getCustom7DaySummary(endIso);
  const gridEl=document.getElementById("weekReportGrid");

  const startDMY=formatISOasDMY(data.startIso);
  const endDMY=formatISOasDMY(data.endIso);

  let html="";
  // Totals
  html+=`
    <div class="report-block-title">
      <div>Totals</div>
      <span>${startDMY} → ${endDMY}</span>
    </div>
    <div class="summary-total" style="margin-top:4px;">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(data.totalAll)}</div>
    </div>
  `;

  // By type
  html+=`
    <div class="report-block-title">
      <div>By type</div>
      <span>7 days</span>
    </div>
  `;
  Object.keys(data.byType).forEach(typeKey=>{
    const val=data.byType[typeKey];
    if(val>0){
      html+=`
        <div class="summary-row ${classForType(typeKey)}">
          <div class="sum-left">${escapeHTML(typeKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // By payer
  html+=`
    <div class="report-block-title">
      <div>By payer</div>
      <span>7 days</span>
    </div>
  `;
  Object.keys(data.byPayer).forEach(payerKey=>{
    const val=data.byPayer[payerKey];
    if(val>0){
      html+=`
        <div class="summary-row ${classForPayer(payerKey)}">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // Highlights
  html+=`
    <div class="report-block-title">
      <div>Highlights</div>
      <span>7 days</span>
    </div>
    <div class="highlight-block">
      <div class="highlight-line">
        <div class="highlight-left">🏪 Top shop</div>
        <div class="highlight-right">
          ${escapeHTML(data.topShop.name||"-")} — ${formatCurrencyR(data.topShop.amount||0)}
        </div>
      </div>
      <div class="highlight-line">
        <div class="highlight-left">🧾 Top type</div>
        <div class="highlight-right">
          ${escapeHTML(data.topType.name||"-")} — ${formatCurrencyR(data.topType.amount||0)}
        </div>
      </div>
    </div>
  `;

  gridEl.innerHTML=html;
}

function renderMonthReportCard(){
  const picker=document.getElementById("monthPicker");
  let monthVal=picker.value;
  if(!monthVal){
    const d=new Date();
    const ym=d.getFullYear()+"-"+pad2(d.getMonth()+1);
    monthVal=ym;
    picker.value=ym;
  }
  const data=getMonthSummary(monthVal);
  const gridEl=document.getElementById("monthReportGrid");

  if(!data){
    gridEl.innerHTML="<div class='small' style='color:#444;'>No data</div>";
    return;
  }

  const startDMY=formatISOasDMY(data.startIso);
  const endDMY=formatISOasDMY(data.endIso);

  let html="";
  // Totals
  html+=`
    <div class="report-block-title">
      <div>Totals</div>
      <span>${startDMY} → ${endDMY}</span>
    </div>
    <div class="summary-total" style="margin-top:4px;">
      <div class="sum-left"></div>
      <div class="sum-right">${formatCurrencyR(data.totalAll)}</div>
    </div>
  `;

  // By type
  html+=`
    <div class="report-block-title">
      <div>By type</div>
      <span>this month</span>
    </div>
  `;
  Object.keys(data.byType).forEach(typeKey=>{
    const val=data.byType[typeKey];
    if(val>0){
      html+=`
        <div class="summary-row ${classForType(typeKey)}">
          <div class="sum-left">${escapeHTML(typeKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // By payer
  html+=`
    <div class="report-block-title">
      <div>By payer</div>
      <span>this month</span>
    </div>
  `;
  Object.keys(data.byPayer).forEach(payerKey=>{
    const val=data.byPayer[payerKey];
    if(val>0){
      html+=`
        <div class="summary-row ${classForPayer(payerKey)}">
          <div class="sum-left">${escapeHTML(payerKey)}</div>
          <div class="sum-right">${formatCurrencyR(val)}</div>
        </div>
      `;
    }
  });

  // Highlights
  html+=`
    <div class="report-block-title">
      <div>Highlights</div>
      <span>this month</span>
    </div>
    <div class="highlight-block">
      <div class="highlight-line">
        <div class="highlight-left">🏪 Top shop</div>
        <div class="highlight-right">
          ${escapeHTML(data.topShop.name||"-")} — ${formatCurrencyR(data.topShop.amount||0)}
        </div>
      </div>
      <div class="highlight-line">
        <div class="highlight-left">🧾 Top type</div>
        <div class="highlight-right">
          ${escapeHTML(data.topType.name||"-")} — ${formatCurrencyR(data.topType.amount||0)}
        </div>
      </div>
    </div>
  `;

  gridEl.innerHTML=html;
}

/* render groceries */
function renderGroceries(){
  const listEl=document.getElementById("groceryList");
  const list=loadGroceries();

  if(!list.length){
    listEl.innerHTML=`
      <div class='small' style='color:#444;'>
        Your grocery list is empty. Add something above.
      </div>`;
  } else {
    listEl.innerHTML=list.map(item=>{
      return `
        <div class="grocery-row">
          <label class="grocery-left">
            <input type="checkbox"
              ${item.done?"checked":""}
              onclick="toggleGroceryDone('${item.id}')"/>
            <span class="grocery-name ${item.done?"grocery-done":""}">
              ${escapeHTML(item.name)}
            </span>
          </label>
          <button class="grocery-del" onclick="deleteGroceryItem('${item.id}')">×</button>
        </div>
      `;
    }).join("");
  }

  updateTabBadges();
}

/* ===== 9. EXPORT FEATURE ===== */
function arrayToCSV(rows){
  return rows.map(r =>
    r.map(val => {
      const v=(val===undefined||val===null)?"":String(val);
      if(v.includes(",")||v.includes('"')||v.includes("\n")){
        return '"' + v.replace(/"/g,'""') + '"';
      }
      return v;
    }).join(",")
  ).join("\n");
}
function downloadCSV(filename, csvText){
  const blob=new Blob([csvText],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function exportSpendingCSV(){
  const data=loadSpends();
  const rows=[["id","item","shop","type","payer","amount","date","time"]];
  data.forEach(s=>{
    rows.push([s.id,s.item,s.shop,s.type,s.payer,s.amount,s.date,s.time]);
  });
  const csv=arrayToCSV(rows);
  const stamp=todayISO();
  downloadCSV(`taskpulse_spending_${stamp}.csv`,csv);
}
function exportGroceriesCSV(){
  const data=loadGroceries();
  const rows=[["id","name","done"]];
  data.forEach(g=>{
    rows.push([g.id,g.name,g.done?"yes":"no"]);
  });
  const csv=arrayToCSV(rows);
  const stamp=todayISO();
  downloadCSV(`taskpulse_groceries_${stamp}.csv`,csv);
}

/* ===== 10. TAB SWITCHING ===== */
function showSpendScreen(){
  document.getElementById("spendScreen").style.display="block";
  document.getElementById("groceryScreen").style.display="none";
  tabSpend.classList.add("tab-active");
  tabGro.classList.remove("tab-active");
  renderAll();
  updateTabBadges();
}
function showGroceryScreen(){
  document.getElementById("spendScreen").style.display="none";
  document.getElementById("groceryScreen").style.display="block";
  tabGro.classList.add("tab-active");
  tabSpend.classList.remove("tab-active");
  renderGroceries();
  updateTabBadges();
}

/* ===== 11. FULL RENDER ===== */
function renderAll(){
  renderHeader();
  renderDayCard();
  renderViewingCard();
  renderSummaryCard();
  renderWeekReportCard();
  renderMonthReportCard();
  renderGroceries(); // also keeps tab badges fresh
}

/* ===== 12. SPLASH CONTROL ===== */
function hideSplash(){
  const splash=document.getElementById("splashOverlay");
  splash.classList.add("hidden");
}

/* ===== 13. EVENT BINDINGS & INIT ===== */
function bindUI(){
  // Spend controls
  document.getElementById("addSpendBtn").onclick = addSpend;
  document.getElementById("clearDayBtn").onclick = clearDay;
  document.getElementById("prevDayBtn").onclick = goPrevDay;
  document.getElementById("nextDayBtn").onclick = goNextDay;

  // Reports pickers
  document.getElementById("weekPicker").onchange = renderWeekReportCard;
  document.getElementById("monthPicker").onchange = renderMonthReportCard;

  // Export buttons
  document.getElementById("exportSpendsBtn").onclick = exportSpendingCSV;
  document.getElementById("exportGroceriesBtn").onclick = exportGroceriesCSV;

  // Groceries controls
  document.getElementById("addGroceryBtn").onclick = addGrocery;

  // Tabs
  tabSpend.onclick = showSpendScreen;
  tabGro.onclick    = showGroceryScreen;
}

const tabSpend=document.getElementById("tabSpend");
const tabGro=document.getElementById("tabGroceries");

function init(){
  bindUI();
  renderAll();
  showSpendScreen(); // default tab Spend
  setTimeout(hideSplash, 1200);
}

init();
</script>

</body>
</html>
